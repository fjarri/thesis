% =============================================================================
\section{Functional Wigner representation}
% =============================================================================

First, we will define functional analogue of the displacement operator~\eqnref{formalism:sm-wigner:dispacement-op}:
\[
	\hat{D} ::
	(\mathbb{R}^D \rightarrow \mathbb{C})_L
	\rightarrow
	\mathbb{H}_L
\]
\[
	\hat{D}[\Lambda, \Lambda^*] = \exp \int d\xvec \left(
		\Lambda(\xvec) \Psiop^\dagger(\xvec) - \Lambda^*(\xvec) \Psiop(\xvec)
	\right),
\]
where $\Lambda(\xvec) = \sum\limits_{\nvec \in L} \phi_n(\xvec) \lambda_n$ is some function from restricted mode space $L$.
It is convenient to also define displacement functional as
\[
	D ::
	(\mathbb{R}^D \rightarrow \mathbb{C})_L
	\rightarrow
	(\mathbb{R}^D \rightarrow \mathbb{C})_L
	\rightarrow
	\mathbb{C}
\]
\[
	D[\Lambda, \Lambda^*, \Psi, \Psi^*] = \exp \int d\xvec \left(
		-\Lambda(\xvec) \Psi^*(\xvec) + \Lambda^*(\xvec) \Psi(\xvec)
	\right).
\]

It can be shown that the displacement operator has properties similar to~\eqnref{formalism:sm-wigner:displacement-derivatives}.

\begin{lemma}
\begin{equation*}
\begin{split}
	\frac{\delta}{\delta \Lambda^\prime} \hat{D}[\Lambda, \Lambda^*]
	& = \hat{D}[\Lambda, \Lambda^*] (\Psiop^{\prime\dagger} + \frac{1}{2} \Lambda^{\prime*})
	= (\Psiop^{\prime\dagger} - \frac{1}{2} \Lambda^{\prime*}) \hat{D}[\Lambda, \Lambda^*], \\
	-\frac{\delta}{\delta \Lambda^{\prime*}} \hat{D}[\Lambda, \Lambda^*]
	& = \hat{D}(\Lambda, \Lambda^*) (\Psiop^\prime + \frac{1}{2} \Lambda^\prime)
	= (\Psiop^\prime - \frac{1}{2} \Lambda^\prime) \hat{D}[\Lambda, \Lambda^*].
\end{split}
\end{equation*}
\end{lemma}
\begin{proof}
We will prove the second part of the first equation.
Using Baker-Hausdorff theorem:
\begin{equation*}
\begin{split}
	\hat{D}[\Lambda, \Lambda^*]
	& = \exp \int d\xvec \Lambda(\xvec) \Psiop(\xvec)^\dagger
		\exp \left( -\int d\xvec \Lambda^*(\xvec) \Psiop(\xvec) \right)
		\exp \frac{1}{2} \left[
			\int d\xvec^\prime \Lambda(\xvec^\prime) \Psiop(\xvec^\prime)^\dagger,
			\int d\xvec \Lambda^*(\xvec) \Psiop(\xvec)
		\right] \\
	& = \exp \int d\xvec \Lambda \Psiop^\dagger
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \int \int d\xvec d\xvec^\prime
			\Lambda^\prime \Lambda^* \delta_P(\xvec^\prime - \xvec)
		\right) \\
	& = \exp \int d\xvec \Lambda \Psiop^\dagger
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \int d\xvec \Lambda \Lambda^*
		\right).
\end{split}
\end{equation*}
Note that, since $\Lambda$ belongs to restricted mode space, it projects to itself.
Thus
\begin{equation*}
\begin{split}
	\frac{\delta}{\delta \Lambda^\prime} \hat{D}[\Lambda, \Lambda^*]
	= \left(
		\int dx \Psiop^\dagger(\xvec) \delta_P(\xvec^\prime - \xvec)
		- \frac{1}{2} \int dx \Lambda^*(\xvec) \delta_P(\xvec^\prime - \xvec)
	\right) \hat{D}[\Lambda, \Lambda^*]
	= (\Psiop^\dagger(\xvec^\prime) - \frac{1}{2} \Lambda^*(\xvec^\prime)) \hat{D}[\Lambda, \Lambda^*]
	\qedhere
\end{split}
\end{equation*}
\end{proof}

Functional Wigner transformation $\mathcal{W}$ is defined as
\todo{Is the return value real or complex?}
\[
	\mathcal{W} ::
	(\mathbb{R}^D \rightarrow \mathbb{H}_L)
	\rightarrow
	(\mathbb{R}^D \rightarrow \mathbb{C})_L
	\rightarrow
	\mathbb{C}
\]
\begin{equation}
\label{eqn:formalism:func-wigner:w-transformation}
	\mathcal{W}[\hat{A}]
	= \frac{1}{\pi^2} \int \delta^2 \Lambda
		D[\Lambda, \Lambda^*, \Psi, \Psi^*]
		\Trace{ \hat{A} \hat{D}[\Lambda, \Lambda^*] }.
\end{equation}
It transforms an operator $\hat{A}$ on a Hilbert space to a functional $(\mathcal{W}[\hat{A}])[\Psi, \Psi^*]$.
The backward transformation (called the Weyl transformation) gives back matrix elements of the operator:
\[
	\langle \Psi \lvert \mathcal{W}^{-1}[f[\Psi, \Psi^*]] \rvert \Psi \rangle
	= \todo{find\,the\,expression}.
\]

Thus Wigner functional is
\[
	W :: (\mathbb{R}^D \rightarrow \mathbb{C})_L \rightarrow \mathbb{C}
\]
\begin{equation}
\label{eqn:formalism:func-wigner:w-functional}
	W [\Psi, \Psi^*]
	\equiv \mathcal{W}[\hat{\rho}]
	= \frac{1}{\pi^2} \int \delta^2 \Lambda
		D[\Lambda, \Lambda^*, \Psi, \Psi^*]
		\chi_W [\Lambda, \Lambda^*],
\end{equation}
where $\chi_W (\Lambda, \Lambda^*)$ is the characteristic functional
\[
	\chi_W :: (\mathbb{R}^D \rightarrow \mathbb{C})_L \rightarrow \mathbb{R}
\]
\[
	\chi_W [\Lambda, \Lambda^*]
	= \Trace{ \hat{\rho} \hat{D}[\Lambda, \Lambda^*] }.
\]

\begin{lemma}[Functional extension of \lmmref{formalism:sm-wigner:zero-integrals}]
\label{lmm:formalism:func-wigner:zero-integrals}
If $\Lambda = \sum\limits_{\nvec \in L} \phi_{\nvec} \lambda_n$ and $\Psi = \sum\limits_{\nvec \in L} \phi_{\nvec} \alpha_n$:
\begin{equation*}
\begin{split}
	\int \delta^2\Lambda
		\frac{\delta}{\delta \Lambda^\prime} \left(
			D[\Lambda, \Lambda^*, \Psi, \Psi^*]
			\left( \frac{\delta}{\delta \Lambda^\prime} \right)^r
			\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^s
			\hat{D}[\Lambda, \Lambda^*]
		\right)
	& = 0 \\
	\int \delta^2\Lambda
		\frac{\delta}{\delta \Lambda^{\prime*}}
		\left(
			D[\Lambda, \Lambda^*, \Psi, \Psi^*]
			\left( \frac{\delta}{\delta \Lambda^\prime} \right)^r
			\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^s
			\hat{D}[\Lambda, \Lambda^*]
		\right)
	& = 0.
\end{split}
\end{equation*}
\end{lemma}
\begin{proof}
We will prove the first equation.
Functional displacement operator can be represented as a function of mode vector:
\begin{equation*}
\begin{split}
	\hat{D}[\Lambda, \Lambda^*]
	= \exp \int dx \sum\limits_{\nvec,\mvec} \left(
		\phi_{\nvec} \phi_{\mvec}^* \lambda_{\nvec} \hat{a}_{\mvec}^\dagger
		- \phi_{\nvec}^* \phi_{\mvec} \lambda_{\nvec}^* \hat{a}_{\mvec}
	\right)
	= \exp \sum\limits_{\nvec,\mvec} \left(
		\delta_{\nvec,\mvec} \lambda_{\nvec} \hat{a}_{\nvec}^\dagger
		- \delta_{\nvec,\mvec} \lambda_{\nvec}^* \hat{a}_{\nvec}
	\right)
	= \exp \sum\limits_{\nvec} \left(
		\lambda_{\nvec} \hat{a}_{\nvec}^\dagger - \lambda_{\nvec}^* \hat{a}_{\nvec}
	\right).
\end{split}
\end{equation*}
Expanding $\lambda_{\nvec} = x_{\nvec} + iy_{\nvec}$ and applying Baker-Hausdorff theorem:
\begin{equation*}
\begin{split}
	\hat{D}[\Lambda, \Lambda^*]
	& = \prod\limits_{\nvec \in L}
		\exp(x_{\nvec}(\hat{a}_{\nvec}^\dagger - \hat{a}_{\nvec})
		+ iy_{\nvec}(\hat{a}_{\nvec}^\dagger + \hat{a}_{\nvec})) \\
	& = \prod\limits_{\nvec \in L}
		\exp(ix_{\nvec}y_{\nvec})
		\exp(x_{\nvec}(\hat{a}_{\nvec}^\dagger - \hat{a}_{\nvec}))
		\exp(iy_{\nvec}(\hat{a}_{\nvec}^\dagger + \hat{a}_{\nvec}))
\end{split}
\end{equation*}
Similarly,
\[
	\exp \int d\xvec (-\Lambda \Psi^* + \Lambda^* \Psi)
	= \prod\limits_{\nvec \in L} \exp
		(-\lambda_{\nvec} \alpha_{\nvec}^* + \lambda_{\nvec}^* \alpha_{\nvec})
\]
For brevity, we will use index in multimode functions and operators to specify the subset of $L$ they use.
With this notation, for fixed $\nvec$:
\[
	\hat{D}[\Lambda, \Lambda^*]
	= \prod\limits_{\mvec \in L} \exp \left(
		\lambda_{\mvec} \hat{a}_{\mvec}^\dagger - \lambda_{\mvec}^* \hat{a}_{\mvec}
	\right)
	= \exp \left(
		\lambda_{\nvec} \hat{a}_{\nvec}^\dagger - \lambda_{\nvec}^* \hat{a}_{\nvec}
	\right)
	\prod\limits_{\mvec \in L, \mvec \ne \nvec} \exp \left(
		\lambda_{\mvec} \hat{a}_{\mvec}^\dagger - \lambda_{\mvec}^* \hat{a}_{\mvec}
	\right)
	= \hat{D}_{\lnot \nvec} \hat{D}_{\nvec},
\]
and, similarly,
\begin{equation*}
\begin{split}
	\Lambda & = \Lambda_{\lnot \nvec} + \Lambda_{\nvec} \\
	D[\Lambda, \Lambda^*, \Psi, \Psi^*]	& = D_{\lnot \nvec} D_{\nvec}, \\
	\frac{\partial}{\partial \Lambda^\prime}
	& = \left( \frac{\delta}{\delta \Lambda^\prime} \right)_{\lnot \nvec}
	+ \left( \frac{\delta}{\delta \Lambda^\prime} \right)_{\nvec}
	= \frac{\partial}{\partial \Lambda_{\lnot \nvec}^\prime}
	+ \frac{\partial}{\partial \Lambda_{\nvec}^\prime}.
\end{split}
\end{equation*}

Thus
\begin{equation*}
\begin{split}
	& \int \delta^2\Lambda
		\frac{\delta}{\delta \Lambda^\prime} \left(
			\exp \int d\xvec (-\Lambda \Psi^* + \Lambda^* \Psi)
			\left( \frac{\delta}{\delta \Lambda^\prime} \right)^r
			\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^s
			\hat{D}[\Lambda, \Lambda^*]
		\right) \\
	& = \int \ldots \int d^2\lambda_1 \ldots d^2\lambda_N
		\sum\limits_{\nvec \in L}
		\phi_{\nvec}^\prime
		\frac{\partial}{\partial \lambda_{\nvec}} \left(
			D_{\lnot \nvec} D_{\nvec}
		\right.	\\
		& \left.
			\left(
				\frac{\partial}{\partial \Lambda_{\lnot \nvec}^\prime}
				+ \frac{\partial}{\partial \Lambda_{\nvec}^\prime}.
			\right)^r
			\left(
				-\frac{\partial}{\partial \Lambda_{\lnot \nvec}^{\prime*}}
				-\frac{\partial}{\partial \Lambda_{\nvec}^{\prime*}}.
			\right)^s
			\hat{D}_{\lnot \nvec} \hat{D}_{\nvec}
		\right) \\
	& = \sum\limits_{\nvec \in L} \int \ldots \int d^2\lambda_1 \ldots d^2\lambda_N
		\phi_{\nvec}^\prime D_{\lnot \nvec}
		\frac{\partial}{\partial \lambda_{\nvec}} \left(
			D_{\nvec}
		\right.	\\
	& \left.
		\sum\limits_{u=1}^r \sum\limits_{v=1}^s \binom{r}{u} \binom{s}{v}
			\left(
				\left( \frac{\partial}{\partial \Lambda_{\nvec}^\prime} \right)^u
				\left( -\frac{\partial}{\partial \Lambda_{\nvec}^{\prime*}} \right)^v
				\hat{D}_{\nvec}
			\right)
			\left(
				\left( \frac{\partial}{\partial \Lambda_{\lnot \nvec}^\prime} \right)^{r-u}
				\left( -\frac{\partial}{\partial \Lambda_{\lnot \nvec}^{\prime*}} \right)^{s-v}
				\hat{D}_{\lnot \nvec}
			\right)
		\right) \\
	& = \sum\limits_{u=1}^r \sum\limits_{v=1}^s \binom{r}{u} \binom{s}{v}
		\sum\limits_{\nvec \in L}
		\int \ldots \int d^2\lambda_1 \ldots (\ne \nvec) \ldots d^2\lambda_N
		\phi_{\nvec}^\prime D_{\lnot \nvec}
		\left(
			\left( \frac{\partial}{\partial \Lambda_{\lnot \nvec}^\prime} \right)^{r-u}
			\left( -\frac{\partial}{\partial \Lambda_{\lnot \nvec}^{\prime*}} \right)^{s-v}
			\hat{D}_{\lnot \nvec}
		\right) \\
	&	\int d^2\lambda_{\nvec} \frac{\partial}{\partial \lambda_{\nvec}} \left(
			D_{\nvec}
			\left( \frac{\partial}{\partial \Lambda_{\nvec}^\prime} \right)^u
			\left( -\frac{\partial}{\partial \Lambda_{\nvec}^{\prime*}} \right)^v
			\hat{D}_{\nvec}
		\right).
\end{split}
\end{equation*}
And the integral over $\lambda_{\nvec}$ is exactly the expression from \lmmref{formalism:c-numbers:zero-integrals},
which is equal to zero,
thus proving the lemma.
\end{proof}

\begin{lemma}[Functional extension of \lmmref{formalism:sm-wigner:moments-from-chi}]
\label{lmm:formalism:func-wigner:moments-from-chi}
\[
	\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle
	= \left.
		\left( \frac{\delta}{\delta \Lambda^\prime} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^r
		\chi_W (\Lambda, \Lambda^*)
	\right|_{\Lambda \equiv 0}.
\]
\end{lemma}
\begin{proof}
The proof follows the same general scheme as in single-mode case.
The exponent in the $\chi_W$ can be expanded as
\[
	\exp (\Lambda \Psiop^\dagger - \Lambda^* \Psiop)
	= \sum\limits_{r,s}
		\frac{
			\symprod{
				\left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
				\left( -\int d\xvec \Lambda^* \Psiop \right)^s
			}
		}
		{r!s!}.
\]
We can swap functional derivative with both integration and multiplication by independent function, so:
\[
	\frac{\delta}{\delta \Lambda^\prime} \left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
	= r \int d\xvec \frac{\delta \Lambda}{\delta \Lambda^\prime} \Psiop^\dagger
		\left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1}
	= r \int d\xvec \delta_P(\xvec^\prime - \xvec) \Psiop^\dagger
		\left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1}
	= r \Psiop^{\prime\dagger} \left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1},
\]
and multiple application of the differential gives us
\[
	\left( \frac{\delta}{\delta \Lambda^\prime} \right)^r
	\left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
	= r! ( \Psiop^{\prime\dagger} )^r.
\]
Similarly for the other differential:
\[
	\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^s
	\left( -\int d\xvec \Lambda \Psiop^\dagger \right)^s
	= s! ( \Psiop^{\prime\dagger} )^s.
\]

Thus, same as in single-mode case,
differentiation will eliminate all lower order terms in the expansion,
and all higher order terms will be eliminated by setting $\Lambda \equiv 0$,
leaving only one operator product with required order:
\[
	\left.
		\left( \frac{\delta}{\delta \Lambda^\prime} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^r
		\chi_W (\Lambda, \Lambda^*)
	\right|_{\Lambda \equiv 0}
	= r! s! \frac{1}{r! s!}
		\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle
	= \langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle.
	\qedhere
\]
\end{proof}
