% =============================================================================
\section{Functional Wigner representation}
% =============================================================================

First, we will define functional analogue of the displacement operator~\eqnref{formalism:sm-wigner:dispacement-op}:
\[
	\hat{D}[\Lambda, \Lambda^*] = \exp \int d\xvec \left(
		\Lambda(\xvec) \Psiop^\dagger(\xvec) - \Lambda^*(\xvec) \Psiop(\xvec)
	\right),
\]
where $\Lambda(\xvec) = \sum\limits_{\nvec \in L} \phi_n(\xvec) \lambda_n$ is some function from restricted mode space $L$.
It can be shown that the displacement operator has properties similar to~\eqnref{formalism:sm-wigner:displacement-derivatives}.

\begin{lemma}
\begin{equation*}
\begin{split}
	\frac{\delta}{\delta \Lambda^\prime} \hat{D}[\Lambda, \Lambda^*]
	& = \hat{D}[\Lambda, \Lambda^*] (\Psiop^{\prime\dagger} + \frac{1}{2} \Lambda^{\prime*})
	= (\Psiop^{\prime\dagger} - \frac{1}{2} \Lambda^{\prime*}) \hat{D}[\Lambda, \Lambda^*], \\
	-\frac{\delta}{\delta \Lambda^{\prime*}} \hat{D}[\Lambda, \Lambda^*]
	& = \hat{D}(\Lambda, \Lambda^*) (\Psiop^\prime + \frac{1}{2} \Lambda^\prime)
	= (\Psiop^\prime - \frac{1}{2} \Lambda^\prime) \hat{D}[\Lambda, \Lambda^*].
\end{split}
\end{equation*}
\end{lemma}
\begin{proof}
We will prove the second part of the first equation.
Using Baker-Hausdorff theorem:
\begin{equation*}
\begin{split}
	\hat{D}[\Lambda, \Lambda^*]
	& = \exp \int d\xvec \Lambda(\xvec) \Psiop(\xvec)^\dagger
		\exp \left( -\int d\xvec \Lambda^*(\xvec) \Psiop(\xvec) \right)
		\exp \frac{1}{2} \left[
			\int d\xvec^\prime \Lambda(\xvec^\prime) \Psiop(\xvec^\prime)^\dagger,
			\int d\xvec \Lambda^*(\xvec) \Psiop(\xvec)
		\right] \\
	& = \exp \int d\xvec \Lambda \Psiop^\dagger
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \int \int d\xvec d\xvec^\prime
			\Lambda^\prime \Lambda^* \delta_P(\xvec^\prime - \xvec)
		\right) \\
	& = \exp \int d\xvec \Lambda \Psiop^\dagger
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \int d\xvec \Lambda \Lambda^*
		\right).
\end{split}
\end{equation*}
Note that, since $\Lambda$ belongs to restricted mode space, it projects to itself.
Thus
\begin{equation*}
\begin{split}
	\frac{\delta}{\delta \Lambda^\prime} \hat{D}[\Lambda, \Lambda^*]
	= \left(
		\int dx \Psiop^\dagger(\xvec) \delta_P(\xvec^\prime - \xvec)
		- \frac{1}{2} \int dx \Lambda^*(\xvec) \delta_P(\xvec^\prime - \xvec)
	\right) \hat{D}[\Lambda, \Lambda^*]
	= (\Psiop^\dagger(\xvec^\prime) - \frac{1}{2} \Lambda^*(\xvec^\prime)) \hat{D}[\Lambda, \Lambda^*]
	\qedhere
\end{split}
\end{equation*}
\end{proof}

\begin{lemma}[Functional extension of \lmmref{formalism:sm-wigner:moments-from-chi}]
\label{lmm:formalism:func-wigner:moments-from-chi}
\[
	\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle
	= \left.
		\left( \frac{\delta}{\delta \Lambda^\prime} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^r
		\chi_W (\Lambda, \Lambda^*)
	\right|_{\Lambda \equiv 0}.
\]
\end{lemma}
\begin{proof}
The proof follows the same general scheme as in single-mode case.
The exponent in the $\chi_W$ can be expanded as
\[
	\exp (\Lambda \Psiop^\dagger - \Lambda^* \Psiop)
	= \sum\limits_{r,s}
		\frac{
			\symprod{
				\left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
				\left( -\int d\xvec \Lambda^* \Psiop \right)^s
			}
		}
		{r!s!}.
\]
We can swap functional derivative with both integration and multiplication by independent function, so:
\[
	\frac{\delta}{\delta \Lambda^\prime} \left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
	= r \int d\xvec \frac{\delta \Lambda}{\delta \Lambda^\prime} \Psiop^\dagger
		\left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1}
	= r \int d\xvec \delta_P(\xvec^\prime - \xvec) \Psiop^\dagger
		\left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1}
	= r \Psiop^{\prime\dagger} \left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1},
\]
and multiple application of the differential gives us
\[
	\left( \frac{\delta}{\delta \Lambda^\prime} \right)^r
	\left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
	= r! ( \Psiop^{\prime\dagger} )^r.
\]
Similarly for the other differential:
\[
	\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^s
	\left( -\int d\xvec \Lambda \Psiop^\dagger \right)^s
	= s! ( \Psiop^{\prime\dagger} )^s.
\]

Thus, same as in single-mode case,
differentiation will eliminate all lower order terms in the expansion,
and all higher order terms will be eliminated by setting $\Lambda \equiv 0$,
leaving only one operator product with required order:
\[
	\left.
		\left( \frac{\delta}{\delta \Lambda^\prime} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^r
		\chi_W (\Lambda, \Lambda^*)
	\right|_{\Lambda \equiv 0}
	= r! s! \frac{1}{r! s!}
		\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle
	= \langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle.
	\qedhere
\]
\end{proof}
