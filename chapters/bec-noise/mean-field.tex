% =============================================================================
\section{Mean-field approximation}
% =============================================================================

We will start from the classical model of the trapped \abbrev{bec} --- the mean-field approximation.
While it cannot predict quantum effects, it provides the basis for comparison with the truncated Wigner method, and can be also applied to calculate the ground state of a trapped \abbrev{bec} numerically.


% =============================================================================
\subsection{Two-component condensate}
% =============================================================================

Hereafter we are discussing $^{87}$Rb condensate and two of its $5^2S_{1/2}$ states: $\vert1,-1\rangle$ and $\vert2,1\rangle$,
called $\vert1\rangle$ and $\vert2\rangle$, correspondingly.
The energy of the mixture of two states is~\cite{Pitaevskii2003}:
\begin{eqn}
\label{eqn:mean-field:two-comp-energy}
	E(\Psi) = & \int\limits_V \left(
		- \frac{\hbar^2 \Psi_1^* \nabla^2 \Psi_1}{2m}
		- \frac{\hbar^2 \Psi_2^* \nabla^2 \Psi_2}{22m}
	\right. \\
	& \left.
		+ (V_1 + \hbar \omega_1) n_1 + (V_2 + \hbar \omega_2) n_2
		+ \frac{g_{11}}{2} n_1^2 + \frac{g_{22}}{2} n_2^2 + g_{12} n_1 n_2
	\right) d\xvec.
\end{eqn}
External trap potential $V_1$ and $V_2$ can be different for each component, depending on experimental setup.
Interaction coefficients $g_{11}$, $g_{12}$ and $g_{22}$ depend on corresponding scattering lengths:
\[
	g_{ij} = \frac{4 \pi \hbar^2 a_{ij}}{m}.
\]
The quantity $\omega_{hf}$ is the hyperfine splitting for $5^2S_{1/2}$ and equals
$\omega_{hf} \approx 2 \pi \times 6.8 \textrm{GHz}$~\cite{Steck2009}.

One can obtain coupled GPEs from~\eqnref{mean-field:two-comp-energy} using the variational principle $i \hbar \partial \Psi_i / \partial t = \delta E / \delta \Psi_i^*$:
\begin{align}
\label{eqn:mean-field:two-comp-cgpes}
\begin{split}
	i \hbar \frac{\partial \Psi_1}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V_1 + \hbar \omega_1
		+ g_{11} \lvert \Psi_1 \rvert^2 + g_{12} \lvert \Psi_2 \rvert^2
	\right) \Psi_1 \\
	i \hbar \frac{\partial \Psi_2}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V_2 + \hbar \omega_2
		+ g_{22} \lvert \Psi_2 \rvert^2 + g_{12} \lvert \Psi_1 \rvert^2
	\right) \Psi_2
\end{split}
\end{align}

\begin{figure}
\begin{center}
\includegraphics[width=0.5\textwidth]{figures_generated/mean_field/two_comp_gs.eps}
\caption{Two-component ground state for immiscible regime.}
\label{fig:mean-field:two-comp-gs}
\end{center}
\end{figure}

Ground state for two-component condensate can be found by propagating these equations in imaginary time simultaneously,
waiting for total energy~\eqnref{mean-field:two-comp-energy} to stop changing.
\figref{mean-field:two-comp-gs} shows the axial projection of two-component ground state for a mixture of 40,000 $\vert 1 \rangle$ and 40.000 $\vert 2 \rangle$ atoms;
scattering lengths were taken to be equal to $a_{11} = 100.40\ a_0$, $a_{22} = 95.68\ a_0$ and $a_{12} = 98.13\ a_0$, where $a_0$ is the Bohr radius.


% =============================================================================
\subsection{Two-component evolution}
% =============================================================================

Full evolution equations can be constructed from the basic form~\eqnref{mean-field:two-comp-energy},
with the inclusion of electromagnetic coupling terms~\cite{Pitaevskii2003}
and loss terms~\cite{Mertes2007}:
\begin{align}
\label{eqn:mean-field:two-comp-evolution-cgpes}
\begin{split}
	i \hbar \frac{\partial \Psi_1}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V_1 + \hbar \omega_1
		+ g_{11} \lvert \Psi_1 \rvert^2
		+ g_{12} \lvert \Psi_2 \rvert^2
		- i \hbar \Gamma_1
	\right) \Psi_1 \\
	& + \frac{\hbar \Omega}{2} \left(
		e^{i (\omega t + \alpha)} + e^{-i (\omega t + \alpha)}
	\right) \Psi_2, \\
	i \hbar \frac{\partial \Psi_2}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V_2 + \hbar \omega_2
		+ g_{22} \lvert \Psi_2 \rvert^2
		+ g_{12} \lvert \Psi_1 \rvert^2
		- i \hbar \Gamma_2
	\right) \Psi_2 \\
	& + \frac{\hbar \Omega}{2} \left(
		e^{i (\omega t + \alpha)} + e^{-i (\omega t + \alpha)}
	\right) \Psi_1,
\end{split}
\end{align}
where $\Gamma_1 = \left( \gamma_{111} n_1^2 + \gamma_{12} n_2 \right) / 2$,
and $\Gamma_2 = \left( \gamma_{12} n_1 + \gamma_{22} n_2 \right) / 2$.
Loss rates $\gamma$ can be found in~\cite{Mertes2007} and~\cite{Burt1997}:
\[
	\gamma_{111} = 5.4(11) \times 10^{-30}\ \textrm{cm}^6/\textrm{s},\,
	\gamma_{12} = 0.780(19) \times 10^{-13}\ \textrm{cm}^3/\textrm{s},\,
	\gamma_{22} = 1.194(19) \times 10^{-13}\ \textrm{cm}^3/\textrm{s}.
\]
The difference between internal energies of spins $1$ and $2$ is the hyperfine frequency $\omega_{hf} = \omega_1 - \omega_2$.
Coupling frequency $\omega$ is slightly detuned from the hyperfine frequency in the experiment:
$\omega = \omega_{hf} + \delta,\, \delta \ll \omega_{hf}$.
Coupling coefficient $\Omega$ is the Rabi frequency (its exact value depends on the nature of coupling process),
and $\alpha$ is the phase of the coupling field.

The fact that $\hbar \omega_{1,2} \gg V_2$ can cause problems when performing calculations with low precision.
Therefore it is convenient to use equations~\eqnref{mean-field:two-comp-evolution-cgpes}
in a rotating frame:
$\Psi_1 \rightarrow \Psi_1 e^{i \omega_1 t}$, $\Psi_2 \rightarrow \Psi_2 e^{i \omega_2 t}$.
This transformation eliminates $\omega_1$ and $\omega_2$ from the equations and does not change single-time observable values;
but one must remember that it does change relative phase of the components, which may be significant in some cases.
Transformed equations look like:
\begin{align*}
\begin{split}
	i \hbar \frac{\partial \Psi_1}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V_1
		+ g_{11} \lvert \Psi_1 \rvert^2
		+ g_{12} \lvert \Psi_2 \rvert^2
		- i \hbar \Gamma_1
	\right) \Psi_1 \\
	& + \frac{\hbar \Omega}{2} \left(
		e^{i ((\omega + \omega_{hf}) t + \alpha)} + e^{-i (\delta t + \alpha)}
	\right) \Psi_2 \\
	i \hbar \frac{\partial \Psi_2}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V_2
		+ g_{22} \lvert \Psi_2 \rvert^2
		+ g_{12} \lvert \Psi_1 \rvert^2
		- i \hbar \Gamma_2
	\right) \Psi_2 \\
	& + \frac{\hbar \Omega}{2} \left(
		e^{i (\delta t + \alpha)} + e^{-i ((\omega + \omega_{hf}) t + \alpha)}
	\right) \Psi_1
\end{split}
\end{align*}

In the experiment coupling field is applied for short periods of time $t_{pulse}$,
where $1 / \omega \ll t_{pulse} \ll 1 / \delta$.
This allows us to neglect fast oscillating terms:
\begin{align}
\label{eqn:mean-field:cgpes_simplified}
\begin{split}
	i \hbar \frac{\partial \Psi_1}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V
		+ g_{11} \lvert \Psi_1 \rvert^2
		+ g_{12} \lvert \Psi_2 \rvert^2
		- i \hbar \Gamma_1
	\right) \Psi_1
	+ \frac{\hbar \Omega}{2} e^{-i (\delta t + \alpha)} \Psi_2, \\
	i \hbar \frac{\partial \Psi_2}{\partial t} & = \left(
		-\frac{\hbar^2 \nabla^2}{2 m} + V
		+ g_{22} \lvert \Psi_2 \rvert^2
		+ g_{12} \lvert \Psi_1 \rvert^2
		- i \hbar \Gamma_2
	\right) \Psi_2 +
	\frac{\hbar \Omega}{2} e^{i (\delta t + \alpha)} \Psi_1,
\end{split}
\end{align}
where $\alpha$ is the starting phase of the coupling field.
When pulse is applied twice using the same coupling field (which is the case for Ramsey interferometry),
it is the same as just setting $\Omega$ to zero after the first pulse and then restoring its value for the time of the second pulse;
therefore $\alpha$ stays the same too.
If one wants to apply pulse with the different detuning, phase information is lost,
and the value of $\alpha$ has to become random before this pulse.

Application of the coupling field can be simplified, if certain additional conditions are valid, namely:
\begin{enumerate}
	\item $\mu / \hbar \ll \Omega$, where $\mu$ is the chemical potential of the first component;
	\item $\delta \ll \Omega$;
	\item mean field interaction can be neglected \textcolor{red}{[mathematical condition needed]}.
\end{enumerate}
This allows us to use ``instantaneous'' pulse, multiplying state vector by rotation matrix:
\begin{equation}
\label{eqn:mean-field:rotation-matrix}
	\begin{pmatrix}
		\Psi^\prime_1 \\ \Psi^\prime_2
	\end{pmatrix} =
	\begin{pmatrix}
		\cos \frac{\theta}{2} & -i e^{-i \phi} \sin \frac{\theta}{2} \\
		-i e^{i \phi} \sin \frac{\theta}{2} & \cos \frac{\theta}{2}
	\end{pmatrix}
	\begin{pmatrix}
		\Psi_1 \\ \Psi_2
	\end{pmatrix},
\end{equation}
where $\theta = \Omega t_{pulse}$, and $\phi$ is the phase of the coupling field at the beginning of the pulse.
In particular, for two-pulse Ramsey scheme, $\phi_2 = \phi_1 + \delta (t_{R} + t_{pulse}) \approx \phi_1 + \delta t_{R}$.

Coupled equations~\eqnref{mean-field:cgpes_simplified} require slightly improved split-step method,
because nonlinear matrix $\hat{N}$ is no longer diagonal.
See \todo{reference split-step section} for details.

But if one uses ``instantaneous'' pulses, evolution without coupling terms can be simulated with the simple split-step method.
Differential and nonlinear operators will look as following then:
\[
	\hat{D} = \frac{i \hbar}{2m} \nabla^2,
\]
\[
	\hat{N}_1 = -\frac{i}{\hbar} \left( V + g_{11} n_1 + g_{12} n_2 \right) - \Gamma_1,
\]
\[
	\hat{N}_2 = -\frac{i}{\hbar} \left( V + g_{12} n_1 + g_{22} n_2 \right) - \Gamma_2.
\]

Gross-Pitaevskii equations give a good approximation of BEC behaviour.


% =============================================================================
\subsection{Thomas-Fermi approximation}
% =============================================================================

We are looking for the ground state of the system with pseudopotential model hamiltonian~\cite{Pitaevskii2003}:
\[
	\hat{H} =
		- \frac{\hbar^2}{2m} \frac{\partial^2}{\partial \xvec^2}
		+ V(\xvec)
		+ g_{11} \lvert \Psi(\xvec) \rvert^2,
\]
\[
	g_{11} = \frac{4 \pi \hbar^2 a_{11}}{m},
\]
\begin{equation}
\label{eqn:mean-field:trap-potential}
	V(\xvec) = \frac{m}{2} \left(
		\omega_x^2 x^2 + \omega_y^2 y^2 + \omega_z^2 z^2
	\right).
\end{equation}
where $V(\xvec)$ is the potential energy of parabolic trap, $g_{11}$ is the interaction coefficient,
and $a_{11}$ is the scattering length for atoms in non-excited state.

The ground state satisfies the Gross-Pitaevskii equation~\cite{Pitaevskii2003}:
\begin{equation}
\label{eqn:mean-field:gs-shroedinger}
	\hat{H} \Psi = \mu \Psi,
\end{equation}
where $\mu$ is the chemical potential of the state.
To get the first approximation of the state function,
we consider the kinetic term to be small as compared to other terms and omit it.
The conditions for this operation to be valid will be determined later in this section.
Thus we get the simple equation:
\[
	\left( V(\xvec) + g_{11} \lvert \Psi(\xvec) \rvert^2 \right) \Psi(\xvec) = \mu \Psi(\xvec),
\]
which leads us to the state function:
\begin{equation}
\label{eqn:mean-field:tf-gs}
	\lvert \Psi(\xvec) \rvert^2 = \frac{1}{g_{11}} \max \left( \mu - V(\xvec), 0 \right).
\end{equation}
The condition for $V(\xvec)$ defines the shape of the condensate---it is the ellipsoid with the following radii:
\begin{equation}
\label{eqn:mean-field:tf-radii}
	r_x = \sqrt{\frac{2\mu}{m \omega_x^2}},\,
	r_y = \sqrt{\frac{2\mu}{m \omega_y^2}},\,
	r_z = \sqrt{\frac{2\mu}{m \omega_z^2}}.
\end{equation}

Normalisation condition for the ground state function gives us the connection
between the number of atoms in the condensate and the chemical potential:
\[
	\mu =
		\left( \frac{15 N}{8 \pi} \right)^\frac{2}{5}
		\left( \frac{m \bar{\omega}^2}{2} \right)^\frac{3}{5}
		{g_{11}}^\frac{2}{5},
\]
where $\bar{\omega} = \sqrt[3]{\omega_x \omega_y \omega_z}$.

Now we can roughly estimate the conditions necessary to drop the kinetic term from equation.
Substituting approximate solution~\eqnref{mean-field:tf-gs} to~\eqnref{mean-field:gs-shroedinger}
and comparing kinetic and potential term, we can get the following inequation:
\begin{equation}
\label{eqn:mean-field:tf-inequation}
	\frac{\hbar^2}{2m} \left(
		\frac{m \left( \omega_x^2 + \omega_y^2 + \omega_z^2 \right)}{2}
		+ \frac{m^2 \left( \omega_x^4 x^2 + \omega_y^4 y^2 + \omega_z^4 z^2 \right)}
			{4 \left( \mu - V(\xvec) \right)}
	\right) \ll
	\mu \left(\mu - V(\xvec)\right).
\end{equation}
Near the centre of the condensate this inequation simplifies to
\begin{equation}
\label{eqn:mean-field:tf-condition}
	\mu \gg \frac{\hbar}{2} \sqrt{\omega_x^2 + \omega_y^2 + \omega_z^2}.
\end{equation}

On the other hand, near the edges of the cloud the left-hand side of the inequation~\eqnref{mean-field:tf-inequation} diverges,
while the right-hand side equals zero there.
This means that near the edges Thomas-Fermi approximation fails regardless of the conditions.
Fortunately, the density of the particles there is low, so we can estimate the width $h$ of the "belt"
where our first approximation of the state function is significantly incorrect.
If it happens to be small as compared to the size of the condensate, the approximation can be considered valid.

The first term at the left-hand side of the inequation~\eqnref{mean-field:tf-inequation}
is constant and can be dropped in the limit of $V(\xvec) \rightarrow \mu$.
Then, for the sake of simplicity, we consider two of three coordinates to be zero and the third one to equal to $r - h$,
where $r$ is the corresponding radius of the condensate.
After replacing ``$\ll$'' by ``$\approx$'' and assuming $h$ to be small as compared to $r$,
we obtain the conditions for each coordinate:
\[
	h_x \approx \sqrt{\frac{\hbar^2}{2 \mu m}},\,\ldots
\]
They have to be much smaller than corresponding radii, which gives us:
\[
	\mu \gg \frac{1}{2} \hbar \omega_x,\ldots
\]
These conditions are less strict than the condition for the center of the condensate.
Therefore, we have only one condition justifying the application of Thomas-Fermi approximation is~\eqnref{mean-field:tf-condition}.

\begin{figure}
\begin{center}
\subfloat[100,000 atoms]{\includegraphics[width=0.5\textwidth]{%
	figures_generated/mean_field/ground_states_100k.eps}}
\subfloat[1,000 atoms]{\includegraphics[width=0.5\textwidth]{%
	figures_generated/mean_field/ground_states_1k.eps}}
\end{center}
\caption{Numerically calculated and Thomas-Fermi approximated ground states}
\label{fig:mean-field:tf-vs-accurate}
\end{figure}

Let us use some real-life experimental parameters and check how well Thomas-Fermi approximation works.
For three-dimensional trap with frequencies $f_x = f_y = 97.6 \textrm{ Hz}$ and $f_x = 11.96 \textrm{ Hz}$
and $10^5$ rubidium atoms (which have scattering length $a_{11} = 100.4 a_0$, where $a_0$ is the Bohr radius),
we have $\mu \approx 7.67 \hbar \omega_x$.
This means that Thomas-Fermi approximation produces solution which is close to the real one.
But for lower amount of atoms, say $10^3$, we get $\mu \approx 1.28 \hbar \omega_x$,
which is a sign that the we are reaching the limit of the approximation's applicability.
\figref{mean-field:tf-vs-accurate} shows the density along the z axis for both cases:
for $10^5$ atoms Thomas-Fermi approximation is very close to accurately calculated ground state (see the following section for details),
and for $10^3$ atoms it differs significantly, as expected.


% =============================================================================
\subsection{Ground state calculation}
% =============================================================================

The ground state obtained using Thomas-Fermi approximation is good for estimation purposes,
but not for real-life calculations---for example, it does not have continuous first derivative everywhere
(namely, near the edges of the condensate).
That is why we have to employ numerical calculations in order to find precise (to a certain extent) solution
of the Gross-Pitaevskii equation~\eqnref{mean-field:gs-shroedinger}.
One of the possible ways, the propagation in imaginary time, will be described in this section.

The idea of the method is that propagating the system state using the time-dependent GPE,
but with the substitution $t \rightarrow \tau = it$, diminishes energy of the system;
therefore after the sufficient amount of time this propagation will lead us to ground state.
The rigorous proof of this method can be found in \cite{Bao2004}, but there is a simple "hand-waving" explanation.
It assumes the superposition principle works for GPE, though it does not because of the nonlinearity.

Let us say we have the system with Hamiltonian $\hat{H}$, whose eigenvalues are $\mu_1 < \mu_2 < ...$.
They do not have to correspond to real states of BEC, we just know that this Hamiltonian must have discrete spectre
(because of the form of the potential) and the lowest eigenvalue corresponds to ground state we want to find.
The steady solution of time-dependent GPE
\[
	i \hbar \frac{\partial \Psi}{\partial t} = \hat{H} \Psi
\]
then looks like
\[
	\Psi(\xvec, t) = \sum_k e^{-\frac{i}{\hbar}\mu_k t} f_k(\xvec),
\]
where $f_k$ are eigenfunctions of $\hat{H}$, corresponding to eigenvalues $\mu_k$.
Now consider the substitution $t \rightarrow \tau = it$; after it the steady solution will become fading,
with higher-energy components fading faster:
\[
	\Psi(\xvec, \tau) = \sum_k e^{-\frac{1}{\hbar}\mu_k \tau} f_k(\xvec).
\]

Therefore, if we take some random initial solution and propagate it for a sufficient amount of time,
higher-energy components will eventually die out (in comparison with the lowest-energy state)
and leave us with desired ground state.
The state obtained from Thomas-Fermi approximated GPE can be taken as an initial one,
since it is rather close to the desired one (and, therefore, higher-energy components are already quite small).

Since the energy will decrease exponentially after each step and the precision of numerical calculations is limited,
renormalisation after each step will be required.
Known total number of atoms in ground state serves best in this case
(because we will have to renormalise the final ground state anyway):
\[
	\int\limits_V \lvert \Psi(\tau, \xvec) \rvert^2 dV = N.
\]

Propagation is terminated when the total energy of the state stops changing
(that is, only one component with the lowest energy is left out).
So, we need to calculate the total energy after each step:
\[
	E(\Psi) = \int\limits_V \Psi^* \hat{H} \Psi dV
	= \int\limits_V \left(
		-\frac{\hbar^2}{2 m} \Psi^* \nabla^2 \Psi + V(\xvec) n + \frac{g_{11}}{2} n^2
	\right) dV,
\]
where $n = \lvert \Psi \rvert^2$,
and compare it to the previous value, waiting for the desired precision to be reached.

Now how do we propagate the state of the system?
There are a lot of possibilities, one of which is split-step Fourier method (see \todo{reference split-step section}).
The propagation in imaginary time can be described as:
\[
	\frac{\partial \Psi}{\partial \tau} = - \frac{1}{\hbar} \hat{H} \Psi.
\]
Therefore, differential and nonlinear operator, necessary for split-step method, are:
\[
	\hat{D} = \frac{\hbar}{2 m}\nabla^2,\,
	\hat{N} = -\frac{1}{\hbar}\left( V(\xvec) + g_{11} \lvert \Psi(\xvec) \rvert^2 \right).
\]
