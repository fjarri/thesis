% =============================================================================
\section{Functional transformation}
% =============================================================================

Now we have all the tools we need to work with the functional Wigner representation.
The notation for multidimensional integral follows that given in \appref{func-calculus}.
First, we will define a functional analogue of the displacement operator~\eqnref{mm-wigner:sm:displacement-op}:
\begin{definition}
\label{def:wigner:func:displacement-op}
The functional displacement operator $\hat{D} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{H}_{\restbasis}$ is defined as
\begin{eqn}
	\hat{D}[\Lambda] = \exp \int \upd\xvec \left(
		\Lambda(\xvec) \Psiop^\dagger(\xvec) - \Lambda^*(\xvec) \Psiop(\xvec)
	\right).
\end{eqn}
\end{definition}

From now on we drop the coordinate argument of functions and field operators for brevity.
It can be shown that the displacement operator has properties similar to~\eqnref{mm-wigner:sm:displacement-derivatives}.

\begin{lemma}
\label{lmm:wigner:func:displacement-derivatives}
	Derivatives of the functional displacement operator are
	\begin{eqn*}
		\frac{\fdelta}{\fdelta \Lambda^\prime} \hat{D}[\Lambda]
		& = \hat{D}[\Lambda] (\Psiop^{\prime\dagger} + \frac{1}{2} \Lambda^{\prime*})
		= (\Psiop^{\prime\dagger} - \frac{1}{2} \Lambda^{\prime*}) \hat{D}[\Lambda], \\
		-\frac{\fdelta}{\fdelta \Lambda^{\prime*}} \hat{D}[\Lambda]
		& = \hat{D}[\Lambda] (\Psiop^\prime + \frac{1}{2} \Lambda^\prime)
		= (\Psiop^\prime - \frac{1}{2} \Lambda^\prime) \hat{D}[\Lambda].
	\end{eqn*}
\end{lemma}
\begin{proof}
We will prove the second part of the first equation.
Using the Baker-Hausdorff theorem, the functional displacement operator can be rewritten as
\begin{eqn}
	\hat{D}[\Lambda]
	= \exp \left( \int \upd\xvec \Lambda \Psiop^\dagger \right)
		\exp \left( -\int \upd\xvec \Lambda^* \Psiop \right)
		\exp \frac{1}{2} \left[
			\int \upd\xvec^\prime \Lambda^\prime \Psiop^{\prime\dagger},
			\int \upd\xvec \Lambda^* \Psiop
		\right].
\end{eqn}
Recognising the commutator of field operators, we can simplify
\begin{eqn}
	\left[
		\int \upd\xvec^\prime \Lambda^\prime \Psiop^{\prime\dagger},
		\int \upd\xvec \Lambda^* \Psiop
	\right]
	& = \iint \upd\xvec\, \upd\xvec^\prime
		\Lambda^\prime \Lambda^* \delta_{\restbasis}(\xvec^\prime, \xvec) \\
	& = \int \upd\xvec \Lambda \Lambda^*,
\end{eqn}
resulting in the expression for the displacement operator
\begin{eqn}
	\hat{D}[\Lambda]
	= \exp \left( \int \upd\xvec \Lambda \Psiop^\dagger \right)
		\exp \left( -\int \upd\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \int \upd\xvec \Lambda \Lambda^*
		\right).
\end{eqn}
Thus, differentiation of the displacement operator gives
\begin{eqn}
	\frac{\fdelta}{\fdelta \Lambda^\prime} \hat{D}[\Lambda]
	& = \left(
		\int \upd\xvec \Psiop^\dagger \delta_{\restbasis}(\xvec^\prime, \xvec)
		- \frac{1}{2} \int \upd\xvec \Lambda^* \delta_{\restbasis}(\xvec^\prime, \xvec)
	\right) \hat{D}[\Lambda].
\end{eqn}
Expanding $\Lambda^*$ into modes and using the \defref{func-calculus:restricted-delta} of the restricted delta function, it is easy to show that
\begin{eqn}
	\int \upd\xvec \Lambda^* \delta_{\restbasis}(\xvec^\prime, \xvec)
	& = \sum_{\mvec,\nvec \in \restbasis} \int \upd\xvec
			\phi_{\mvec}^* \lambda_{\mvec}^*
			\phi_{\nvec}^{\prime*} \phi_{\nvec} \\
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime *} \lambda_{\mvec}^*
	\equiv \Lambda^{\prime *},
\end{eqn}
and similarly that
\begin{eqn}
	\int \upd\xvec \Psiop^\dagger \delta_{\restbasis}(\xvec^\prime, \xvec)
	= \Psiop^{\prime\dagger}.
\end{eqn}
This results in the final expression for the differential
\begin{eqn}
	\frac{\fdelta}{\fdelta \Lambda^\prime} \hat{D}[\Lambda]
	& = (\Psiop^{\prime\dagger} - \frac{1}{2} \Lambda^{\prime *}) \hat{D}[\Lambda].
\end{eqn}
The remaining equations from the statement are proved analogously.
\end{proof}

Similar to the single-mode Wigner transformation from \defref{mm-wigner:sm:w-transformation}, the functional Wigner transformation is the Fourier transform of a trace, but expressed in functional terms.

\begin{definition}
\label{def:wigner:func:w-transformation}
	The functional Wigner transformation $\mathcal{W} \in \mathbb{FH}_{\restbasis} \rightarrow \mathbb{F}_{\restbasis}$ is defined as
	\begin{eqn*}
		\mathcal{W}[\hat{A}]
		= \frac{1}{\pi^{2|\restbasis|}} \int \fdelta^2 \Lambda\,
			D[\Lambda, \Psi]
			\Trace{ \hat{A} \hat{D}[\Lambda] }.
	\end{eqn*}
	It transforms an operator $\hat{A}$ on a restricted subset of a Hilbert space to a functional $(\mathcal{W}[\hat{A}])[\Psi]$.
	The corresponding functional Weyl transformation is:
	\begin{eqn*}
		\mathcal{W}^{-1}[F]
		= \frac{1}{\pi^{|\restbasis|}} \int \fdelta^2 \Xi\, \hat{D}^{\dagger}[\Xi]
			\int \fdelta^2 \Phi\, D[\Phi, \Xi] F[\Phi].
	\end{eqn*}
	Here $\Psi \equiv \Psi(\xvec)$ is a complex-valued classical field, unlike the operator-valued field $\Psiop$ introduced earlier in this chapter.
\end{definition}

It can be proved, as in \thmref{mm-wigner:sm:w-real} for the single-mode case, that $\mathcal{W}[\hat{A}]$ is real if $\hat{A}$ is Hermitian, and $\mathcal{W}[\mathcal{W}^{-1}[F]] \equiv F$ (by mode expansion).
Following the single-mode and the multimode cases we define the characteristic functional $\chi_W [\Lambda] \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{C}$
\begin{eqn}
	\chi_W [\Lambda] = \Trace{ \hat{\rho} \hat{D}[\Lambda] },
\end{eqn}
and the Wigner functional $W \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{R}$
\begin{eqn}
	W [\Psi]
	\equiv \mathcal{W}[\hat{\rho}]
	= \frac{1}{\pi^{2|\restbasis|}} \int \fdelta^2 \Lambda\,
		D[\Lambda, \Psi]
		\chi_W [\Lambda].
\end{eqn}

Correspondence relations and the moment extraction theorem have the same form as in the single-mode case.

\begin{theorem}[functional extension of \thmref{mm-wigner:sm:correspondences}]
\label{thm:wigner:func:correspondences}
	For any Hilbert-Schmidt operator $\hat{A}$,
	\begin{eqn*}
		\mathcal{W} [ \Psiop \hat{A} ]
			& = \left( \Psi + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi^*} \right) \mathcal{W}[\hat{A}],
		\quad
		\mathcal{W} [ \Psiop^\dagger \hat{A} ]
			= \left( \Psi^* - \frac{1}{2} \frac{\fdelta}{\fdelta \Psi} \right) \mathcal{W}[\hat{A}], \\
		\mathcal{W} [ \hat{A} \Psiop ]
			& = \left( \Psi - \frac{1}{2} \frac{\fdelta}{\fdelta \Psi^*} \right) \mathcal{W}[\hat{A}],
		\quad
		\mathcal{W} [ \hat{A} \Psiop^\dagger ]
			= \left( \Psi^* + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi} \right) \mathcal{W}[\hat{A}].
	\end{eqn*}
\end{theorem}
\begin{proof}
We will prove the first correspondence.
First, let us transform the trace using \lmmref{wigner:func:displacement-derivatives}:
\begin{eqn}
	\Trace{ \Psiop \hat{A} \hat{D} }
	& = \Trace{ \hat{A} \hat{D} \Psiop}
	= \Trace{ \hat{A} \left(
		-\frac{\fdelta}{\fdelta \Lambda^*}
		-\frac{1}{2} \Lambda
	\right) \hat{D}} \\
	& = \left(
		-\frac{\fdelta}{\fdelta \Lambda^*}
		-\frac{1}{2} \Lambda
	\right) \Trace{ \hat{A} \hat{D}}.
\end{eqn}
Moving the additional multiplier to the outside of the integral:
\begin{eqn}
	\mathcal{W} [ \hat{\Psi} \hat{A} ]
	& = \frac{1}{\pi^{2|\restbasis|}} \int \fdelta^2 \Lambda
		\left( \exp \int \upd\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \right)
		\Trace{ \Psiop \hat{A} \hat{D}[\Lambda] } \\
	& = \frac{1}{\pi^{2|\restbasis|}} \int \fdelta^2 \Lambda
		\left( \exp \int \upd\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \right)
		\left(
			-\frac{\fdelta}{\fdelta \Lambda^*}
			-\frac{1}{2} \Lambda
		\right)
		\Trace{ \hat{A} \hat{D}[\Lambda] } \\
	& = \frac{1}{2} \frac{\fdelta}{\fdelta \Psi^*} \mathcal{W} [\hat{A}]
	- \frac{1}{\pi^{2|\restbasis|}} \int \fdelta^2 \Lambda
		\left( \exp \int \upd\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \right)
		\frac{\fdelta}{\fdelta \Lambda^*}
		\Trace{ \hat{A} \hat{D}[\Lambda] }.
\end{eqn}
Using \lmmref{func-calculus:zero-integrals} to move the partial derivative over $\Lambda^*$ ($\hat{D}[\Lambda]$ equals a product of single-mode displacement operators, which makes the operator in the trace Hilbert-Schmidt, and the trace itself bounded):
\begin{eqn}
	\mathcal{W} [ \hat{\Psi} \hat{A} ]
	& = \frac{1}{2} \frac{\fdelta}{\fdelta \Psi^*} \mathcal{W} [\hat{A}]
	+ \frac{1}{\pi^{2|\restbasis|}} \int \fdelta^2 \Lambda \left(
		\frac{\fdelta}{\fdelta \Lambda^*}
		\exp \int \upd\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right)
	\right)
	\Trace{ \hat{A} \hat{D}[\Lambda] } \\
	& = \left( \Psi + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi^*} \right) \mathcal{W} [\hat{A}].
	\qedhere
\end{eqn}
\end{proof}

\begin{lemma}[functional extension of \lmmref{mm-wigner:sm:moments-from-chi}]
\label{lmm:wigner:func:moments-from-chi}
	For a system with a density matrix $\hat{\rho}$ and a corresponding characteristic function $\chi_W$:
	\begin{eqn*}
		\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle
		= \left.
			\left( \frac{\fdelta}{\fdelta \Lambda^\prime} \right)^s
			\left( -\frac{\fdelta}{\fdelta \Lambda^{\prime*}} \right)^r
			\chi_W [\Lambda]
		\right|_{\Lambda \equiv 0}.
	\end{eqn*}
\end{lemma}
\begin{proof}
The proof follows the same general scheme as in the single-mode case.
The exponent in the expression for $\chi_W$ can be expanded as
\begin{eqn}
	\exp (\int \upd\xvec \Lambda \Psiop^\dagger - \int \upd\xvec \Lambda^* \Psiop)
	= \sum_{r,s}
		\frac{
			\symprod{
				\left( \int \upd\xvec \Lambda \Psiop^\dagger \right)^r
				\left( -\int \upd\xvec \Lambda^* \Psiop \right)^s
			}
		}
		{r!s!}.
\end{eqn}
We can swap a functional derivative with both integration and multiplication by an independent function, so:
\begin{eqn}
	\frac{\fdelta}{\fdelta \Lambda^\prime} \left( \int \upd\xvec \Lambda \Psiop^\dagger \right)^r
	& = r \int \upd\xvec \frac{\fdelta \Lambda}{\fdelta \Lambda^\prime} \Psiop^\dagger
		\left( \int \upd\xvec \Lambda \Psiop^\dagger \right)^{r-1} \\
	& = r \int \upd\xvec\, \delta_{\restbasis}(\xvec^\prime, \xvec) \Psiop^\dagger
		\left( \int \upd\xvec\, \Lambda \Psiop^\dagger \right)^{r-1} \\
	& = r \Psiop^{\prime\dagger} \left( \int \upd\xvec\, \Lambda \Psiop^\dagger \right)^{r-1}.
\end{eqn}
A multiple application of the differential then gives us
\begin{eqn}
	\left( \frac{\fdelta}{\fdelta \Lambda^\prime} \right)^r
	\left( \int \upd\xvec\, \Lambda \Psiop^\dagger \right)^r
	= r! ( \Psiop^{\prime\dagger} )^r.
\end{eqn}
Similarly, for the other differential:
\begin{eqn}
	\left( -\frac{\fdelta}{\fdelta \Lambda^{\prime*}} \right)^s
	\left( -\int \upd\xvec\, \Lambda \Psiop^\dagger \right)^s
	= s! ( \Psiop^{\prime\dagger} )^s.
\end{eqn}

Thus, as in the single-mode case, the differentiation will eliminate all lower order terms in the expansion, and all higher order terms will be eliminated by setting $\Lambda \equiv 0$, leaving only one operator product with the required order:
\begin{eqn}
	\left.
		\left( \frac{\fdelta}{\fdelta \Lambda^\prime} \right)^s
		\left( -\frac{\fdelta}{\fdelta \Lambda^{\prime*}} \right)^r
		\chi_W [\Lambda]
	\right|_{\Lambda \equiv 0}
	& = r! s! \frac{1}{r! s!}
		\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle \\
	& = \langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle.
	\qedhere
\end{eqn}
\end{proof}

\begin{theorem}[functional extension of \thmref{mm-wigner:sm:moments}]
\label{thm:wigner:func:moments}
	For a system with a density matrix $\hat{\rho}$ and a corresponding Wigner functional $W[\Psi]$, given any non-negative integers $r$, $s$:
	\begin{eqn*}
		\langle \symprod{ \Psiop^r (\Psiop^\dagger)^s } \rangle
		= \int \fdelta^2\Psi\, \Psi^r (\Psi^*)^s W[\Psi].
	\end{eqn*}
\end{theorem}
\begin{proof}
By definition of the Wigner functional:
\begin{eqn}
	\int \fdelta^2\Psi\, \Psi^r (\Psi^*)^s W[\Psi]
	= \frac{1}{\pi^{2|\restbasis|}} \Trace{ \hat{\rho}
		\int \fdelta^2\Psi\, \Psi^r (\Psi^*)^s
		\int \fdelta^2\Lambda \exp(-\Lambda \Psi^* + \Lambda^* \Psi)
		\hat{D}[\Lambda]
	}
\end{eqn}
Evaluating the integral over $\Psi$ using \lmmref{func-calculus:fourier-of-moments}:
\begin{eqn}
	\int \fdelta^2\Psi\, \Psi^r (\Psi^*)^s W[\Psi]
	= \int \fdelta^2\Lambda
		\left(
			\left( \frac{\fdelta}{\fdelta \Lambda} \right)^s
			\left( -\frac{\fdelta}{\fdelta \Lambda^*} \right)^r
			\Delta_{\restbasis}[\Lambda]
		\right)
		\Trace{
			\hat{\rho}
			\hat{D}[\Lambda]
		}.
\end{eqn}
Integrating by parts and eliminating the terms that fit \lmmref{func-calculus:zero-delta-integrals}:
\begin{eqn}
	\int \fdelta^2\Psi\, \Psi^r (\Psi^*)^s W[\Psi]
	& = \int \fdelta^2\Lambda\,
		\Delta_{\restbasis}[\Lambda]
		\left( \frac{\fdelta}{\fdelta \Lambda} \right)^s
		\left( -\frac{\fdelta}{\fdelta \Lambda^*} \right)^r
		\Trace{
			\hat{\rho}
			\hat{D}[\Lambda]
		} \\
	& = \left.
		\left( \frac{\fdelta}{\fdelta \Lambda} \right)^s
		\left( -\frac{\fdelta}{\fdelta \Lambda^*} \right)^r
		\chi_W [\Lambda]
	\right|_{\Lambda \equiv 0}.
\end{eqn}
Now, recognising the final expression as a part of \lmmref{wigner:func:moments-from-chi}, we immediately get the statement of the theorem.
\end{proof}
