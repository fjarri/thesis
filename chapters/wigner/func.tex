% =============================================================================
\section{Functional Wigner representation}
% =============================================================================

First, we will define functional analogue of the displacement operator~\eqnref{formalism:sm-wigner:dispacement-op}:
\begin{eqn}
	& \hat{D} :: \mathbb{F}_{\restbasis} \rightarrow \mathbb{H}_{\restbasis} \\
	& \hat{D}[\Lambda, \Lambda^*] = \exp \int d\xvec \left(
		\Lambda \Psiop^\dagger - \Lambda^* \Psiop
	\right),
\end{eqn}
where $\Lambda = \mathcal{C}_{\restbasis}(\blambda)$ is some function from $\mathbb{F}_{\restbasis}$.

It can be shown that the displacement operator has properties similar to~\eqnref{formalism:sm-wigner:displacement-derivatives}.

\begin{lemma}
\label{lmm:formalism:func-wigner:displacement-derivatives}
	\begin{eqn*}
		\frac{\delta}{\delta \Lambda^\prime} \hat{D}[\Lambda, \Lambda^*]
		& = \hat{D}[\Lambda, \Lambda^*] (\Psiop^{\prime\dagger} + \frac{1}{2} \Lambda^{\prime*})
		= (\Psiop^{\prime\dagger} - \frac{1}{2} \Lambda^{\prime*}) \hat{D}[\Lambda, \Lambda^*], \\
		-\frac{\delta}{\delta \Lambda^{\prime*}} \hat{D}[\Lambda, \Lambda^*]
		& = \hat{D}(\Lambda, \Lambda^*) (\Psiop^\prime + \frac{1}{2} \Lambda^\prime)
		= (\Psiop^\prime - \frac{1}{2} \Lambda^\prime) \hat{D}[\Lambda, \Lambda^*].
	\end{eqn*}
\end{lemma}
\begin{proof}
We will prove the second part of the first equation.
Using Baker-Hausdorff theorem:
\begin{eqn}
	\hat{D}[\Lambda, \Lambda^*]
	& = \exp \left( \int d\xvec \Lambda \Psiop^\dagger \right)
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \frac{1}{2} \left[
			\int d\xvec^\prime \Lambda^\prime \Psiop^{\prime\dagger},
			\int d\xvec \Lambda^* \Psiop
		\right] \\
	& = \exp \left( \int d\xvec \Lambda \Psiop^\dagger \right)
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \iint d\xvec d\xvec^\prime
			\Lambda^\prime \Lambda^* \delta_{\restbasis}(\xvec^\prime, \xvec)
		\right) \\
	& = \exp \left( \int d\xvec \Lambda \Psiop^\dagger \right)
		\exp \left( -\int d\xvec \Lambda^* \Psiop \right)
		\exp \left(
			-\frac{1}{2} \int d\xvec \Lambda \Lambda^*
		\right).
\end{eqn}
Note that, since $\Lambda \in \mathbb{F}_{\restbasis}$, it projects to itself, and so does $\Psiop^\dagger$.
Thus
\begin{eqn}
	\frac{\delta}{\delta \Lambda^\prime} \hat{D}[\Lambda, \Lambda^*]
	& = \left(
		\int dx \Psiop^\dagger \delta_{\restbasis}(\xvec^\prime, \xvec)
		- \frac{1}{2} \int dx \Lambda^* \delta_{\restbasis}(\xvec^\prime, \xvec)
	\right) \hat{D}[\Lambda, \Lambda^*] \\
	& = (\Psiop^{\prime\dagger} - \frac{1}{2} \Lambda^{\prime *}) \hat{D}[\Lambda, \Lambda^*].
	\qedhere
\end{eqn}
\end{proof}

\begin{definition}
\label{def:formalism:func-wigner:w-transformation}
	Functional Wigner transformation $\mathcal{W}$ is defined as
	\begin{eqn*}
		& \mathcal{W} :: \mathbb{FH}_{\restbasis} \rightarrow \mathbb{F}_{\restbasis}
			\rightarrow \mathbb{C} \\
		& \mathcal{W}[\hat{A}]
		= \frac{1}{\pi^{2|\restbasis|}} \int \delta^2 \Lambda
			D[\Lambda, \Lambda^*, \Psi, \Psi^*]
			\Trace{ \hat{A} \hat{D}[\Lambda, \Lambda^*] }.
	\end{eqn*}
	It transforms an operator $\hat{A}$ on a restricted subset of a Hilbert space to a functional $(\mathcal{W}[\hat{A}])[\Psi, \Psi^*]$.
	It can be proved, same as in \thmref{formalism:sm-wigner:w-real} for the single-mode case, that $\mathcal{W}[\hat{A}]$ is real if $\hat{A}$ is Hermitian.
	The corresponding functional Weyl transformation is:
	\begin{eqn*}
		\mathcal{W}^{-1}[F]
		= \frac{1}{\pi^{|\restbasis|}} \int \delta^2 \Xi \hat{D}^{\dagger}[\Xi, \Xi^*]
			\int \delta^2 \Phi D[\Phi, \Phi^*, \Xi, \Xi^*] F[\Phi, \Phi^*].
	\end{eqn*}
\end{definition}

\begin{theorem}
	For any $F$,
	\begin{eqn*}
		\mathcal{W}[\mathcal{W}^{-1}[F]] \equiv F.
	\end{eqn*}
\end{theorem}
\begin{proof}
\todo{Proved by expanding into modes.}
\end{proof}

\begin{definition}
\label{def:formalism:func-wigner:w-functional}
	The Wigner functional is
	\begin{eqn*}
		& W :: \mathbb{F}_{\restbasis} \rightarrow \mathbb{R} \\
		& W [\Psi, \Psi^*]
		\equiv \mathcal{W}[\hat{\rho}]
		= \frac{1}{\pi^{2|\restbasis|}} \int \delta^2 \Lambda
			D[\Lambda, \Lambda^*, \Psi, \Psi^*]
			\chi_W [\Lambda, \Lambda^*],
	\end{eqn*}
	where $\chi_W [\Lambda, \Lambda^*]$ is the characteristic functional
	\begin{eqn*}
		& \chi_W :: \mathbb{F}_{\restbasis} \rightarrow \mathbb{C} \\
		& \chi_W [\Lambda, \Lambda^*] = \Trace{ \hat{\rho} \hat{D}[\Lambda, \Lambda^*] }.
	\end{eqn*}
\end{definition}

\begin{theorem}[Functional extension of \thmref{formalism:sm-wigner:correspondences}]
\label{thm:formalism:func-wigner:correspondences}
	\begin{eqn*}
		\mathcal{W} [ \Psiop \hat{A} ]
			& = \left( \Psi + \frac{1}{2} \frac{\delta}{\delta \Psi^*} \right) \mathcal{W}[\hat{A}],
		\quad
		\mathcal{W} [ \Psiop^\dagger \hat{A} ]
			= \left( \Psi^* - \frac{1}{2} \frac{\delta}{\delta \Psi} \right) \mathcal{W}[\hat{A}], \\
		\mathcal{W} [ \hat{A} \Psiop ]
			& = \left( \Psi - \frac{1}{2} \frac{\delta}{\delta \Psi^*} \right) \mathcal{W}[\hat{A}],
		\quad
		\mathcal{W} [ \hat{A} \Psiop^\dagger ]
			= \left( \Psi^* + \frac{1}{2} \frac{\delta}{\partial \Psi} \right) \mathcal{W}[\hat{A}].
	\end{eqn*}
\end{theorem}
\begin{proof}
We will prove the first correspondence.
First, let us transform the trace using \lmmref{formalism:func-wigner:displacement-derivatives}:
\begin{eqn}
	\Trace{ \Psiop \hat{A} \hat{D} }
	& = \Trace{ \hat{A} \hat{D} \Psiop}
	= \Trace{ \hat{A} \left(
		-\frac{\delta}{\delta \Lambda^*}
		-\frac{1}{2} \Lambda
	\right) \hat{D}} \\
	& = \left(
		-\frac{\delta}{\delta \Lambda^*}
		-\frac{1}{2} \Lambda
	\right) \Trace{ \hat{A} \hat{D}}
\end{eqn}
Moving additional multiplier outside the integral:
\begin{eqn}
	\mathcal{W} [ \hat{\Psi} \hat{A} ]
	& = \frac{1}{\pi^{2|\restbasis|}} \int \delta^2 \Lambda
		\left( \exp \int d\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \right)
		\Trace{ \Psiop \hat{A} \hat{D}[\Lambda, \Lambda^*] } \\
	& = \frac{1}{\pi^{2|\restbasis|}} \int \delta^2 \Lambda
		\left( \exp \int d\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \right)
		\left(
			-\frac{\delta}{\delta \Lambda^*}
			-\frac{1}{2} \Lambda
		\right)
		\Trace{ \hat{A} \hat{D}[\Lambda, \Lambda^*] } \\
	& = \frac{1}{2} \frac{\delta}{\delta \Psi^*} \mathcal{W} [\hat{A}]
	- \frac{1}{\pi^{2|\restbasis|}} \int \delta^2 \Lambda
		\left( \exp \int d\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \right)
		\frac{\delta}{\delta \Lambda^*}
		\Trace{ \hat{A} \hat{D}[\Lambda, \Lambda^*] }.
\end{eqn}
Using \lmmref{func-calculus:zero-integrals} to move the partial derivative over $\Lambda^*$ \todo{need to proof that the trace is bounded}:
\begin{eqn}
	& = \frac{1}{2} \frac{\delta}{\delta \Psi^*} \mathcal{W} [\hat{A}]
	+ \frac{1}{\pi^{2|\restbasis|}} \int \delta^2 \Lambda \left(
		\frac{\delta}{\delta \Lambda^*}
		\exp \int d\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right)
	\right)
	\Trace{ \hat{A} \hat{D}[\Lambda, \Lambda^*] } \\
	& = \left( \Psi + \frac{1}{2} \frac{\delta}{\delta \Psi^*} \right) \mathcal{W} [\hat{A}].
	\qedhere
\end{eqn}
\end{proof}

\begin{lemma}[Functional extension of \lmmref{formalism:sm-wigner:moments-from-chi}]
\label{lmm:formalism:func-wigner:moments-from-chi}
	\begin{eqn*}
		\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle
		= \left.
			\left( \frac{\delta}{\delta \Lambda^\prime} \right)^s
			\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^r
			\chi_W [\Lambda, \Lambda^*]
		\right|_{\Lambda \equiv 0}.
	\end{eqn*}
\end{lemma}
\begin{proof}
The proof follows the same general scheme as in single-mode case.
The exponent in the $\chi_W$ can be expanded as
\begin{eqn}
	\exp (\Lambda \Psiop^\dagger - \Lambda^* \Psiop)
	= \sum_{r,s}
		\frac{
			\symprod{
				\left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
				\left( -\int d\xvec \Lambda^* \Psiop \right)^s
			}
		}
		{r!s!}.
\end{eqn}
We can swap functional derivative with both integration and multiplication by independent function, so:
\begin{eqn}
	\frac{\delta}{\delta \Lambda^\prime} \left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
	& = r \int d\xvec \frac{\delta \Lambda}{\delta \Lambda^\prime} \Psiop^\dagger
		\left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1} \\
	& = r \int d\xvec \delta_{\restbasis}(\xvec^\prime, \xvec) \Psiop^\dagger
		\left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1} \\
	& = r \Psiop^{\prime\dagger} \left( \int d\xvec \Lambda \Psiop^\dagger \right)^{r-1},
\end{eqn}
and multiple application of the differential gives us
\begin{eqn}
	\left( \frac{\delta}{\delta \Lambda^\prime} \right)^r
	\left( \int d\xvec \Lambda \Psiop^\dagger \right)^r
	= r! ( \Psiop^{\prime\dagger} )^r.
\end{eqn}
Similarly for the other differential:
\begin{eqn}
	\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^s
	\left( -\int d\xvec \Lambda \Psiop^\dagger \right)^s
	= s! ( \Psiop^{\prime\dagger} )^s.
\end{eqn}

Thus, same as in single-mode case,
differentiation will eliminate all lower order terms in the expansion,
and all higher order terms will be eliminated by setting $\Lambda \equiv 0$,
leaving only one operator product with required order:
\begin{eqn}
	\left.
		\left( \frac{\delta}{\delta \Lambda^\prime} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^{\prime*}} \right)^r
		\chi_W [\Lambda, \Lambda^*]
	\right|_{\Lambda \equiv 0}
	& = r! s! \frac{1}{r! s!}
		\langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle \\
	& = \langle \symprod{ (\Psiop^\prime)^r (\Psiop^{\prime\dagger})^s } \rangle.
	\qedhere
\end{eqn}
\end{proof}

\begin{theorem}[Functional extension of \thmref{formalism:sm-wigner:moments}]
\label{thm:formalism:func-wigner:moments}
	\begin{eqn*}
		\int \delta^2\Psi\, \Psi^r (\Psi^*)^s W[\Psi, \Psi^*]
		= \langle \symprod{ \Psiop^r (\Psiop^\dagger)^s } \rangle
	\end{eqn*}
\end{theorem}
\begin{proof}
By definition of Wigner functional:
\begin{eqn}
	\int & \delta^2\Psi\, \Psi^r (\Psi^*)^s W[\Psi, \Psi^*] \\
	={} & \frac{1}{\pi^{2|\restbasis|}} \Trace{ \hat{\rho}
		\int \delta^2\Psi\, \Psi^r (\Psi^*)^s
		\int \delta^2\Lambda \exp(-\Lambda \Psi^* + \Lambda^* \Psi)
		\hat{D}[\Lambda, \Lambda^*]
	}
\end{eqn}
Evaluating integral over $\Psi$ using \lmmref{func-calculus:fourier-of-moments}:
\begin{eqn}
	= \int \delta^2\Lambda
		\left(
			\left( \frac{\delta}{\delta \Lambda} \right)^s
			\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
			\Delta_{\restbasis}[\Lambda]
		\right)
		\Trace{
			\hat{\rho}
			\hat{D}[\Lambda, \Lambda^*]
		}.
\end{eqn}
Integrating by parts and eliminating terms which fit \lmmref{func-calculus:zero-delta-integrals}:
\begin{eqn}
	& = \int \delta^2\Lambda\,
		\Delta_{\restbasis}[\Lambda]
		\left( \frac{\delta}{\delta \Lambda} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
		\Trace{
			\hat{\rho}
			\hat{D}[\Lambda, \Lambda^*]
		} \\
	& = \left.
		\left( \frac{\delta}{\delta \Lambda} \right)^s
		\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
		\chi_W [\Lambda, \Lambda^*]
	\right|_{\Lambda \equiv 0}.
\end{eqn}
Now, recognising the final expression as a part of \lmmref{formalism:func-wigner:moments-from-chi},
we immideately get the statement of the theorem.
\end{proof}
