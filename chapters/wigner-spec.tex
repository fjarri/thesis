% =============================================================================
\chapter{Transformation of the master equation}
\label{cha:wigner-spec}
% =============================================================================

Although the functional correspondences from \thmref{wigner:mc:correspondences} are relatively straightforward, there is a certain amount of work required to apply them to actual master equations arising in real world problems.
This chapter contains several theorems describing transformations of specific operator sequences,
encountered in master equations describing \abbrev{bec} evolution.


% =============================================================================
\section{Unitary evolution}
% =============================================================================

The simplest non-trivial element of the Hamiltonian one is the density operator $\Psiop_j^\dagger \Psiop_k$, which describes, for instance, a potential or a coupling field.

\begin{theorem}
\label{thm:wigner-spec:w-commutator1}
    For a Hilbert-Schmidt operator $\hat{A}$ with the corresponding Wigner functional $\mathcal{W}[\hat{A}] \equiv (\mathcal{W}[\hat{A}])[\bPsi]$,Â 
    \begin{eqn*}
        \mathcal{W} \left[ [\int \upd\xvec \Psiop_j^\dagger \Psiop_k, \hat{A}] \right]
        = \int \upd\xvec \left(
            - \frac{\fdelta}{\fdelta \Psi_j} \Psi_k
            + \frac{\fdelta}{\fdelta \Psi_k^*} \Psi_j^*
        \right) \mathcal{W}[\hat{A}].
    \end{eqn*}
\end{theorem}
\begin{proof}
Expanding the commutator and applying \thmref{wigner:mc:correspondences}:
\begin{eqn}
    \mathcal{W} \left[ [\int \upd\xvec \Psiop_j^\dagger \Psiop_k, \hat{A}] \right]
    ={} & \int \upd\xvec \left(
        \left(
            \Psi_j^* - \frac{1}{2} \frac{\fdelta}{\fdelta \Psi_j}
        \right)
        \left(
            \Psi_k + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi_k^*}
        \right) \right. \\
    &   \left. - \left(
            \Psi_k - \frac{1}{2} \frac{\fdelta}{\fdelta \Psi_k^*}
        \right)
        \left(
            \Psi_j^* + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi_j}
        \right)
    \right)
    \mathcal{W}[\hat{A}] \\
    ={} & \frac{1}{2} \int \upd\xvec \left(
        - \frac{\fdelta}{\fdelta \Psi_j} \Psi_k
        + \Psi_j^* \frac{\fdelta}{\fdelta \Psi_k^*}
        + \frac{\fdelta}{\fdelta \Psi_k^*} \Psi_j^*
        - \Psi_k \frac{\fdelta}{\fdelta \Psi_j}
    \right)
    \mathcal{W}[\hat{A}].
\end{eqn}
Changing the order of derivatives and functions using the relation
\begin{eqn}
    \Psi_k \frac{\fdelta}{\fdelta \Psi_j} \mathcal{F}
    = \left(
        \frac{\fdelta}{\fdelta \Psi_j} \Psi_k
        - \delta_{jk} \delta_{\restbasis_j}(\xvec, \xvec)
    \right) \mathcal{F},
\end{eqn}
we get
\begin{eqn}
    \mathcal{W} \left[ [\int \upd\xvec \Psiop_j^\dagger \Psiop_k, \hat{A}] \right]
    = \int \upd\xvec \left(
        - \frac{\fdelta}{\fdelta \Psi_j} \Psi_k
        + \frac{\fdelta}{\fdelta \Psi_k^*} \Psi_j^*
    \right)
    \mathcal{W}[\hat{A}],
\end{eqn}
which is the statement of the theorem.
\end{proof}

Commutators with the Laplacian inside require somewhat special treatment, because it acts on basis functions and, in general, cannot be dragged around like a constant.
For our purposes we only need one specific case, and, fortunately, in this case it does act like a constant.
The target expression describes kinetic energy in a Hamiltonian.

\begin{theorem}
\label{thm:wigner-spec:w-laplacian-commutator1}
    For a Hilbert-Schmidt operator $\hat{A}$ with the corresponding Wigner functional $\mathcal{W}[\hat{A}] \equiv (\mathcal{W}[\hat{A}])[\bPsi]$,
    \begin{eqn*}
        \mathcal{W} \left[
            \int \upd\xvec [\Psiop^\dagger(\xvec) \nabla^2 \Psiop(\xvec), \hat{A}]
        \right]
        = \int \upd\xvec \left(
            - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
            + \frac{\fdelta}{\fdelta \Psi^*} \nabla^2 \Psi^*
        \right) \mathcal{W}[\hat{A}].
    \end{eqn*}
\end{theorem}
\begin{proof}
First, it is obvious from the definition of the Wigner transformation that an integral or a derivative acting on coordinates can be moved in and out of the transformation:
\begin{eqn}
    \mathcal{W} \left[ \int \upd\xvec \hat{B}(\xvec) \hat{A} \right]
    & = \int \upd\xvec \mathcal{W} [\hat{B}(\xvec) \hat{A}], \\
    \mathcal{W} [ \nabla^2 \hat{B}(\xvec) \hat{A} ]
    & = \nabla^2 \mathcal{W} [\hat{B}(\xvec) \hat{A}].
\end{eqn}
Let us now expand the commutator and apply correspondences from \thmref{wigner:func:correspondences}:
\begin{eqn2}
    & \mathcal{W} && \left[
        \int \upd\xvec [\Psiop^\dagger(\xvec) \nabla^2 \Psiop(\xvec), \hat{A}]
    \right] \\
    & ={} && \int \upd\xvec \left(
            \Psi^* - \frac{1}{2} \frac{\fdelta}{\fdelta \Psi}
        \right)
        \left(
            \nabla^2 \Psi + \frac{1}{2} \nabla^2 \frac{\fdelta}{\fdelta \Psi^*}
        \right)
        \mathcal{W}[\hat{A}] \\
    & && - \int \upd\xvec \left(
            \nabla^2 \Psi - \frac{1}{2} \nabla^2 \frac{\fdelta}{\fdelta \Psi^*}
        \right)
        \left(
            \Psi^* + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi}
        \right)
        \mathcal{W}[\hat{A}] \\
    & ={} && \frac{1}{2} \int \upd\xvec \left(
            - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
            + \Psi^* \nabla^2 \frac{\fdelta}{\fdelta \Psi^*}
            + \left( \nabla^2 \frac{\fdelta}{\fdelta \Psi^*} \right) \Psi^*
            - \left( \nabla^2 \Psi \right) \frac{\fdelta}{\fdelta \Psi}
        \right)
        \mathcal{W}[\hat{A}].
\end{eqn2}

Using the basis expansion, one can easily check that
\begin{eqn}
    \Psi^* \nabla^2 \frac{\fdelta}{\fdelta \Psi^*} \mathcal{F}[\Psi]
    = \left( \nabla^2 \frac{\fdelta}{\fdelta \Psi^*} \right) \Psi^* \mathcal{F}[\Psi]
    - \sum_{\nvec \in \restbasis} \phi_{\nvec}^* \nabla^2 \phi_{\nvec} \mathcal{F}[\Psi],
\end{eqn}
and
\begin{eqn}
    \left( \nabla^2 \Psi \right) \frac{\fdelta}{\fdelta \Psi} \mathcal{F}[\Psi]
    = \frac{\fdelta}{\fdelta \Psi} \left( \nabla^2 \Psi \right) \mathcal{F}[\Psi]
    - \sum_{\nvec \in \restbasis} \phi_{\nvec}^* \nabla^2 \phi_{\nvec} \mathcal{F}[\Psi].
\end{eqn}
Therefore:
\begin{eqn}
    & \mathcal{W} \left[
        \int \upd\xvec [\Psiop^\dagger(\xvec) \nabla^2 \Psiop(\xvec), \hat{A}]
    \right] \\
    & = \frac{1}{2} \int \upd\xvec \left(
        - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
        + \left( \nabla^2 \frac{\fdelta}{\fdelta \Psi^*} \right) \Psi^*
        + \left( \nabla^2 \frac{\fdelta}{\fdelta \Psi^*} \right) \Psi^*
        - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
    \right)
    \mathcal{W}[\hat{A}].
\end{eqn}
Now using \lmmref{func-calculus:move-laplacian} we can get the final result:
\begin{eqn}
    & = \frac{1}{2} \int \upd\xvec \left(
        - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
        + \frac{\fdelta}{\fdelta \Psi^*} \nabla^2 \Psi^*
        + \frac{\fdelta}{\fdelta \Psi^*} \nabla^2 \Psi^*
        - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
    \right)
    \mathcal{W}[\hat{A}] \\
    & = \int \upd\xvec \left(
        - \frac{\fdelta}{\fdelta \Psi} \nabla^2 \Psi
        + \frac{\fdelta}{\fdelta \Psi^*} \nabla^2 \Psi^*
    \right) \mathcal{W}[\hat{A}].
    \qedhere
\end{eqn}
\end{proof}

The last usual term in \abbrev{bec} Hamiltonians is a fourth order nonlinear interaction term.
We will provide the transformation for its general non-local form, which can be later simplified to the local one by intergration with the delta function.

\begin{theorem}
\label{thm:wigner-spec:w-commutator2}
    For a Hilbert-Schmidt operator $\hat{A}$ with the corresponding Wigner functional $\mathcal{W}[\hat{A}] \equiv (\mathcal{W}[\hat{A}])[\bPsi]$,
    \begin{eqn*}
        & \mathcal{W} \left[
            [
                \int \upd\xvec \int \upd\xvec^\prime
                \Psiop_j^\dagger \Psiop_k^{\prime\dagger} \Psiop_j \Psiop_k^\prime,
                \hat{A}
            ]
        \right] \\
        & = \int \upd\xvec \int \upd\xvec^\prime \left(
            -\frac{\fdelta}{\fdelta \Psi_j} \mathcal{Q}_{jk} \right.
            + \frac{\fdelta}{\fdelta \Psi_j^*} \mathcal{Q}_{jk}^*
            - \frac{\fdelta}{\fdelta \Psi_k} \mathcal{Q}_{kj}
            + \frac{\fdelta}{\fdelta \Psi_k^*} \mathcal{Q}_{kj}^* \\
        &   \left. \quad + \frac{\fdelta}{\fdelta \Psi_j^*}
            \frac{\fdelta}{\fdelta \Psi_j}
            \left(
                \frac{\fdelta}{\fdelta \Psi_k^\prime}
                \frac{\Psi_k^\prime}{4}
                - \frac{\fdelta}{\fdelta \Psi_k^{\prime *}}
                \frac{\Psi_k^{\prime *}}{4}
            \right)
            + \frac{\fdelta}{\fdelta \Psi_k^*}
            \frac{\fdelta}{\fdelta \Psi_k}
            \left(
                \frac{\fdelta}{\fdelta \Psi_j^\prime}
                \frac{\Psi_j^\prime}{4}
                - \frac{\fdelta}{\fdelta \Psi_j^{\prime *}}
                \frac{\Psi_j^{\prime *}}{4}
            \right)
        \right) \mathcal{W}[\hat{A}],
    \end{eqn*}
    where we denoted
    \begin{eqn*}
        \mathcal{Q}_{jk}[\bPsi](\xvec, \xvec^\prime)
        = \Psi_j | \Psi_k^\prime |^2
            -\frac{1}{2} \Psi_j \delta_{\restbasis_k}(\xvec^\prime, \xvec^\prime)
            -\frac{\delta_{j k} }{2} \Psi_j^\prime \delta_{\restbasis_k}(\xvec^\prime, \xvec).
    \end{eqn*}
\end{theorem}
\begin{proof}
Proved by straightforward application of \thmref{wigner:mc:correspondences} and simplification of the resulting expression, similarly to \thmref{wigner-spec:w-commutator1}.
\end{proof}


% =============================================================================
\section{Losses}
% =============================================================================

In this section we will state and proof the theorem which describes the transformation of the nonlinear operator
\begin{eqn}
\label{eqn:wigner-spec:loss-operator}
    \hat{\mathcal{L}}_{\lvec} [\hat{A}]
    = 2 \hat{O}_{\lvec} \hat{A} \hat{O}_{\lvec}^\dagger
        - \hat{O}_{\lvec}^\dagger \hat{O}_{\lvec} \hat{A}
        - \hat{A} \hat{O}_{\lvec}^\dagger \hat{O}_{\lvec},
\end{eqn}
where $\lvec = (l_1,\,\ldots,\,l_C)^T$ is the identifier of a loss process, with $l_j$ specifying the number of particles of component $j$ lost in the event, and
\begin{eqn}
    \hat{O}_{\lvec}
    \equiv \hat{O}_{\lvec} (\Psiopvec)
    = \prod_{j=1}^C \Psiop_j^{l_j} (\xvec).
\end{eqn}
The operator of this form appears when one describes losses in a \abbrev{bec}.

Before approaching the main theorem we will need two auxiliary lemmas.
After the application of \thmref{wigner:mc:correspondences} to the operator we will have terms with mixed order of $\Psi_j$ and $\fdelta / \fdelta \Psi_j$, while we need all derivatives to be grouped in the beginning in order to apply \thmref{fpe-sde:corr:fpe-sde-func} to the resulting differential equation.
The first lemma will provide a way to do that.

\begin{lemma}
\label{lmm:wigner-spec:swap-differential}
    For a function $\Psi \in \mathbb{F}_{\restbasis}$ and a functional operator $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$, and non-negative integer $a$, $b$
    \begin{eqn*}
        \Psi^a \left( \frac{\fdelta}{\fdelta \Psi} \right)^b \mathcal{F}[\Psi]
        = \sum_{j=0}^{\min(a, b)}
            \binom{b}{j} \frac{(-1)^j a!}{(a - j)!}
            \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b - j}
            \Psi^{a - j}
            \mathcal{F}[\Psi].
    \end{eqn*}
\end{lemma}
\begin{proof}
Proof by induction.
Let us assume that the statement is true for $b - 1$, and prove it for $b$
(also assuming non-trivial case of $a > 0$).
Moving a single differential to the left:
\begin{eqn}
    \Psi^a \left( \frac{\fdelta}{\fdelta \Psi} \right)^b \mathcal{F}
    = \left(
            \frac{\fdelta}{\fdelta \Psi} \Psi^a
            - a \Psi^{a - 1} \delta_{\restbasis}(\xvec, \xvec)
        \right)
        \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-1}
        \mathcal{F}.
\end{eqn}
Using the known relation for $b-1$:
\begin{eqn}
    ={} & \frac{\fdelta}{\fdelta \Psi} \sum_{j = 0}^{\min(a, b-1)}
            \binom{b-1}{j} \frac{(-1)^j a!}{(a-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-1-j} \Psi^{a-j}
            \mathcal{F} \\
    & - a \delta_{\restbasis}(\xvec, \xvec) \sum_{j = 0}^{\min(a-1, b-1)}
            \binom{b-1}{j} \frac{(-1)^j (a-1)!}{(a-1-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-1-j} \Psi^{a-1-j}
            \mathcal{F}.
\end{eqn}
Merging coefficients in front of the sums into internal expressions:
\begin{eqn}
    ={} & \sum_{j = 0}^{\min(a, b-1)}
            \binom{b-1}{j} \frac{(-1)^j a!}{(a-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-j} \Psi^{a-j}
            \mathcal{F} \\
    & + \sum_{j = 0}^{\min(a-1, b-1)}
            \binom{b-1}{j} \frac{(-1)^{j+1} a!}{(a-1-j)!} \delta_{\restbasis}^{j+1}(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-1-j} \Psi^{a-1-j}
            \mathcal{F}.
\end{eqn}
Shifting counter in the second sum:
\begin{eqn}
    ={} & \sum_{j = 0}^{\min(a, b-1)}
            \binom{b-1}{j} \frac{(-1)^j a!}{(a-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-j} \Psi^{a-j}
            \mathcal{F} \\
    & + \sum_{j = 1}^{\min(a, b)}
            \binom{b-1}{j-1} \frac{(-1)^j a!}{(a-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-j} \Psi^{a-j}
            \mathcal{F}.
\end{eqn}
Now we can join sums, noticing that $\binom{b-1}{j} + \binom{b-1}{j-1} = \binom{b}{j}$.
There will be at most two leftover terms: first, term for $j=0$ from the first sum,
and, possibly, the term with $j=\min(a,b)$ from the second sum.
The former term appears only if $\min(a,b) > \min(a, b-1)$,
or, in other words, $a \ge b$ (which means that $\min(a, b) = b$ and $\min(a, b-1) = b-1$).
\begin{eqn}
    ={} & \binom{b-1}{0} \frac{(-1)^0 a!}{(a-0)!} \delta_{\restbasis}^0(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-0} \Psi^{a-0}
            \mathcal{F} \\
    & + \sum_{j = 1}^{\min(a, b-1)}
            \binom{b}{j} \frac{(-1)^j a!}{(a-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-j} \Psi^{a-j}
            \mathcal{F} \\
    & + H[a - b]
            \binom{b-1}{b-1} \frac{(-1)^j a!}{(a-b)!} \delta_{\restbasis}^b(\xvec, \xvec)
            \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-b} \Psi^{a-b}
            \mathcal{F},
\end{eqn}
Where $H[n]$ is the discrete Heaviside step function.
Now, since $\binom{b-1}{0} \equiv \binom{b}{0}$ and $\binom{b-1}{b-1} \equiv \binom{b}{b}$,
we can attach two leftover terms to the sum as well:
\begin{eqn}
    = \sum_{j = 0}^{\min(a, b)}
        \binom{b}{j} \frac{(-1)^j a!}{(a-j)!} \delta_{\restbasis}^j(\xvec, \xvec)
        \left( \frac{\fdelta}{\fdelta \Psi} \right)^{b-j} \Psi^{a-j}
        \mathcal{F},
\end{eqn}
obtaining the statement of the lemma.
\end{proof}

\begin{lemma}[Sum rearrangement]
\label{lmm:wigner-spec:sum-rearrangement}
    For non-negative integer $a$, $b$:
    \begin{eqn*}
        \sum_{k=0}^a \sum_{m=0}^{\min(a-b,k)} f_{k-m} g_{k, m}
        = \sum_{v=0}^a f_v \sum_{m=0}^{a-\max(b,v)} g_{v + m, m}.
    \end{eqn*}
\end{lemma}
\begin{proof}
Obviously, the index $v = k - m$ of the factor $f$ can vary from $0$ (when $m=k$) to $a$ (when $k=a$ and $m=0$).
Therefore
\begin{eqn}
    \sum_{k=0}^a \sum_{m=0}^{\min(a-b,k)} f_{k-m} g_{k, m}
    = \sum_{v=0}^a f_v \sum_{m \in K(a, b, v)} g_{v + m, m},
\end{eqn}
where the set $K$ is defined as
\begin{eqn}
    K(a, b, v)
    & = \{m |
        0 \le k \le a
        \wedge 0 \le m \le \min(a - b, k)
        \wedge k - m = v
    \} \\
    & = \{m |
        -v \le m \le a - v
        \wedge 0 \le m \le \min(a - b, v + m)
    \} \\
    & = \{m |
        m \le a - v
        \wedge 0 \le m \le \min(a - b, v + m)
    \}.
\end{eqn}

It is convenient to consider the cases of $v \le b$ and $v > b$ separately.
For the former case
\begin{eqn}
    K_{v \le b}
    = \{m |
        m \le a - v
        \wedge 0 \le m \le \min(a - b, m + v)
        \wedge v \le b
    \}.
\end{eqn}
Since $v \le b$, $m \le a - v \le a - b \le \min(a - b, m + v)$ is always true, and the first inequation is redundant:
\begin{eqn}
    = \{m |
        0 \le m \le \min(a - b, v + m)
        \wedge v \le b
    \}.
\end{eqn}
Splitting into two sets to get rid of minimum function:
\begin{eqn}
    ={} & \{m |
        v \le b \wedge m \ge 0
        \\
    &   \wedge (
            (m \le a - b \wedge a - b < v + m)
            \vee
            (m \le v + m \wedge a - b \ge v + m)
        )
    \} \\
    ={} & \{m |
        v \le b \wedge m \ge 0
        \wedge
        (
            (m \le a - b \wedge m > a - b - v)
            \vee
            (m \le a - b - v)
        )
    \} \\
    ={} & \{m |
        v \le b \wedge m \ge 0
        \wedge
        (m \le a - b)
    \} \\
    ={} & \{m | v \le b \wedge 0 \le m \le a - b \}.
\end{eqn}
For the latter case $v < U$ we have
\begin{eqn}
    K_{v > b}
    ={} & \{m |
        m \le a - v
        \wedge 0 \le m \le \min(a - b, m + v)
        \wedge v > b
    \} \\
    ={} & \{m |
        v > b \wedge m \ge 0 \\
    &   \wedge (
            (m \le a - v \wedge m \ge a - b - v)
            \vee
            (m \le a - v \wedge m < a - b - v)
        )
    \} \\
    ={} & \{m | v > b \wedge 0 \le m \le a - v \}.
\end{eqn}

The final result is a union of these two cases:
\begin{eqn}
    K
    & = K_{v \le b} \cup K_{v > b} \\
    & = \{m | v \le b \wedge 0 \le m \le a - b \} \cup \{m | v > b \wedge 0 \le m \le a - v \} \\
    & = \{m | 0 \le m \le a - \max(b, v) \},
\end{eqn}
which gives us the statement of the lemma.
\end{proof}

With the help of these two lemmas we can perform the Wigner transformation of the nonlinear loss operator.

\begin{theorem}
\label{thm:wigner-spec:w-losses}
    The Wigner transformation of the loss operator $\hat{\mathcal{L}}_{\lvec}$ of form~\eqnref{wigner-spec:loss-operator} is
    \begin{eqn*}
        \mathcal{W} \left[ \hat{\mathcal{L}}_{\lvec} [\hat{A}] \right]
        =
            \sum_{j_1=0}^{l_1} \sum_{k_1=0}^{l_1} \ldots
            \sum_{j_C=0}^{l_C} \sum_{k_C=0}^{l_C}
                \left(
                    \prod_{c=1}^C
                        \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^{j_c}
                        \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^{k_c}
                \right)
                Z_{\lvec, \jvec, \kvec}
            \mathcal{W}[\hat{A}],
    \end{eqn*}
    where
    \begin{eqn*}
        Z_{\lvec, \jvec, \kvec}
        ={} & \left( 2 - (-1)^{\sum_c j_c} - (-1)^{\sum_c k_c} \right) \\
        &   \times \prod_{c=1}^C \left(
                \frac{1}{2^{j_c + k_c}}
                \binom{l_c}{j_c} \binom{l_c}{k_c}
                \exp \left(
                    -\frac{\delta_{\restbasis_c}(\xvec, \xvec)}{2}
                    \frac{\upp^2}{\upp \Psi_c \upp \Psi_c^*}
                \right)
                \Psi_c^{l_c-j_c} (\Psi_c^*)^{l_c-k_c}
            \right).
    \end{eqn*}
\end{theorem}
\begin{proof}
Let us perform the transformation for each term of the loss operator.
\begin{eqn}
    W_1
    & \equiv \mathcal{W}[\hat{O}_{\lvec} \hat{A} \hat{O}_{\lvec}^\dagger] \\
    & = \prod_{c=1}^C \left(
            \Psi_c + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi_c^*}
        \right)^{l_c}
        \left(
            \Psi_c^* + \frac{1}{2} \frac{\fdelta}{\fdelta \Psi_c}
        \right)^{l_c}
        \mathcal{W}[\hat{A}] \\
    & = \prod_{c=1}^C \left(
            \sum_{j=0}^{l_c}
                \binom{l_c}{j} \left( \frac{1}{2} \right)^j
                \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^j
                \Psi_c^{l_c - j}
            \sum_{k=0}^{l_c}
                \binom{l_c}{k} \left( \frac{1}{2} \right)^k
                \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^k
                (\Psi_c^*)^{l_c - k}
        \right)
        \mathcal{W}[\hat{A}] \\
    & = \prod_{c=1}^C \left(
            \sum_{j=0}^{l_c}
            \sum_{k=0}^{l_c}
                \binom{l_c}{j} \binom{l_c}{k} \left( \frac{1}{2} \right)^{j + k}
                \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^j
                \Psi_c^{l_c - j}
                \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^k
                (\Psi_c^*)^{l_c - k}
        \right)
        \mathcal{W}[\hat{A}].
\end{eqn}
Using \lmmref{wigner-spec:swap-differential} to swap $\Psi_c$ and $\fdelta / \fdelta \Psi_c$:
\begin{eqn}
    ={} & \prod_{c=1}^C \left(
            \sum_{j=0}^{l_c}
            \sum_{k=0}^{l_c}
                \binom{l_c}{j} \binom{l_c}{k} \left( \frac{1}{2} \right)^{j + k}
                \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^j
        \right. \\
        & \times \left.
                \sum_{m=0}^{\min(l_c - j, k)}
                    \binom{k}{m}
                    \frac{(-1)^m (l_c - j)!}{(l_c - j - m)!}
                    \delta_{\restbasis_c}^m(\xvec, \xvec)
                    \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^{k - m}
                    \Psi_c^{l_c - j - m}
                (\Psi_c^*)^{l_c - k}
        \right)
        \mathcal{W}[\hat{A}].
\end{eqn}
Using \lmmref{wigner-spec:sum-rearrangement} with $a=l_c$ and $b=j$, and
\begin{eqn}
    f_{k-m} & = \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^{k-m}, \\
    g_{k,m} & = \binom{l_c}{j} \binom{l_c}{k} \left( \frac{1}{2} \right)^{j + k}
        \binom{k}{m}
        \frac{(-1)^m (l_c - j)!}{(l_c - j - m)!}
        \delta_{\restbasis_c}^m(\xvec, \xvec)
        \Psi_c^{l_c - j - m}
    (\Psi_c^*)^{l_c - k},
\end{eqn}
we obtain
\begin{eqn}
    W_1 ={} & \prod_{c=1}^C \left(
            \sum_{j=0}^{l_c}
            \sum_{k=0}^{l_c}
                \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^j
                \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^k
            \right. \\
            & \left. \times \sum_{m=0}^{l_c - \max(j, k)}
                Q(l_c, j, k, m)
                \delta_{\restbasis_c}^m(\xvec, \xvec)
                \Psi_c^{l_c - j - m}
                (\Psi_c^*)^{l_c - k - m}
        \right)
        \mathcal{W}[\hat{A}],
\end{eqn}
where
\begin{eqn}
    Q(l, j, k, m)
    & = \frac{1}{2^{j + k + m}}
        \binom{l}{j} \binom{l}{k + m} \binom{k + m}{m}
        \frac{(-1)^m (l - j)!}{(l - j - m)!} \\
    & = \frac{(-1)^m m!}{2^{j + k + m}}
        \binom{l}{j} \binom{l}{k} \binom{l-k}{m} \binom{l-j}{m}.
\end{eqn}
Similarly,
\begin{eqn}
    W_2
    \equiv {} & \mathcal{W}[\hat{O}_{\lvec}^\dagger \hat{O}_{\lvec} \hat{A}] \\
    ={} & \prod_{c=1}^C \left(
            \sum_{j=0}^{l_c}
            \sum_{k=0}^{l_c}
                \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^j
                \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^k
            \right. \\
            & \left. \times \sum_{m=0}^{l_c - \max(j, k)}
                (-1)^k Q(l_c, j, k, m)
                \delta_{\restbasis_c}^m(\xvec, \xvec)
                \Psi_c^{l_c - j - m}
                (\Psi_c^*)^{l_c - k - m}
        \right)
        \mathcal{W}[\hat{A}],
\end{eqn}
and
\begin{eqn}
    W_3
    \equiv {} & \mathcal{W}[\hat{A} \hat{O}_{\lvec}^\dagger \hat{O}_{\lvec}] \\
    ={} & \prod_{c=1}^C \left(
            \sum_{j=0}^{l_c}
            \sum_{k=0}^{l_c}
                \left( \frac{\fdelta}{\fdelta \Psi_c^*} \right)^j
                \left( \frac{\fdelta}{\fdelta \Psi_c} \right)^k
            \right. \\
            & \left. \times \sum_{m=0}^{l_c - \max(j, k)}
                (-1)^j Q(l_c, j, k, m)
                \delta_{\restbasis_c}^m(\xvec, \xvec)
                \Psi_c^{l_c - j - m}
                (\Psi_c^*)^{l_c - k - m}
        \right)
        \mathcal{W}[\hat{A}].
\end{eqn}
The full expression for the Wigner transformation of $\hat{\mathcal{L}}_{\lvec}$ is therefore
\begin{eqn}
    \mathcal{W}[\hat{\mathcal{L}_{\lvec}}[\hat{A}]] = 2 W_1 - W_2 - W_3,
\end{eqn}

The expressions for $W_1$, $W_2$ and $W_3$ can be simplified further using the formal differentiation notation
\begin{eqn}
    \frac{\upp \left( \Psi^{l_c-j} (\Psi^*)^{l_c-k} \right)}{\upp^m \Psi \upp^m \Psi^*}
    \equiv{} & H[l_c-j-m] H[l_c-k-m] \\
    & \times
        \binom{l_c-j}{m} \binom{l_c-k}{m} (m!)^2
        \Psi^{l_c-j-m} (\Psi^*)^{l_c-k-m},
\end{eqn}
where $H[n]$ is the discrete Heaviside function, which equals $1$ for $n \ge 0$, and $0$ otherwise.
With this in mind, the internal summation over $m$ can be rewritten as
\begin{eqn}
    & \sum_{m=0}^{l_c - \max(j, k)}
        Q(l_c, j, k, m)
        \delta_{\restbasis_c}^{m}(\xvec, \xvec)
        \Psi_c^{l_c - j - m}
        (\Psi_c^*)^{l_c - k - m} \\
    & = \sum_{m=0}^{l_c}
        \frac{(-1)^{m}}{2^{j + k + m} m!}
        \binom{l_c}{j} \binom{l_c}{k}
        \delta_{\restbasis_c}^{m}(\xvec, \xvec)
        \frac{\upp \left( \Psi_c^{l_c-j} (\Psi_c^*)^{l_c-k} \right)}{\upp^{m} \Psi_c \upp^{m} \Psi_c^*}.
\end{eqn}
Furthermore, we can extend the summation over $m$ from $l_c$ to $\infty$, since all the new terms will be equal to zero.
This turns the expression into the power series for the exponential:
\begin{eqn}
    = \frac{1}{2^{j + k}}
        \binom{l_c}{j} \binom{l_c}{k}
        \exp \left(
            -\frac{\delta_{\restbasis_c}(\xvec, \xvec)}{2}
            \frac{\upp^2}{\upp \Psi_c \upp \Psi_c^*}
        \right)
        \Psi_c^{l_c-j} (\Psi_c^*)^{l_c-k}.
\end{eqn}
Substituting this into $W_1$, $W_2$ and $W_3$, and swapping the product and summations over $j_c$ and $k_c$, we get the statement of the lemma.
\end{proof}
