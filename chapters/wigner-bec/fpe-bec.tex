% =============================================================================
\section{Fokker-Planck equation for the BEC}
% =============================================================================

With the Wigner truncation applied, we can get rid of the third- and higher-order functional derivatives in~\eqnref{wigner-bec:truncation:untruncated-fpe}.
Under the reasonable assumption of $K_{jk}$, $U_{jk}$ and $\kappa_{\lvec}$ being real-valued,
this results in the functional equation
\begin{eqn}
\label{eqn:wigner-bec:truncation:fpe}
	\frac{\upd W}{\upd t}
	= \int \upd\xvec \left(
		- \sum_{j=1}^C \frac{\fdelta}{\fdelta \Psi_j} \mathcal{A}_j
		- \sum_{j=1}^C \frac{\fdelta}{\fdelta \Psi_j^*} \mathcal{A}_j^*
		+ \sum_{j=1}^C \sum_{k=1}^C \frac{\fdelta^2}{\fdelta \Psi_j^* \fdelta \Psi_k}
			\mathcal{D}_{jk}
	\right) W,
\end{eqn}
with the drift terms
\begin{eqn}
\label{eqn:wigner-bec:truncation:drift-term}
	\mathcal{A}_j
	={} & -\frac{i}{\hbar} \left(
		\sum_{k=1}^C K_{jk} \Psi_k
		+ \Psi_j \sum_{k=1}^C U_{jk} \left(
			|\Psi_k|^2 - \frac{\delta_{jk} + 1}{2} \delta_{\restbasis_k}(\xvec, \xvec)
		\right)
	\right) \\
	& - \sum_{\lvec \in L} \kappa_{\lvec} \left(
		\frac{\upp O_{\lvec}^*}{\upp \Psi_j^*} O_{\lvec}
		- \frac{1}{2} \sum_{k=1}^C \delta_{\restbasis_k}(\xvec, \xvec)
			\frac{\upp^2 O_{\lvec}^*}{\upp \Psi_j^* \upp \Psi_k^*}
			\frac{\upp O_{\lvec}}{\upp \Psi_k}
	\right),
\end{eqn}
and the diffusion matrix
\begin{eqn}
\label{eqn:wigner-bec:truncation:diffusion-term}
	\mathcal{D}_{jk} = \sum_{\lvec \in L} \kappa_{\lvec}
		\frac{\upp O_{\lvec}}{\upp \Psi_j}
		\frac{\upp O_{\lvec}^*}{\upp \Psi_k^*}.
\end{eqn}

It can be shown (see \appref{fpe-sde} for details) that this truncated equation has a positive-definite diffusion matrix $\mathcal{D}$ and is therefore a Fokker-Planck equation (\abbrev{fpe}), with its solution $W(t)$ being a probability distribution (provided that $W(0)$ was a probability distribution).
This differs from the original Wigner function(al), which can be negative, and is the result of the truncation.
Thus the solution of this equation may not be equivalent to the solution of the orignal master equation~\eqnref{wigner-bec:master-eqn:master-eqn} (if the corresponding density matrices have non-positive Wigner functions), but, given that the truncation conditions are satisfied, the effect is negligible.

Direct solution of the above \abbrev{fpe} is generally impractical, and a Monte Carlo or sampled calculation is called for. The equation can be further transformed to the equivalent set of stochastic differential equations using \thmref{fpe-sde:corr:fpe-sde-func} with
\begin{eqn}
	\mathcal{B}_{j\lvec}
	= \sqrt{\kappa_{\lvec}} \frac{\partial O_{\lvec}^*}{\partial \Psi_j^*}.
\end{eqn}
This results in the set of functional \abbrev{sde}s in It\^{o} form
\begin{eqn}
\label{eqn:fpe-sde:corr-bec:sde}
	\upd\Psi_j = \mathcal{P}_{\restbasis_j} \left[
		\mathcal{A}_j \upd t
		+ \sum_{\lvec \in L} \mathcal{B}_{j\lvec} \upd Q_{\lvec}
	\right],
\end{eqn}
or, alternatively, in Stratonovich form
\begin{eqn}
	\upd\Psi_j = \mathcal{P}_{\restbasis_j} \left[
		(\mathcal{A}_j - \mathcal{S}_j) \upd t
		+ \sum_{\lvec \in L} \mathcal{B}_{j\lvec} \upd Q_{\lvec}
	\right],
\end{eqn}
where the Stratonovich term is
\begin{eqn}
	\mathcal{S}_j
	& = \frac{1}{2} \sum_{k=1}^C \sum_{\lvec \in L}
		\mathcal{B}_{k\lvec}^*
		\frac{\fdelta}{\fdelta \Psi_k^*}
		\mathcal{B}_{j\lvec} \\
	& = \frac{1}{2} \sum_{k=1}^C \sum_{\lvec \in L}
		\delta_{\restbasis_k}(\xvec, \xvec)
		\frac{\upp^2 O_{\lvec}^*}{\upp \Psi_k^* \upp \Psi_j^*}
		\frac{\upp O_{\lvec}}{\upp \Psi_k}.
\end{eqn}
Note that the Stratonovich term is exactly equal to the correction in the loss-induced part of the drift term~\eqnref{wigner-bec:truncation:drift-term}.
This means that in Stratonovich form the \abbrev{sde}s are actually simpler.

The equations~\eqnref{fpe-sde:corr-bec:sde} can be solved by conventional integration methods for \abbrev{sde}s. \todo{reference the numericals appendix?}
The required expectations of symmetrically ordered operator products can be obtained by averaging results from multiple independent solutions according to \thmref{wigner:mc:moments}, since the truncated $W$ function is a probability distribution:
\begin{eqn}
\label{eqn:wigner-bec:fpe-bec:moments}
	\langle \symprod{ \prod_{j=1}^C \Psiop_j^{r_j} (\Psiop_j^\dagger)^{s_j} } \rangle
	& = \int \fdelta^2 \bPsi\,
		\left( \prod_{j=1}^C \Psi_j^{r_j} (\Psi_j^*)^{s_j} \right) W[\bPsi] \\
	& \approx \pathavg{
		\prod_{j=1}^C \Psi_j^{r_j} (\Psi_j^*)^{s_j}
	},
\end{eqn}
where $\{r_j\}$ and $\{s_j\}$ are some sets of non-negative integers.
Naturally, the second approximate equality becomes exact in the limit of the infinite number of integration paths.


% =============================================================================
\subsection{Integral averages}
% =============================================================================

It is interesting to get an expression for time dependence of some simple observables using \abbrev{sde}s~\eqnref{fpe-sde:corr-bec:sde} and It\^{o}'s formula (\thmref{fpe-sde:ito-formula:func-ito-f}).
Namely, we are interested in population $N_i = \int \upd\xvec \langle \Psiop_i^\dagger \Psiop_i \rangle$.

\begin{theorem}
	In a \abbrev{bec} with the evolution governed by the set of \abbrev{sde}s~\eqnref{fpe-sde:corr-bec:sde}, the population changes in time as
	\begin{eqn*}
		\frac{\upd N_i}{\upd t}
		={} & \sum_{\lvec \in L} \kappa_{\lvec} \int \upd\xvec \pathavgleft
			2 \frac{\upp O_{\lvec}^*}{\upp \Psi_i^*} O_{\lvec} \Psi_i^*
				- \sum_{k=1}^C \delta_{\restbasis_k}(\xvec, \xvec)
					\frac{\upp^2 O_{\lvec}^*}{\upp \Psi_i^* \upp \Psi_k^*}
					\frac{\upp O_{\lvec}}{\upp \Psi_k}
					\Psi_i^*
			\right. \\
		& \quad \left.
			+ \frac{\partial O_{\lvec}}{\partial \Psi_i}
				\frac{\partial O_{\lvec}^*}{\partial \Psi_i^*}
				\delta_{\restbasis_i}(\xvec, \xvec)
		\pathavgright.
	\end{eqn*}
\end{theorem}
\begin{proof}
Let us apply \thmref{fpe-sde:ito-formula:func-ito-f} with $f_j \equiv \Psi_j$ to $\mathcal{F} \equiv \Psi_i^* \Psi_i$.
Since in the end we are interested in the average of $\mathcal{F}$, and $\pathavg{ dQ_{\lvec} } \equiv 0$, we can discard the third term in It\^{o} formula.
The resulting expression for the differential is
\begin{eqn}
	\upd (\Psi_i^* \Psi_i)
	={} & \int \upd \xvec^\prime \left(
		\sum_{j=1}^C \mathcal{A}_j^\prime
			\frac{\fdelta (\Psi_i^* \Psi_i)}{\fdelta \Psi_j^\prime}
		+ \sum_{j=1}^C \mathcal{A}_j^{\prime *}
			\frac{\fdelta (\Psi_i^* \Psi_i)}{\fdelta \Psi_j^{\prime *}} \right. \\
	& \quad \left. + \sum_{j=1}^C \sum_{k=1}^C \sum_{\lvec \in L}
			\mathcal{B}_{j\lvec}^\prime \mathcal{B}_{k\lvec}^{\prime *}
			\frac{\fdelta^2 (\Psi_i^* \Psi_i)}{\fdelta \Psi_j^\prime \fdelta \Psi_k^{\prime *}}
		\right) \upd t.
\end{eqn}
The derivatives are evaluated as
\begin{eqn}
	\frac{\fdelta (\Psi_i^* \Psi_i)}{\fdelta \Psi_j^\prime}
	& = \delta_{ij} \Psi_i^* \delta_{\restbasis_i}(\xvec^\prime, \xvec), \\
	\frac{\fdelta (\Psi_i^* \Psi_i)}{\fdelta \Psi_j^{\prime *}}
	& = \delta_{ij} \Psi_i \delta_{\restbasis_i}^*(\xvec^\prime, \xvec), \\
	\frac{\fdelta^2 (\Psi_i^* \Psi_i)}{\fdelta \Psi_j^\prime \fdelta \Psi_k^{\prime *}}
	& = \delta_{ij} \delta_{ik} \delta_{\restbasis_i}(\xvec^\prime, \xvec) \delta_{\restbasis_i}^*(\xvec^\prime, \xvec).
\end{eqn}

From~\eqnref{wigner-bec:fpe-bec:moments} it follows that
\begin{eqn}
	\frac{\upd N_i}{\upd t}
	& = \int \upd \xvec \frac{\upd \langle \Psiop_i^* \Psiop_i \rangle}{\upd t} \\
	& \approx \int \upd \xvec \frac{\upd (
		\pathavg{ \Psi_i^* \Psi_i } - \frac{1}{2} \delta_{\restbasis_i}(\xvec, \xvec)
		)}{\upd t}
	= \int \upd \xvec
		\pathavg{ \frac{\upd (\Psi_i^* \Psi_i)}{\upd t} }.
\end{eqn}
Substituting the expression for the differential of $\Psi_i^* \Psi_i$, we get
\begin{eqn}
	\frac{\upd N_i}{\upd t}
	={} & \iint \upd \xvec\, \upd \xvec^\prime \pathavgleft
		\mathcal{A}_i^\prime
			\Psi_i^* \delta_{\restbasis_i}(\xvec^\prime, \xvec)
		+ \mathcal{A}_i^{\prime *}
			\Psi_i \delta_{\restbasis_i}^*(\xvec^\prime, \xvec) \right. \\
	& \quad + \sum_{\lvec \in L} \left.
			\mathcal{B}_{i\lvec}^\prime \mathcal{B}_{i\lvec}^{\prime *}
			\delta_{\restbasis_i}(\xvec^\prime, \xvec) \delta_{\restbasis_i}^*(\xvec^\prime, \xvec)
		\pathavgright,
\end{eqn}
where we were able to move the integral over $\xvec$ since the drift and diffusion terms depend on $\xvec^\prime$.
Integrating by $\xvec$, and expanding $\Psi_i$ and restricted delta functions:
\begin{eqn}
	\iint \upd\xvec\, \upd\xvec^\prime
		\mathcal{A}_i^\prime \Psi_i^* \delta_{\restbasis_i}(\xvec^\prime, \xvec)
	& = \iint d\xvec d\xvec^\prime \mathcal{A}_i^\prime
		\sum_{\nvec \in \restbasis_i} \phi_{i,\nvec}^* \alpha_{i,\nvec}^*
		\sum_{\mvec \in \restbasis_i} \phi_{i,\mvec} \phi_{i,\mvec}^{\prime *} \\
	& = \int \upd\xvec^\prime \mathcal{A}_i^\prime
		\sum_{\mvec \in \restbasis_i} \alpha_{i,\nvec}^* \phi_{i,\nvec}^{\prime *} \\
	& = \int \upd\xvec \mathcal{A}_i \Psi_i^*.
\end{eqn}
Similarly,
\begin{eqn}
	\iint \upd\xvec\, \upd\xvec^\prime
		\mathcal{A}_i^{\prime *} \Psi_i \delta_{\restbasis_i}^*(\xvec^\prime, \xvec)
	= \int \upd\xvec \mathcal{A}_i^* \Psi_i,
\end{eqn}
and
\begin{eqn}
	\iint \upd\xvec\, \upd\xvec^\prime
		\mathcal{B}_{i\lvec}^\prime \mathcal{B}_{i\lvec}^{\prime *}
		\delta_{\restbasis_i}(\xvec^\prime, \xvec) \delta_{\restbasis_i}^*(\xvec^\prime, \xvec)
	= \int \upd\xvec \mathcal{B}_{i\lvec} \mathcal{B}_{i\lvec}^*
		\delta_{\restbasis_i}(\xvec, \xvec).
\end{eqn}
The integration thus gives us
\begin{eqn}
	\frac{\upd N_i}{\upd t}
	= \int \upd\xvec \pathavgleft
		\mathcal{A}_i \Psi_i^*
		+ \mathcal{A}_i^* \Psi_i
		+ \sum_{\lvec \in L} \mathcal{B}_{i\lvec} \mathcal{B}_{i\lvec}^*
			\delta_{\restbasis_i}(\xvec, \xvec)
	\pathavgright.
\end{eqn}

Now we can substitute known expressions for drift terms~\eqnref{wigner-bec:truncation:drift-term} and diffusion terms~\eqnref{wigner-bec:truncation:diffusion-term}.
From the form of the expression above it is clear that the unitary evolution part of the drift term does not contribute to the population change rate (which agrees with the intuition).
Thus the drift terms can be safely simplified to
\begin{eqn}
	\mathcal{A}_i^{\mathrm{(loss)}}
	= - \sum_{\lvec \in L} \kappa_{\lvec} \left(
		\frac{\upp O_{\lvec}^*}{\upp \Psi_i^*} O_{\lvec}
		- \frac{1}{2} \sum_{k=1}^C \delta_{\restbasis_k}(\xvec, \xvec)
			\frac{\upp^2 O_{\lvec}^*}{\upp \Psi_i^* \upp \Psi_k^*}
			\frac{\upp O_{\lvec}}{\upp \Psi_k}
		\right),
\end{eqn}
which gives the population change rate
\begin{eqn}
	\frac{\upd N_i}{\upd t}
	={} & \sum_{\lvec \in L} \kappa_{\lvec} \int \upd\xvec \pathavgleft
		2 \frac{\upp O_{\lvec}^*}{\upp \Psi_i^*} O_{\lvec} \Psi_i^*
			- \sum_{k=1}^C \delta_{\restbasis_k}(\xvec, \xvec)
				\frac{\upp^2 O_{\lvec}^*}{\upp \Psi_i^* \upp \Psi_k^*}
				\frac{\upp O_{\lvec}}{\upp \Psi_k}
				\Psi_i^*
		\right. \\
	& \quad \left.
		+ \frac{\partial O_{\lvec}}{\partial \Psi_i}
			\frac{\partial O_{\lvec}^*}{\partial \Psi_i^*}
			\delta_{\restbasis_i}(\xvec, \xvec)
	\pathavgright,
\end{eqn}
where we have used the fact that $O_{\lvec}$ are products of integer powers of $\Psi_j$, which makes $\mathcal{A}_i^{\mathrm{(loss)}} \Psi_j^* \equiv (\mathcal{A}_i^{\mathrm{(loss)}})^* \Psi_j$.
\end{proof}

\todo{It should be possible to proof that this formula agrees with the classical one up to the $1/N$ order, same as we do for particular cases later or in the theoretical paper.}

In practice, it is more convenient to use the above equation using more intuitive quantities, namely real component densities $n_i = \langle \Psiop_i^\dagger \Psiop_i \rangle$.
To do that, we have to rewrite the resulting path averages of the moments of $\Psi_j$ as averages of symmetric products of $\Psiop_j$, transform them to the normal order using the analogue of the ordering transformation formula~\cite{Cahill1969} for field operators
\begin{eqn}
	\symprod{
		(\Psiop_j^\dagger)^r \Psiop_j^s
	}
	= \sum_{k=0}^{\min(r,s)} \frac{k!}{2^{k}} \binom{r}{k} \binom{s}{k}
		(\Psiop^\dagger)^{r-k} \Psiop^{s-k} \delta_{\restbasis_j}^k,
\end{eqn}
and simplify the resulting averages of normally ordered operators using correlation factors $g^{(k)} = \langle (\Psiop^\dagger)^k \Psiop^k \rangle / \langle \Psiop^\dagger \Psiop \rangle$.
In other words, coefficients $g^{(k)}$ define the degree of high-order correlations.
In the ideal condensate they are equal to $1$, and increase with the temperature (the so called photon bunching, or atom bunching).
For example, the theoretical maximum value for $g_{111}$ is $3!=6$~\cite{Kagan1985}, which has been confirmed experimentally~\cite{Burt1997}.
