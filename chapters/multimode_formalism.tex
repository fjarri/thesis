\chapter{Multimode field operators formalism}
\label{cha:appendix:multimode-formalism}


% =============================================================================
\section{Single-mode operators}
% =============================================================================

We start from the set of single-mode operators $\hat{a}_j$, which obey bosonic commutation relations:
\begin{equation}
\label{eqn:multimode-formalism:single-mode-commutators}
\begin{split}
	[ \hat{a}_j, \hat{a}_k ] & = [ \hat{a}_j^\dagger, \hat{a}_k^\dagger ] = 0, \\
	[ \hat{a}_j, \hat{a}_k^\dagger ] & = \delta_{jk}.
\end{split}
\end{equation}

In order to work with the moments of multimode operators we will need the equations for commutators of arbitrary single-mode operator products $[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_k}^\dagger ]$ and $[ \hat{a}_n^\dagger, \hat{a}_{m_1} \ldots \hat{a}_{m_k} ]$.
Let us find the expression for the first commutator by induction.
Providing that we know the expression for $[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger ]$,
commutator of order $k$ can be expanded as:
\[
	[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_k}^\dagger ]
	= (1 - \delta_{n m_k})
		[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger ] \hat{a}_{m_k}
	+ \delta_{n m_k} (
		\hat{a}_n \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger \hat{a}_n^\dagger
		- \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger \hat{a}_n^\dagger \hat{a}_n
	)
	= (*).
\]
Here we have split the initial commutator into two possible outcomes, depending on whether $n = m_k$.
First term, corresponding to $n \ne m_k$, contains the known commutator of lower order.
In the second term we have substituted $\hat{a}_n$ for $\hat{a}_{m_k}$,
since the delta function outside the parentheses ensures that $n = m_k$.
Swapping $\hat{a}_n^\dagger$ and $\hat{a}_n$ in the last term and, again, recognising the known commutator:
\begin{equation*}
\begin{split}
	(*)
	& = (1 - \delta_{n m_k})
		[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger ] \hat{a}_{m_k}
	+ \delta_{n m_k} (
		[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger ] \hat{a}_n^\dagger
		+ \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger
	) \\
	& = [ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger ] \hat{a}_{m_k}
	+ \delta_{n m_k} \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_{k-1}}^\dagger.
\end{split}
\end{equation*}
Now, starting from the first-order relation $[ \hat{a}_n, \hat{a}_{m_1}^\dagger ] = \delta_{n m_1}$, we can obtain the relation for any order:
\begin{equation*}
\begin{split}
	[ \hat{a}_n, \hat{a}_{m_1}^\dagger \hat{a}_{m_2}^\dagger ]
	& = \delta_{n m_1} \hat{a}_{m_2}^\dagger + \delta_{n m_2} \hat{a}_{m_1}^\dagger, \\
	[ \hat{a}_n, \hat{a}_{m_1}^\dagger \hat{a}_{m_2}^\dagger \hat{a}_{m_3}^\dagger ]
	& = \delta_{n m_1} \hat{a}_{m_2}^\dagger \hat{a}_{m_3}^\dagger
	+ \delta_{n m_2} \hat{a}_{m_1}^\dagger \hat{a}_{m_3}^\dagger
	+ \delta_{n m_3} \hat{a}_{m_1}^\dagger \hat{a}_{m_2}^\dagger, \\
	& \ldots
\end{split}
\end{equation*}
or, in generalised form:
\begin{equation}
\label{eqn:multimode-formalism:single-mode-high-order-commutators}
	[ \hat{a}_n, \hat{a}_{m_1}^\dagger \ldots \hat{a}_{m_k}^\dagger ]
	= \sum\limits_{i=1}^k \delta_{n m_i}
		\prod\limits_{j=1,j \ne i}^k \hat{a}_{m_j}^\dagger.
\end{equation}
Note that if $n = m_1 = \ldots = m_k$, this boils down to the well-known relation from~\cite{Louisell1990}:
\[
	[ \hat{a}, (\hat{a}^\dagger)^k ] = k (\hat{a}^\dagger)^{k-1}.
\]
The general form for the second commutator can be found using the exact same procedure:
\begin{equation}
	[ \hat{a}_n^\dagger, \hat{a}_{m_1} \ldots \hat{a}_{m_k} ]
	= - \sum\limits_{i=1}^k \delta_{n m_i}
		\prod\limits_{j=1,j \ne i}^k \hat{a}_{m_j}.
\end{equation}


% =============================================================================
\section{Restricted basis field}
% =============================================================================

Multimode fields are described by operators $\Psiop_j^{\dagger}(\xvec)$ and $\Psiop_j(\xvec)$,
where $\Psiop_j^{\dagger}(\xvec)$ creates a bosonic atom of spin $j$ at location $\xvec$,
and $\Psiop_j(\xvec)$ destroys one;
the commutators are
\begin{equation}
\label{eqn:multimode-formalism:multimode-commutators}
	[ \Psiop_j(\xvec), \Psiop_k^{\dagger}(\xvec^\prime) ]
	= \delta_{jk} \delta(\xvec-\xvec^\prime).
\end{equation}
Field operators can be decomposed using a single-particle basis \todo{explanation needed?}:
\[
	\Psiop_j(\xvec) = \sum\limits_{\nvec} \phi_{\nvec}(\xvec) \hat{a}_{j,\nvec},
\]
where $\phi_{\nvec}$ is some orthonormal basis,
$\nvec$ is a state vector with $D$ elements.
Single mode operators $\hat{a}_{j,\nvec}$ obey commutation relations \eqnref{multimode-formalism:single-mode-commutators},
the pair $j,\nvec$ serving as a mode identifier.
Orthonormality condition for basis functions is
\[
	\int\limits_A \phi_{\nvec}^*(\xvec) \phi_{\mvec}(\xvec) d\xvec = \delta_{\nvec\mvec},
\]
where the exact nature of integration area $A$ depends on the basis set.
Hereinafter we assume that the integration is always performed over $A$.

Now suppose we want to consider only modes from some subset $L$.
Corresponding projection operator can be written as
\[
	P \equiv \sum\limits_{\nvec \in L} \lvert \nvec \rangle \langle \nvec \rvert,
\]
Or, in coordinate form:
\[
	P [f(\xvec)]
	= \sum\limits_{\nvec \in L} \phi_{\nvec} (\xvec) \int
		d\xvec^\prime\, \phi_{\nvec}^*(\xvec^\prime) f(\xvec^\prime).
\]
Being applied to the field operator $\Psiop_j$, this operator returns the restricted field operator
\[
	P [\Psiop_j]
	= \sum\limits_{\nvec \in L} \phi_{\nvec} (\xvec) \hat{a}_{j,\nvec}
	= \Psiop_{jP} (\xvec),
\]
containing only modes from subset $L$.
If $L$ is the whole mode space, then obviously $P \equiv \mathds{1}$.
In order to simplify equations, we will consider all field operators in this chapter to be restricted and omit the index $P$.

Because of the restricted nature of the operator, commutation relations~\eqnref{multimode-formalism:multimode-commutators} no longer apply.
The following ones should be used instead:
\begin{equation}
\label{eqn:multimode-formalism:restricted-commutators}
\begin{split}
	\left[ \Psiop_j(\xvec), \Psiop_k(\xvec^\prime) \right]
	& = \left[ \Psiop_j^\dagger(\xvec), \Psiop_k^\dagger(\xvec^\prime) \right] = 0, \\
	\left[ \Psiop_j(\xvec), \Psiop_k^\dagger(\xvec^\prime) \right]
	& = \delta_{jk} \delta_P(\xvec - \xvec^\prime),
\end{split}
\end{equation}
where the restricted delta function $\delta_P$ is defined as
\begin{equation}
\label{eqn:multimode-formalism:restricted-delta}
	\delta_P(\xvec - \xvec^\prime)
	= \sum\limits_{\nvec \in L} \phi_{\nvec}^* (\xvec) \phi_{\nvec} (\xvec^\prime).
\end{equation}
Note that conjugation operator swaps variables in $\delta_P$: $\delta_P^*(\xvec - \xvec^\prime) = \delta_P(\xvec^\prime - \xvec)$.

Restricted delta function can be used to rewrite equation for projection operator $P$:
\[
	P [f(\xvec)] = \int d\xvec^\prime \delta_P(\xvec^\prime - \xvec) f(\xvec^\prime).
\]
The Hermitian conjugate of $P$ is thus defined as
\[
	(P [f(\xvec)])^\dagger
	= \int d\xvec^\prime \delta_P^*(\xvec^\prime - \xvec) f^\dagger(\xvec^\prime)
	= P^\dagger [f^\dagger(\xvec)].
\]


% =============================================================================
\section{High order multimode commutators}
% =============================================================================

Let us find the expression for high-order commutators of restricted field operators, analogous to equation~\eqnref{multimode-formalism:single-mode-high-order-commutators} for single-mode operators.
It can be done using the similar recursive procedure.
Given that we know the expression for $\left[ \Psiop, ( \Psiop^{\prime\dagger} )^{l-1} \right]$,
the commutator of higher order can be expanded as
\begin{equation*}
\begin{split}
	\left[ \Psiop, ( \Psiop^{\prime\dagger} )^l \right]
	& = \Psiop ( \Psiop^{\prime\dagger} )^l - ( \Psiop^{\prime\dagger} )^l \Psiop \\
	& = (
		\delta_P (\xvec - \xvec^\prime) + \Psiop^{\prime\dagger} \Psiop
	) ( \Psiop^{\prime\dagger} )^{l-1}
	- ( \Psiop^{\prime\dagger} )^l \Psiop \\
	& = \delta_P (\xvec - \xvec^\prime) ( \Psiop^{\prime\dagger} )^{l-1}
	+ \Psiop^{\prime\dagger} (
		\Psiop ( \Psiop^{\prime\dagger} )^{l-1}
		- ( \Psiop^{\prime\dagger} )^{l-1} \Psiop
	) \\
	& = \delta_P (\xvec - \xvec^\prime) ( \Psiop^{\prime\dagger} )^{l-1}
	+ \Psiop^{\prime\dagger} [
		\Psiop, ( \Psiop^{\prime\dagger} )^{l-1}
	].
\end{split}
\end{equation*}
Now we can get the commutator of any order starting from the known relation~\eqnref{multimode-formalism:restricted-commutators}:
\[
	\left[ \Psiop, ( \Psiop^{\prime\dagger} )^l \right]
	= l \delta_P (\xvec - \xvec^\prime) ( \Psiop^{\prime\dagger} )^{l-1}.
\]
Accompanying conjugated relation:
\[
	\left[ \Psiop^\dagger, ( \Psiop^\prime )^l \right]
	= - l \delta_P^* (\xvec - \xvec^\prime) ( \Psiop^\prime )^{l-1}.
\]

A further generalisation of these relations is
\begin{equation}
\label{eqn:multimode-formalism:functional-commutators}
\begin{split}
	\left[ \Psiop, f( \Psiop^\prime, \Psiop^{\prime\dagger} ) \right]
	& = \delta_P (\xvec - \xvec^\prime) \frac{\partial f}{\partial \Psiop^{\prime\dagger}} \\
	\left[ \Psiop^\dagger, f( \Psiop^\prime, \Psiop^{\prime\dagger} ) \right]
	& = -\delta_P^* (\xvec - \xvec^\prime) \frac{\partial f}{\partial \Psiop^\prime},
\end{split}
\end{equation}
where $f(x, y)$ is a function that can be expanded in the power series of $x$ and $y$.
Let us prove the first relation; the procedure for the second one is the same.
Without loss of generality, we can assume that $f(\Psiop^\prime, \Psiop^{\prime\dagger})$ can be expanded in power series of normally ordered operators (otherwise we can just use commutation relations).
Thus
\begin{equation*}
\begin{split}
	\left[ \Psiop, f( \Psiop^\prime, \Psiop^{\prime\dagger} ) \right]
	& = \sum\limits_{r,s} f_{rs} [ \Psiop, (\Psiop^{\prime\dagger})^r (\Psiop^\prime)^s ] \\
	& = \sum\limits_{r,s} f_{rs} [ \Psiop, (\Psiop^{\prime\dagger})^r ] (\Psiop^\prime)^s \\
	& = \sum\limits_{r,s} f_{rs} r \delta_P(\xvec - \xvec^\prime)
		(\Psiop^{\prime\dagger})^{r-1} (\Psiop^\prime)^s \\
	& = \delta_P (\xvec - \xvec^\prime) \frac{\partial f}{\partial \Psiop^{\prime\dagger}}.
\end{split}
\end{equation*}


% =============================================================================
\section{Single-mode Wigner representation}
% =============================================================================

Phase-space treatment of multimode problems can be simplified by working with multimode field operators instead of single-mode operators~\cite{Steel1998,Norrie2006a}.
Since distributions are initially defined in terms of single-mode operators, some preparations are necessary.

Formally, a function of complex variable has to be holomorphic in order to be complex differentiable.
In many cases it is enough to have less strict ``physicists'\,'' complex differentiation rule.
If complex variable $z = x + iy$ and function $f(z) = u(x, y) + iv(x, y)$ then
\[
	\left( \frac{df(z)}{dz} \right)_{phys}
	= \frac{1}{2} \left(
		\frac{\partial f}{\partial x} - i \frac{\partial f}{\partial y}
	\right).
\]

\begin{lemma}
If $f(z)$ is holomorphic, then ``physicists'\,'' differentiation is equivalent to the formal one.
\end{lemma}
\begin{proof}
If $f(z)$ is holomorphic, Cauchy-Riemann equations $\partial u / \partial x = \partial v / \partial y$ and $\partial u / \partial y = -\partial v / \partial x$ are satisfied.
Thus
\begin{equation*}
\begin{split}
	\left( \frac{df(z)}{dz} \right)_{phys}
	= \frac{1}{2} \left(
		\frac{\partial f}{\partial x} - i \frac{\partial f}{\partial y}
	\right)
	= \frac{1}{2} \left(
		\frac{\partial u}{\partial x} + \frac{\partial v}{\partial y}
	\right)
	+ \frac{i}{2} \left(
		\frac{\partial v}{\partial x} - \frac{\partial u}{\partial y}
	\right)
	= \frac{\partial u}{\partial x} + i \frac{\partial v}{\partial x}.
\end{split}
\end{equation*}
The last expression being one of the forms of derivative for holomorphic functions.
\end{proof}

\begin{lemma}
(obvious) For any ``good'' (even non-holomorphic) $f(z)$, ``physicists'\,'' differentiation obeys sum, product, quotient, and chain differentiation rules.
\end{lemma}

Hereinafter we will use ``physicists'\,'' differentiation unless explicitly stated otherwise,
because some important functions we will encounter are not holomorphic.
This differentiation has all intuitively assumed properties, along with some not quite obvious ones.

\begin{lemma}
For any nonnegative integers $a$ and $b$.
\[
	\frac{d}{dz} (z^a (z^*)^b) = a z^{a-1} (z^*)^b,
	\quad
	\frac{d}{dz^*} (z^a (z^*)^b) = b z^a (z^*)^{b-1},
\]
\end{lemma}
\begin{proof}
Let us assume that the statement of the lemma is valid for some $a$ and $b$, then using chain rule
\[
	\frac{d}{dz} (z^{a+1} (z^*)^b)
	= \frac{d}{dz} (z z^a (z^*)^b)
	= z^a (z^*)^b + z \frac{d}{dz} (z^a (z^*)^b)
	= z^a (z^*)^b + a z z^{a-1} (z^*)^b
	= (a + 1) z^a (z^*)^b.
\]
The part for $d/dz^*$ can is proved in the same way.
One can easily prove (by transition to real values) that $d(z z^*)/dz = z^*$ and $d(z z^*)/dz^* = z$.
By induction, the statement is true for any natural $a$ and $b$,
and it is obviously true if $a = 0$ or $b = 0$, which proves the lemma.
\todo{This can be proved for any real $a$ and $b$, if necessary.}
\end{proof}

This is straightforwardly followed by
\begin{lemma}
If $f(z)$ can be expanded into series of $z^n (z^*)^m$, $df(z)/dz$ can be treated as partial differentiation of the function of two independent variables $z$ and $z^*$.
In other words:
\[
	\frac{d}{dz} f(z) \equiv \frac{\partial}{\partial z} f(z, z^*),
	\quad
	\frac{d}{dz^*} f(z) \equiv \frac{\partial}{\partial z^*} f(z, z^*).
\]
\end{lemma}

Now we can prove the lemma which will help us deal with some integrals.
\begin{lemma}
\label{lmm:multimode-formalism:fourier-of-moments}
If $\alpha$ and $\lambda$ are complex variables and $\int d^2\alpha$ stands for the integral over the complex plane, then for any non-negative integers $r$ and $s$:
\[
	\int d^2\alpha\, \alpha^r (\alpha^*)^s \exp(-\lambda \alpha^* + \lambda^* \alpha)
	= \pi^2
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\delta(\Real \lambda) \delta(\Imag \lambda)
\]
\end{lemma}
\begin{proof}
First, changing the variables in the integrals and using known Fourier transform relations, we can prove that for real $x$ and $v$, and non-negative integer $n$
\[
	\int\limits_{-\infty}^{\infty} dx\, x^n \exp(2 i x v) = \pi (-i / 2)^n \delta^{(n)}(v),
\]
\[
	\int\limits_{-\infty}^{\infty} dx\, x^n \exp(-2 i x v) = \pi (i / 2)^n \delta^{(n)}(v).
\]
Note that we have explicitly written integration limits here;
they are swapped when we change the variable in the first integral.

Denoting $\alpha = x + iy$ and $\lambda = u + iv$, we can expand the initial expression as
\begin{equation*}
\begin{split}
	\int d^2\alpha\, \alpha^r (\alpha^*)^s \exp(-\lambda \alpha^* + \lambda^* \alpha)
	& = \int dx dy \exp(2ixv - 2iyu)
		\sum\limits_{l=0}^r \binom{r}{l} x^l (iy)^{r-l}
		\sum\limits_{m=0}^s \binom{s}{m} x^m (-iy)^{s-m} \\
	& = \sum\limits_{l=0}^r \sum\limits_{m=0}^s \binom{r}{l} \binom{s}{m}
		i^{r-l} (-i)^{s-m}
		\int dx\, x^{l+m} \exp(2ixv)
		\int dy\, y^{r-l+s-m} \exp(-2iyu) \\
	& = \pi^2 \sum\limits_{l=0}^r \sum\limits_{m=0}^s \binom{r}{l} \binom{s}{m}
		i^{r-l} (-i)^{s-m}
		(-i/2)^{l+m} \delta^{(l+m)}(v)
		(i/2)^{r-l+s-m} \delta^{(r-l+s-m)}(u) \\
	& = \pi^2
		\sum\limits_{l=0}^r \binom{r}{l}
			\frac{1}{2^r}
			(-i \partial / \partial v)^l
			(-\partial / \partial u)^{r-l}
		\sum\limits_{m=0}^s \binom{s}{m}
			\frac{1}{2^s}
			(-i \partial / \partial v)^m
			(\partial / \partial u)^{s-m}
		\delta(v) \delta(u) \\
	& = \pi^2
		\left( \frac{1}{2} (-i \partial / \partial v - \partial / \partial u) \right)^r
		\left( \frac{1}{2} (-i \partial / \partial v + \partial / \partial u) \right)^s
		\delta(v) \delta(u) \\
	& = \pi^2
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\delta(\Real \lambda) \delta(\Imag \lambda).
		\qedhere
\end{split}
\end{equation*}
\end{proof}

A notable special case of \lmmref{multimode-formalism:fourier-of-moments} is
\[
	\int d^2\alpha \exp(-\lambda \alpha^* + \lambda^* \alpha)
	= \pi^2 \delta(\Real \lambda) \delta(\Imag \lambda).
\]

We will need the displacement operator which was first introduced by Weyl~\cite{Weyl1950}:
\[
	\hat{D}(\lambda, \lambda^*) = \exp(\lambda \hat{a}^\dagger - \lambda^* \hat{a}).
\]
Using Baker-Hausdorff theorem to split non-commuting operators in the exponent,
one can find that
\begin{equation}
\label{eqn:multimode-formalism:displacement-derivatives}
\begin{split}
	\frac{\partial}{\partial \lambda} \hat{D}(\lambda, \lambda^*)
	& = \hat{D}(\lambda, \lambda^*) (\hat{a}^\dagger + \frac{1}{2} \lambda^*)
	= (\hat{a}^\dagger - \frac{1}{2} \lambda^*) \hat{D}(\lambda, \lambda^*), \\
	-\frac{\partial}{\partial \lambda^*} \hat{D}(\lambda, \lambda^*)
	& = \hat{D}(\lambda, \lambda^*) (\hat{a} + \frac{1}{2} \lambda)
	= (\hat{a} - \frac{1}{2} \lambda) \hat{D}(\lambda, \lambda^*).
\end{split}
\end{equation}
Single-mode characteristic function for Wigner representation is defined as
\[
	\chi_W (\lambda, \lambda^*)
	= \Trace{ \hat{\rho} \hat{D}(\lambda, \lambda^*) },
\]
and the Wigner function itself is
\begin{equation}
\label{eqn:multimode-formalism:single-mode-wigner}
	W (\alpha, \alpha^*)
	= \frac{1}{\pi^2} \int d^2 \lambda \exp(-\lambda \alpha^* + \lambda^* \alpha)
		\chi_W (\lambda, \lambda^*).
\end{equation}
For future purposes it is convenient to also define Wigner transformation \todo{probably, Weyl transformation goes here too}
\[
	\mathcal{W}[\hat{A}]
	= \frac{1}{\pi^2} \int d^2 \lambda \exp(-\lambda \alpha^* + \lambda^* \alpha)
		\Trace{ \hat{A} \hat{D}(\lambda, \lambda^*) }.
\]
Thus Wigner function is a result of Wigner transformation of a density matrix: $W(\alpha, \alpha^*) = \mathcal{W}[\hat{\rho}]$.

\begin{lemma}
\label{lmm:multimode-formalism:moments-from-chi}
\[
	\langle \symprod{ \hat{a}^r (\hat{a}^\dagger)^s } \rangle
	= \left.
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\chi_W (\lambda, \lambda^*)
	\right|_{\lambda=0}.
\]
\end{lemma}
\begin{proof}
The exponent in the $\chi_W$ can be expanded as
\[
	\exp (\lambda \hat{a}^\dagger - \lambda^* \hat{a})
	= \sum\limits_{r,s}
		\frac{(-\lambda^*)^r \lambda^s}{r!s!}
		\symprod{ \hat{a}^r (\hat{a}^\dagger)^s }.
\]
Thus
\[
	\chi_W(\lambda, \lambda^*)
	= \sum\limits_{r,s}
		\frac{(-\lambda^*)^r \lambda^s}{r!s!}
		\Trace{
			\hat{\rho} \symprod{ \hat{a}^r (\hat{a}^\dagger)^s }
		}
	= \sum\limits_{r,s}
		\frac{(-\lambda^*)^r \lambda^s}{r!s!}
		\langle \symprod{ \hat{a}^r (\hat{a}^\dagger)^s } \rangle
\]
Apparently, the application of $(\partial / \partial \lambda)^s$ and $(-\partial / \partial \lambda^*)^r$ will eliminate all lower order moments,
and setting $\lambda = 0$ afterwards will eliminate all higher order moments,
leaving only $\symprod{ \hat{a}^r (\hat{a}^\dagger)^s }$:
\[
	\left.
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\chi_W (\lambda, \lambda^*)
	\right|_{\lambda=0}
	= r! s! \frac{1}{r! s!}
		\langle \symprod{ \hat{a}^r (\hat{a}^\dagger)^s } \rangle
	= \langle \symprod{ \hat{a}^r (\hat{a}^\dagger)^s } \rangle.
	\qedhere
\]
\end{proof}

In order to connect Wigner function and operator moments, we will need the following lemma:
\begin{lemma}
\label{lmm:multimode-formalism:zero-integrals}
For any non-negative $r$, $s$:
\begin{equation*}
\begin{split}
	\int d^2\alpha \int d^2\lambda
		\frac{\partial}{\partial \lambda} \left(
			\alpha^r (\alpha^*)^s \exp(-\lambda \alpha^* + \lambda^* \alpha) \chi_W (\lambda, \lambda^*)
		\right)
	& = 0 \\
	\int d^2\alpha \int d^2\lambda
		\frac{\partial}{\partial \lambda^*} \left(
			\alpha^r (\alpha^*)^s \exp(-\lambda \alpha^* + \lambda^* \alpha) \chi_W (\lambda, \lambda^*)
		\right)
	& = 0.
\end{split}
\end{equation*}
\end{lemma}
\begin{proof}
We will prove the first equation; the second one is proved in the same way.
First, note that complex-valued integral of derivative is evaluated as
\begin{equation*}
\begin{split}
	\int d^2\lambda \frac{\partial}{\partial \lambda} f(\lambda, \lambda^*)
	& = \frac{1}{2} \int\limits_{-\infty}^{\infty} dx \int\limits_{-\infty}^{\infty} dy
		\left( \frac{\partial}{\partial x} - i \frac{\partial}{\partial y} \right)
		f(x, y) \\
	& = \frac{1}{2} \int\limits_{-\infty}^{\infty} dy \int\limits_{-\infty}^{\infty} dx
			\frac{\partial}{\partial x} f(x, y)
		- \frac{i}{2} \int\limits_{-\infty}^{\infty} dx \int\limits_{-\infty}^{\infty} dy
			\frac{\partial}{\partial y} f(x, y) \\
	& =	\frac{1}{2} \int\limits_{-\infty}^{\infty} dy \left(
			\left. f(x, y) \right|_{x=-\infty}^{\infty}
		\right)
		- \frac{i}{2} \int\limits_{-\infty}^{\infty} dx \left(
			\left. f(x, y) \right|_{y=-\infty}^{\infty}
		\right),
\end{split}
\end{equation*}
where we expanded $\lambda = x + iy$.
Evaluating integral over $\alpha$ using \lmmref{multimode-formalism:fourier-of-moments}:
\begin{equation*}
\begin{split}
	\int d^2\alpha \int d^2\lambda
		\frac{\partial}{\partial \lambda} \left(
			\alpha^r (\alpha^*)^s \exp(-\lambda \alpha^* + \lambda^* \alpha) \chi_W (\lambda, \lambda^*)
		\right)
	& = \pi^2 \int d^2\lambda
		\frac{\partial}{\partial \lambda} \left(
			\chi_W (\lambda, \lambda^*)
			\left( -\frac{\partial}{\partial \lambda^*} \right)^r
			\left( \frac{\partial}{\partial \lambda} \right)^s
			\delta(\Real \lambda) \delta(\Imag \lambda)
		\right) \\
	& = \frac{\pi^2}{2} \int\limits_{-\infty}^{\infty} dy \left(
		\left.
			\chi_W (x, y)
			\left( -\frac{\partial}{\partial \lambda^*} \right)^r
			\left( \frac{\partial}{\partial \lambda} \right)^s
			\delta(x) \delta(y)
		\right|_{x=-\infty}^{\infty}
	\right) \\
	& - \frac{i\pi^2}{2} \int\limits_{-\infty}^{\infty} dx \left(
		\left.
			\chi_W (x, y)
			\left( -\frac{\partial}{\partial \lambda^*} \right)^r
			\left( \frac{\partial}{\partial \lambda} \right)^s
			\delta(x) \delta(y)
		\right|_{y=-\infty}^{\infty}
	\right) \\
	& = 0
\end{split}
\end{equation*}
since $\chi_W$ is bounded~\cite{Gardiner2004},
and any finite derivative of delta-function is zero on the infinity.
\end{proof}

Now we can get the final relation.
\begin{theorem}
\label{thm:multimode-formalism:single-mode-wigner-moments}
\[
	\int d^2\alpha\, \alpha^r (\alpha^*)^s W(\alpha, \alpha^*)
	= \langle \symprod{ \hat{a}^r (\hat{a}^\dagger)^s } \rangle
\]
\end{theorem}
\begin{proof}
Integrating the expression to the left by parts and eliminating terms which fit \lmmref{multimode-formalism:zero-integrals}, we find that
\begin{equation*}
\begin{split}
	\int d^2\alpha\, \alpha^r (\alpha^*)^s W(\alpha, \alpha^*)
	& = \frac{1}{\pi^2} \int d^2\alpha \int d^2\lambda
		\exp(-\lambda \alpha^* + \lambda^* \alpha)
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\chi_W (\lambda, \lambda^*) \\
	& = \int d^2\lambda\,
		\delta (\Real \lambda) \delta (\Imag \lambda)
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\chi_W (\lambda, \lambda^*) \\
	& = \left.
		\left( \frac{\partial}{\partial \lambda} \right)^s
		\left( -\frac{\partial}{\partial \lambda^*} \right)^r
		\chi_W (\lambda, \lambda^*)
	\right|_{\lambda=0},
\end{split}
\end{equation*}
where we used \lmmref{multimode-formalism:fourier-of-moments} to evaluate integral over $\alpha$.
Now, recognising the final expression as a part of \lmmref{multimode-formalism:moments-from-chi},
we immideately get the statement of the theorem.
\end{proof}

% =============================================================================
\section{Multimode Wigner representation}
% =============================================================================

Single-mode definition~\eqnref{multimode-formalism:single-mode-wigner} of Wigner representation can be extended to the case of many modes.
Let $\bm{\lambda}$ and $\bm{\alpha}$ be vectors of $\lambda_n$ and $\alpha_n$ values respectively,
with $n = 1 \ldots N$.
Then the definitions of multimode characteristic function and Wigner function are
\[
	\chi_W (\bm{\lambda}, \bm{\lambda}^*)
	= \Trace{ \hat{\rho} \exp \sum\limits_n
		(\lambda_n \hat{a}_n^\dagger - \lambda_n^* \hat{a}_n) },
\]
\begin{equation}
\label{eqn:multimode-formalism:multimode-wigner}
	W (\bm{\alpha}, \bm{\alpha}^*)
	= \frac{1}{\pi^{2N}} \int d^2 \lambda_1 \ldots \int d^2 \lambda_N
		\left(
			\exp \sum\limits_n (-\lambda_n \alpha_n^* + \lambda_n^* \alpha_n)
		\right)
		\chi_W (\bm{\lambda}, \bm{\lambda}^*).
\end{equation}

\begin{lemma}[Multimode extension of~\lmmref{multimode-formalism:moments-from-chi}]
\label{lmm:multimode-formalism:multimode-moments-from-chi}
\[
	\langle \symprod{ \prod\limits_n \hat{a}_n^{r_n} (\hat{a}_n^\dagger)^{s_n} } \rangle
	= \left.
		\left(
			\prod\limits_n
			\left( \frac{\partial}{\partial \lambda_n} \right)^{s_n}
			\left( -\frac{\partial}{\partial \lambda_n^*} \right)^{r_n}
		\right)
		\chi_W (\bm{\lambda}, \bm{\lambda}^*)
	\right|_{\bm{\lambda}=0}.
\]
\end{lemma}
\begin{proof}
Mode operators with different indices commute, so
\begin{equation*}
\begin{split}
	\chi_W (\bm{\lambda}, \bm{\lambda}^*)
	& = \Trace{
		\hat{\rho}
		\prod\limits_n
			\exp( \lambda_n \hat{a}_n^\dagger - \lambda_n^* \hat{a}_n)
	} \\
	& = \Trace{
		\hat{\rho}
		\prod\limits_n \sum\limits_{r_n, s_n}
			\frac{(-\lambda_n^*)^{r_n} \lambda_n^{s_n}}{r_n! s_n!}
			\symprod{ \hat{a}_n^{r_n} (\hat{a}_n^\dagger)^{s_n}}
	} \\
	& = \Trace{
		\hat{\rho}
		\sum\limits_{r_1, s_1, \ldots, r_N, s_N} \prod\limits_n
			\frac{(-\lambda_n^*)^{r_n} \lambda_n^{s_n}}{r_n! s_n!}
			\symprod{ \hat{a}_n^{r_n} (\hat{a}_n^\dagger)^{s_n}}
	} \\
	& = \Trace{
		\sum\limits_{r_1, s_1, \ldots, r_N, s_N}
			\left(
				\prod\limits_n \frac{(-\lambda_n^*)^{r_n} \lambda_n^{s_n}}{r_n! s_n!}
			\right)
			\hat{\rho}
			\symprod{ \prod\limits_n \hat{a}_n^{r_n} (\hat{a}_n^\dagger)^{s_n}}
	} \\
	& = \sum\limits_{r_1, s_1, \ldots, r_N, s_N}
		\left(
			\prod\limits_n \frac{(-\lambda_n^*)^{r_n} \lambda_n^{s_n}}{r_n! s_n!}
		\right)
		\langle
			\symprod{ \prod\limits_n \hat{a}_n^{r_n} (\hat{a}_n^\dagger)^{s_n}}
		\rangle,
\end{split}
\end{equation*}
which is straightforwardly followed by the statement of the lemma.
\end{proof}

Moments of multimode Wigner function correspond to the averages of symmetrically ordered products in the same way as for single-mode case.
\begin{theorem}[Multimode extension of~\thmref{multimode-formalism:single-mode-wigner-moments}]
\[
	\int d^2\alpha_1 \ldots \int d^2\alpha_N\,
		\left(
			\prod\limits_n \alpha_n^{r_n} (\alpha_n^*)^{s_n}
		\right) W(\bm{\alpha}, \bm{\alpha}^*)
	= \langle \symprod{ \prod\limits_n \hat{a}_n^{r_n} (\hat{a}_n^\dagger)^{s_n} } \rangle.
\]
\end{theorem}
\begin{proof}
The proof is carried out similarly to~\thmref{multimode-formalism:single-mode-wigner-moments}:
integrals over $\alpha_n$ are eliminated one by one using integration by parts and~\lmmref{multimode-formalism:zero-integrals},
until we get the right part of~\lmmref{multimode-formalism:multimode-moments-from-chi}.
\end{proof}
