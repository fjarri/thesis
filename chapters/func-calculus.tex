% =============================================================================
\chapter{Functional calculus}
\label{cha:appendix:func-calculus}
% =============================================================================

The definitions of differentiation and integration from \appref{c-numbers} can be extended to operate on functions and functionals.
This proved to be a useful tool in the derivation of the functional Wigner transformation and expressing accompanied results, as it helps encapsulate bases and mode populations inside wave functions and field operators.
It has been introduced (among other places) in most of the papers treating functional extensions of quasiprobability with varying level of detail.
The most extensive description was made by Dalton~\cite{Dalton2012}.
Although, while these papers cover the foundations quite well, they are missing several important results which are essential for this thesis, and which will be therefore proved in this Appendix.


% =============================================================================
\section{Functional spaces and projections}
% =============================================================================

We will assume we are provided with an arbitrary orthonormal basis $\fullbasis$, consisting of functions $\phi_{\nvec}(\xvec)$, where $\xvec \in \mathbb{R}^D$ is a $D$-dimensional coordinate vector, and $\nvec \in \fullbasis$ is a mode identifier.
The exact nature of a mode identifier is irrelevant; we only require it to have an equivalence relation defined, and be enumerable.
For example, for a three-dimensional harmonic potential, the mode identifier will be a tuple $(k,l,m)$ of three non-negative integers.

Orthonormality and completeness conditions for basis functions are, respectively,
\begin{eqns}
\label{eqn:func-calculus:basis}
	\int\limits_A \phi_{\nvec}^*(\xvec) \phi_{\mvec}(\xvec) \upd\xvec
	& = \delta_{\nvec\mvec}, \\
	\sum_{\nvec \in \fullbasis} \phi_{\nvec}^*(\xvec) \phi_{\nvec}(\xvec^\prime)
	& = \delta(\xvec^\prime - \xvec),
\end{eqns}
where the integration area $A$ depends on the basis set (for example, $A$ is the whole space for harmonic oscillator modes, and a box for plane waves).
Hereinafter we assume that the integration $\int \upd\xvec$ is always performed over $A$, unless explicitly stated otherwise. In addition, to avoid clutter, for functions of coordinates the argument list will be omitted (i.e. $f(\xvec) \equiv f$ and $f(\xvec^\prime) \equiv f^\prime$) except where it is necessary for clarity.

Various functions can be combined from all, or the certain subset of basis modes by means of a composition:

\begin{definition}
\label{def:func-calculus:composition}
	For some subset of the full basis $\restbasis \subseteq \fullbasis$, the composition transformation creates a function from a vector of mode populations:
	\begin{eqn*}
		\mathcal{C}_{\restbasis}(\balpha)
		= \sum_{\nvec \in \restbasis} \phi_{\nvec} \alpha_{\nvec}.
	\end{eqn*}
	Decomposition transformation, correspondingly, creates a vector of populations out of a function:
	\begin{eqn*}
		(\mathcal{C}_{\restbasis}^{-1}[f])_{\nvec}
		= \int \upd\xvec \phi_{\nvec}^* f,\,{\nvec} \in \restbasis.
	\end{eqn*}
\end{definition}

For any subset of the full basis, there is a certain subspace of functions that can be obtained by composing modes from this subset only.

\begin{definition}
	For some subset of the full basis $\restbasis \subseteq \fullbasis$, $\mathbb{F}_{\restbasis} \equiv (\mathbb{R}^D \rightarrow \mathbb{C})_{\restbasis}$ is a space of all functions of coordinates, which can be obtained from $\mathcal{C}_{\restbasis}$.
	In other words, such functions consist only of modes from $\restbasis$.
	We denote $\mathbb{F}_{\fullbasis} \equiv \mathbb{F}$.
\end{definition}

Using this definition, the type of composition and decomposition transformations can be written as
\begin{eqn}
		\mathcal{C}_{\restbasis} \in \mathbb{C}^{|\restbasis|} \rightarrow \mathbb{F}_{\restbasis},\quad
		\mathcal{C}_{\restbasis}^{-1} \in \mathbb{F} \rightarrow \mathbb{C}^{|\restbasis|}
\end{eqn}
Note also that for any $f \in \mathbb{F}_{\restbasis}$ corresponding composition and decomposition are reversible, i.e. $\mathcal{C}_{\restbasis}(\mathcal{C}_{\restbasis}^{-1}[f]) \equiv f$.
We will refer such functions as restricted functions.

The result of any non-linear transformation of a function $f \in \mathbb{F}_{\restbasis}$ is not guaranteed to belong to $\mathbb{F}_{\restbasis}$ and requires explicit projection to be used with other restricted functions from the same subspace $\mathbb{F}_{\restbasis}$:

\begin{definition}
\label{def:func-calculus:projector}
	An arbitrary function can be projected to $\mathbb{F}_{\restbasis}$ using the projection operator:
	\begin{eqn*}
		& \proj{\restbasis} \in \mathbb{F} \rightarrow \mathbb{F}_{\restbasis} \\
		& \proj{\restbasis}[f](\xvec)
		\equiv (\mathcal{C}_{\restbasis}(\mathcal{C}_{\restbasis}^{-1}[f])) (\xvec)
		= \sum_{\nvec \in \restbasis} \phi_{\nvec} \int
			\upd\xvec^\prime\, \phi_{\nvec}^{\prime*} f^\prime.
	\end{eqn*}
	Obviously, $\proj{\fullbasis} \equiv \mathds{1}$.
\end{definition}

Being applied to the delta function, the projection operator produces a restricted delta function:

\begin{definition}
\label{def:func-calculus:restricted-delta}
	The restricted delta function $\delta_{\restbasis} \in \mathbb{F}_{\restbasis}$ is a projected form of standard delta function:
	\begin{eqn*}
		\delta_{\restbasis}(\xvec^\prime, \xvec)
		= \proj{\restbasis}[\delta]
		= \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*} \phi_{\nvec}.
	\end{eqn*}
	Note that in general $\delta_{\restbasis}^*(\xvec^\prime, \xvec) = \delta_{\restbasis}(\xvec, \xvec^\prime)$, so the order of variables is important.
	For a full basis, this definition coincides with the standard delta function: $\delta_{\fullbasis}(\xvec^\prime, \xvec) \equiv \delta(\xvec^\prime - \xvec)$.
\end{definition}

Projection transformation can be, in turn, expressed using the restricted delta function:
\begin{eqn}
\label{eqn:func-calculus:projector-via-delta}
	\proj{\restbasis}[f](\xvec) = \int \upd\xvec^\prime \delta_{\restbasis}(\xvec^\prime, \xvec) f^\prime.
\end{eqn}
The conjugate of $\proj{\restbasis}$ is therefore
\begin{eqn}
	(\proj{\restbasis}[f](\xvec))^*
	= \int \upd\xvec^\prime \delta_{\restbasis}^*(\xvec^\prime, \xvec) f^{\prime*}
	= \proj{\restbasis}^* [f^*](\xvec).
\end{eqn}


% =============================================================================
\section{Functional differentiation}
% =============================================================================

Let $\mathcal{F}[f] \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$ be some arbitrary functional operator (not to be confused with quantum mechanical operators) acting on functions from a restricted basis.
Such operator can be as simple as an algebraic function of $f$, for example, $\mathcal{F}[f] = f^2$, but it can also be more complicated.
Note that in general this operator is nor linear, therefore its result is not guaranteed to belong to the same restricted basis as its argument.
Also, since $\mathbb{C}$ is a specific case of $\mathbb{F}$ (a constant function of coordinates), a specific case of a functional operator is a functional $\mathcal{F}[f] \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{C}$).
This means that the calculus described in this section applies to functionals as well.

Composition and decomposition transformations from \defref{func-calculus:composition} define a bijection between a restricted function space $\mathbb{F}_{\restbasis}$ and a vector space of the corresponding dimensionality $\mathbb{C}^{|\restbasis|}$ (where $|\restbasis|$ denotes the cardinality of $\restbasis$).
Therefore any functional operator $\mathcal{F}$ can be alternatively treated as a function of a vector of mode populations and a coordinate vector:
\begin{eqn}
	& F \in \mathbb{C}^{|\restbasis|} \rightarrow \mathbb{F}
		\equiv \mathbb{C}^{|\restbasis|} \rightarrow \mathbb{R}^D \rightarrow \mathbb{C} \\
	& F(\balpha, \xvec) \equiv \mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)](\xvec).
\end{eqn}
Since the operator is not linear, this correspondence in general cannot be expressed in a form of matrix.

Using this correspondence, we can define the differentiation in the space of functional operators:

\begin{definition}
\label{def:func-calculus:func-diff}
	Derivative of a functional operator is
	\begin{eqn*}
		& \frac{\fdelta}{\fdelta f^\prime} \in
		\left(
			\mathbb{F}_{\restbasis} \rightarrow \mathbb{F}
		\right)
		\rightarrow
		\left(
			\mathbb{R}^D \rightarrow \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}
		\right) \\
		& \frac{\fdelta \mathcal{F}[f]}{\fdelta f^\prime}
		= \left.
				\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
				\frac{\cwd \mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)]}{\cwd \alpha_{\nvec}}
			\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]}.
	\end{eqn*}
\end{definition}

Note that the type of the returned operator differs from the argument type: the result depends on two coordinates, not just one.
The second coordinate ($\xvec^\prime$) comes from the function $f^\prime \equiv f(\xvec^\prime)$ we are differentiating by.

This definition may look too elaborate at first, but later in this section we will see that it leads to intuitive consequences, making the functional derivative behave very similar to the Wirtinger derivative from \appref{c-numbers}.
Let us first demonstrate that the definition obeys standard differentiation rules.

\begin{theorem}
	Functional differentiation from \defref{func-calculus:func-diff} obeys sum, product, quotient, and chain differentiation rules.
	The latter one is applied as if $\mathcal{F}[f]$ was a function of two independent variables $f$ and $f^*$:
	\begin{eqn*}
		\frac{\fdelta \mathcal{F}[\mathcal{G}[f]]}{\fdelta f^\prime}
			= \int \upd\xvec^{\prime\prime} \left(
				\frac{\fdelta \mathcal{F}}{\fdelta \mathcal{G}^{\prime\prime}}
				\frac{\fdelta \mathcal{G}}{\fdelta \mathcal{f}^{\prime}}
				+ \frac{\fdelta \mathcal{F}}{\fdelta \mathcal{G}^{\prime\prime*}}
				\frac{\fdelta \mathcal{G}^*}{\fdelta \mathcal{f}^{\prime}}
			\right).
	\end{eqn*}
\end{theorem}
\begin{proof}
First tree rules are proved straightforwardly by substituting $\mathcal{F} + \mathcal{G}$, $\mathcal{F} \mathcal{G}$ and $\mathcal{F} / \mathcal{G}$ into \defref{func-calculus:func-diff}.
To prove the latter, let us substitute $\mathcal{F}[\mathcal{G}]$ into the definition:
\begin{eqn}
\label{eqn:func-calculus:chain-expansion}
	\frac{\fdelta \mathcal{F}[\mathcal{G}[f]]}{\fdelta f^\prime}
		& = \left.
				\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
				\frac{\cwd \mathcal{F}[\mathcal{G}[\mathcal{C}_{\restbasis}(\balpha)]]}{\cwd \alpha_{\nvec}}
			\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
		& = \left.
				\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
				\frac{\cwd \mathcal{F}[\mathcal{C}(\bbeta)]}{\cwd \alpha_{\nvec}}
			\right|_{\bbeta = \mathcal{C}^{-1}[\mathcal{G}[\mathcal{C}_{\restbasis}(\balpha)]]}.
\end{eqn}
Applying the chain rule for Wirtinger derivatives, and recalling the definition of the decomposition transformation:
\begin{eqn}
	\frac{\cwd \mathcal{F}[\mathcal{C}(\bbeta)]}{\cwd \alpha_{\nvec}}
	= \sum_{\mvec \in \fullbasis} \left(
		\frac{\cwd \mathcal{F}[\mathcal{C}(\bbeta)]}{\cwd \beta_{\mvec}}
		\frac{\cwd \beta_{\mvec}}{\cwd \alpha_{\nvec}}
		+ \frac{\cwd \mathcal{F}[\mathcal{C}(\bbeta)]}{\cwd \beta_{\mvec}^*}
		\frac{\cwd \beta_{\mvec}^*}{\cwd \alpha_{\nvec}}
	\right),
\end{eqn}
\begin{eqn}
	\frac{\cwd \beta_{\mvec}}{\cwd \alpha_{\nvec}}
	= \frac{\cwd (\mathcal{C}^{-1}[G(\balpha, \xvec)])_{\mvec}}{\cwd \alpha_{\nvec}}
	= \int \cwd\xvec^{\prime\prime} \phi_{\mvec}^{\prime\prime*}
		\frac{\cwd G(\balpha, \xvec)}{\cwd \alpha_{\nvec}},
\end{eqn}
\begin{eqn}
	\frac{\cwd \beta_{\mvec}^*}{\cwd \alpha_{\nvec}}
	= \int \cwd\xvec^{\prime\prime} \phi_{\mvec}^{\prime\prime}
		\frac{\cwd G^*(\balpha, \xvec)}{\cwd \alpha_{\nvec}}.
\end{eqn}
Substituting this into~\eqnref{func-calculus:chain-expansion}, we get
\begin{eqn}
	\frac{\fdelta \mathcal{F}[\mathcal{G}[f]]}{\fdelta f^\prime}
		={} & \int \upd\xvec^{\prime\prime}
			\sum_{\mvec \in \fullbasis}
				\phi_{\mvec}^{\prime\prime*}
				\left.
					\frac{\cwd \mathcal{F}[\mathcal{C}(\bbeta)]}{\cwd \beta_{\mvec}}
				\right|_{\bbeta = \mathcal{C}^{-1}[\mathcal{G}[f]]}
			\sum_{\nvec \in \restbasis}
				\phi_{\nvec}^{\prime*}
				\left.
					\frac{\cwd \mathcal{G}[\mathcal{C}(\balpha)]}{\cwd \alpha_{\nvec}}
				\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
		& + \sum_{\mvec \in \fullbasis}
				\phi_{\mvec}^{\prime\prime}
				\left.
					\frac{\cwd \mathcal{F}[\mathcal{C}(\bbeta)]}{\cwd \beta_{\mvec}^*}
				\right|_{\bbeta = \mathcal{C}^{-1}[\mathcal{G}[f]]}
			\sum_{\nvec \in \restbasis}
				\phi_{\nvec}^{\prime*}
				\left.
					\frac{\cwd \mathcal{G}^*[\mathcal{C}(\balpha)]}{\cwd \alpha_{\nvec}}
				\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]}.
\end{eqn}
Recognising \defref{func-calculus:func-diff} for $\fdelta \mathcal{F} / \fdelta \mathcal{G}$ and $\fdelta \mathcal{G} / \fdelta \mathcal{f}$, we get the final expression
\begin{eqn}
	\frac{\fdelta \mathcal{F}[\mathcal{G}[f]]}{\fdelta f^\prime}
		= \int \upd\xvec^{\prime\prime} \left(
			\frac{\fdelta \mathcal{F}}{\fdelta \mathcal{G}^{\prime\prime}}
			\frac{\fdelta \mathcal{G}}{\fdelta \mathcal{f}^{\prime}}
			+ \frac{\fdelta \mathcal{F}}{\fdelta \mathcal{G}^{\prime\prime*}}
			\frac{\fdelta \mathcal{G}^*}{\fdelta \mathcal{f}^{\prime}}
		\right).
\end{eqn}
\end{proof}

The above lemma demonstrates that, with respect to differentiation, functional operators behave as if they were depending on two independent functions, $f$ and $f^*$ --- much like complex-valued functions with respect to Wirtinger differentiation.

Most of the time we will deal with functional operators in a particular form, namely the algebraic expressions of their arguments.
It turns out that for this subset functional differentiation behaves almost exactly like Wirtinger differentiation and allows one to circumvent \defref{func-calculus:func-diff}, calculating derivatives based on well-known symbolic rules.

\begin{theorem}
	If a functional operator $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$ has the form $\mathcal{F}[f] \equiv g(f)$, where $g(z)$ is a function that can be expanded into power series of $z^r (z^*)^s$, then $\fdelta \mathcal{F} / \fdelta f^\prime$ and $\fdelta \mathcal{F} / \fdelta f^{\prime*}$ can be calculated as derivatives of $g(f)$ over $f$ and $f^*$, respectively, times the restricted delta function:
	\begin{eqn*}
		\frac{\fdelta \mathcal{F}}{\fdelta f^\prime}
		= \delta_{\restbasis}(\xvec^\prime, \xvec) \left.
			\frac{\cwd g(z)}{\cwd z}
		\right|_{z=f(\xvec)},
		\quad
		\frac{\fdelta \mathcal{F}}{\fdelta f^{\prime*}}
		= \delta_{\restbasis}^*(\xvec^\prime, \xvec) \left.
			\frac{\cwd g(z)}{\cwd z^*}
		\right|_{z=f(\xvec)}.
	\end{eqn*}
\end{theorem}
\begin{proof}
We will prove the first identity.
Without loss of generality, we can consider $\mathcal{F} = f^r (f^*)^s$.
Substituting this into \defref{func-calculus:func-diff}, differentiating the composition according to \defref{func-calculus:composition} and recognising the restricted delta function:
\begin{eqn}
	\frac{\fdelta \mathcal{F}}{\fdelta f^\prime}
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
		\left.
			\frac{\cwd \left(
				\mathcal{C}_{\restbasis}^r(\balpha)
				(\mathcal{C}_{\restbasis}^*(\balpha))^s
			\right)}{\cwd \alpha_{\nvec}}
		\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
		r \phi_{\nvec}
		\left.
			\mathcal{C}_{\restbasis}^{r-1}(\balpha)
			(\mathcal{C}_{\restbasis}^*(\balpha))^s
		\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
	& = r \delta_{\restbasis}(\xvec^\prime, \xvec) f^{r-1} (f^*)^s
	= \delta_{\restbasis}(\xvec^\prime, \xvec) \left.
			\frac{\cwd g(z)}{\cwd z}
		\right|_{z=f(\xvec)}.
\end{eqn}
The second identity is proved in the same way.
\end{proof}


% =============================================================================
\section{Functional integration}
% =============================================================================

In this section we will only postulate the expression for an integral of a functional operator; for the rationale behind this definition one can refer to~\cite{Dalton2012}.
Same as in the differentiation case, we will make use of the equivalence between a functional operator and a function of two vectors.

\begin{definition}
	An integral of a functional operator $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$ is an integral of the corresponding function over mode variables:
	\begin{eqn*}
		& \int \fdelta^2 f \in (\mathbb{F}_{\restbasis} \rightarrow \mathbb{F})
			\rightarrow (\mathbb{R}^D \rightarrow \mathbb{C}) \\
		& \int \fdelta^2 f \mathcal{F}[f]
		= \int \upd^2\balpha\, \mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)]
		= \left(
			\prod_{\nvec \in \restbasis} \int \upd^2\alpha_{\nvec}
		\right) \mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)],
	\end{eqn*}
	where the product of integrals stands for their successive application.
    If the restricted basis contains an infinite number of modes, the integral is treated as a limit $|\restbasis| \rightarrow \infty$.
\end{definition}

Functional integration has a Fourier-like property analogous to \lmmref{c-numbers:fourier-of-moments}, but its statement requires the definition of the delta functional:

\begin{definition}
\label{def:func-calculus:delta-functional}
	For a restricted basis $\restbasis$, the delta functional is
	\begin{eqn*}
		& \Delta_{\restbasis} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{R} \\
		& \Delta_{\restbasis}[f]
		\equiv \prod_{\nvec \in \restbasis} \delta(\Real \alpha_{\nvec}) \delta(\Imag \alpha_{\nvec}),
	\end{eqn*}
	where $\balpha = \mathcal{C}_{\restbasis}^{-1}[f]$.
\end{definition}

The delta functional has the sifting property in functional integrals:
\begin{eqn}
	\int \fdelta^2 f \mathcal{F}[f] \Delta_{\restbasis}[f]
	& = \int \upd^2\balpha\,
		\mathcal{F}(\mathcal{C}_{\restbasis}[\balpha])
		\prod_{\nvec \in \restbasis} \delta(\Real \alpha_{\nvec}) \delta(\Imag \alpha_{\nvec}) \\
	& = \left.
			\mathcal{F}(\mathcal{C}_{\restbasis}[\balpha])
		\right|_{\forall \nvec \in \restbasis\, \alpha_{\nvec} = 0} \\
	& = \left. \mathcal{F}[f] \right|_{f \equiv 0}.
\end{eqn}

By analogy with the field displacement operator from \defref{wigner:func:displacement-op}, we can define a displacement functional, which will often appear in the formulation of functional Wigner transformation (\defref{wigner:func:w-transformation}) and accompanying proofs:

\begin{definition}
	Displacement functional takes two functions as arguments and returns a complex result:
	\begin{eqn*}
		& D \in \mathbb{F} \rightarrow \mathbb{F} \rightarrow \mathbb{C} \\
		& D[g, f] = \exp \int \upd\xvec \left(
			-g f^* + g^* f
		\right).
	\end{eqn*}
\end{definition}

The displacement functional exhibits Fourier-like properties in functional integrals.

\begin{lemma}[Functional extension of \lmmref{c-numbers:fourier-of-moments}]
\label{lmm:func-calculus:fourier-of-moments}
	For $f \in \mathbb{F}_{\restbasis}$ and $g \in \mathbb{F}_{\restbasis}$, and for any non-negative integers $r$ and $s$:
	\begin{eqn*}
		\int \fdelta^2 f\, f^r (f^*)^s D[g, f]
		= \pi^{2|\restbasis|}
			\left( -\frac{\fdelta}{\fdelta g^*} \right)^r
			\left( \frac{\fdelta}{\fdelta g} \right)^s
			\Delta_{\restbasis}[g].
	\end{eqn*}
\end{lemma}
\begin{proof}
We will start by representing the functional integral and the integrand in mode form:
\begin{eqn}
	& \int \fdelta^2 f\, f^r (f^*)^s \exp
		\int \upd\xvec \left( -g f^* + g^* f \right) \\
	& = \int \upd^2\balpha
		\left( \sum_{\nvec \in \restbasis} \phi_{\nvec} \alpha_{\nvec} \right)^r
		\left( \sum_{\nvec \in \restbasis} \phi^*_{\nvec} \alpha_{\nvec}^* \right)^s
		\prod_{\nvec \in \restbasis} \exp(-\beta_{\nvec} \alpha_{\nvec}^* + \beta_{\nvec}^* \alpha_{\nvec}),
\end{eqn}
where $\balpha = \mathcal{C}_{\restbasis}^{-1}[f]$ and $\bbeta = \mathcal{C}_{\restbasis}^{-1}[g]$.
Expanding powers of $f$ and $f^*$ using multinomial theorem:
\begin{eqn2}
	& ={} && \int \upd^2\balpha
		\left(
			\sum_{\sum u_{\mvec} = r} \binom{r}{ \left\{ u_{\mvec} \right\} }
			\prod_{\nvec \in \restbasis} \phi_{\nvec}^{u_{\nvec}} \alpha_{\nvec}^{u_{\nvec}}
		\right) \\
	& && \times \left(
			\sum_{\sum v_{\mvec} = s} \binom{s}{ \left\{ v_{\mvec} \right\} }
			\prod_{\nvec \in \restbasis} (\phi_{\nvec}^*)^{v_{\nvec}} (\alpha_{\nvec}^*)^{v_{\nvec}}
		\right)
		\prod_{\nvec \in \restbasis} \exp(-\beta_{\nvec} \alpha_{\nvec}^* + \beta_{\nvec}^* \alpha_{\nvec}),
\end{eqn2}
where $\binom{r}{ \left\{ u_{\mvec} \right\} } \equiv r! / (\prod u_{\mvec}!)$ are multinomial coefficients.
Splitting variables:
\begin{eqn2}
	& ={} && \sum_{ \sum u_{\mvec} = r,\, \sum v_{\mvec} = s }
		\binom{r}{ \left\{ u_{\mvec} \right\} }
		\binom{s}{ \left\{ v_{\mvec} \right\} } \\
	& && \prod_{\nvec \in \restbasis}
			\phi_{\nvec}^{u_{\nvec}} (\phi_{\nvec}^*)^{v_{\nvec}}
			\int d^2\alpha_{\nvec}
				\alpha_{\nvec}^{u_{\nvec}}
				(\alpha_{\nvec}^*)^{v_{\nvec}}
				\exp(-\beta_{\nvec} \alpha_{\nvec}^* + \beta_{\nvec}^* \alpha_{\nvec}).
\end{eqn2}
Applying \lmmref{c-numbers:fourier-of-moments} to evaluate integrals over $\alpha_{\nvec}$:
\begin{eqn}
	={} & \sum_{\sum u_{\mvec} = r,\, \sum v_{\mvec} = s}
		\binom{r}{ \left\{ u_{\mvec} \right\} }
		\binom{s}{ \left\{ v_{\mvec} \right\} }
		\pi^{2|\restbasis|} \\
	& \times \prod_{\nvec \in \restbasis}
			\phi_{\nvec}^{u_{\nvec}} (\phi_{\nvec}^*)^{v_{\nvec}}
			\left( -\frac{\cwd}{\cwd \beta_{\nvec}^*} \right)^{u_{\nvec}}
			\left( \frac{\cwd}{\cwd \beta_{\nvec}} \right)^{v_{\nvec}}
			\delta(\Real \beta_{\nvec}) \delta(\Imag \beta_{\nvec}).
\end{eqn}
Collapsing sums, and recognising functional derivatives (\defref{func-calculus:func-diff}) and the functional delta (\defref{func-calculus:delta-functional}):
\begin{eqn}
	& = \pi^{2|\restbasis|}
		\left( -\sum_{\nvec \in \restbasis} \phi_{\nvec} \frac{\cwd}{\cwd \beta_{\nvec}^*} \right)^r
		\left( \sum_{\nvec \in \restbasis} \phi_{\nvec}^* \frac{\cwd}{\cwd \beta_{\nvec}} \right)^s
		\prod_{\nvec \in \restbasis} \delta(\Real \beta_{\nvec}) \delta(\Imag \beta_{\nvec}) \\
	& = \pi^{2|\restbasis|}
		\left( -\frac{\fdelta}{\fdelta g^*} \right)^r
		\left( \frac{\fdelta}{\fdelta g} \right)^s
		\Delta_{\restbasis}[g].
	\qedhere
\end{eqn}
\end{proof}

It is easy to show that functional integration has the same integration by parts property as common integration:
\begin{eqn}
	\int \fdelta^2 f
		\frac{\fdelta \mathcal{F}[f]}{\fdelta f^\prime}
		\mathcal{G}[f]
	= \int \fdelta^2 f
		\frac{\fdelta (\mathcal{F}[f] \mathcal{G}[f])}{\fdelta f^\prime}
		- \int \fdelta^2 f
		\frac{\fdelta \mathcal{G}[f]}{\fdelta f^\prime}
		\mathcal{F}[f].
\end{eqn}
Functional integration by parts serves as the foundation of several theorems from \charef{wigner}, and will need several theorems that will help us eliminate the first term in the right part of the expression.
Namely, these are extensions of \lmmref{c-numbers:zero-integrals} and \lmmref{c-numbers:zero-delta-integrals} in terms of functional operators, with the addition of one more functional-specific lemma.

\begin{lemma}[Functional extension of \lmmref{c-numbers:zero-integrals}]
\label{lmm:func-calculus:zero-integrals}
	For a square-integrable functional operator $\mathcal{F}$ (i.e., a functional operator that produces only square-integrable functions),
	\begin{eqn*}
		\int \fdelta^2 g
			\frac{\fdelta}{\fdelta g^\prime} \left( D[g, f] \mathcal{F}[g] \right)
		& = 0, \\
		\int \fdelta^2 g
			\frac{\fdelta}{\fdelta g^{\prime*}} \left( D[g, f] \mathcal{F}[g] \right)
		& = 0.
	\end{eqn*}
\end{lemma}
\begin{proof}
We will prove the first equation.
Let $\balpha = \mathcal{C}_{\restbasis}^{-1}[f]$ and $\bbeta = \mathcal{C}_{\restbasis}^{-1}[g]$.
Displacement functional can be represented as a function of mode vectors:
\begin{eqn}
	D[g, f]
	& = \exp \int \upd x \sum_{\nvec \in \restbasis,\mvec \in \restbasis} \left(
		- \phi_{\nvec} \phi_{\mvec}^* \beta_{\nvec} \alpha_{\mvec}^*
		+ \phi_{\nvec}^* \phi_{\mvec} \beta_{\nvec}^* \alpha_{\mvec}
	\right) \\
	& = \exp \sum_{\nvec \in \restbasis,\mvec \in \restbasis} \left(
		- \delta_{\nvec \mvec} \beta_{\nvec} \alpha_{\nvec}^*
		+ \delta_{\nvec \mvec} \beta_{\nvec}^* \alpha_{\nvec}
	\right) \\
	& = \exp \sum_{\nvec \in \restbasis} \left(
		-\beta_{\nvec} \alpha_{\nvec}^* + \beta_{\nvec}^* \alpha_{\nvec}
	\right).
\end{eqn}

We introduce a special notation for this lemma to indicate the subset of $\restbasis$ used by operators and functionals.
With this notation, for fixed $\nvec$:
\begin{eqn}
	D[g, f]
	& = \prod_{\mvec \in \restbasis} \exp \left(
		- \beta_{\mvec} \alpha_{\mvec}^* + \beta_{\mvec}^* \alpha_{\mvec}
	\right) \\
	& = \exp \left(
		- \beta_{\nvec} \alpha_{\nvec}^* + \beta_{\nvec}^* \alpha_{\nvec}
	\right)
	\prod_{\mvec \in \restbasis, \mvec \ne \nvec} \exp \left(
		- \beta_{\mvec} \alpha_{\mvec}^* + \beta_{\mvec}^* \alpha_{\mvec}
	\right) \\
	& = D_{\lnot \nvec} D_{\nvec},
\end{eqn}
and, similarly,
\begin{eqn}
	g & = g_{\lnot \nvec} + g_{\nvec},
\end{eqn}
\begin{eqn}
	\int \upd^2 \bbeta & = \int \upd^2 \bbeta_{\lnot \nvec} \int \upd^2 \beta_{\nvec}.
\end{eqn}

With this notation:
\begin{eqn}
	\int \fdelta^2g
		\frac{\fdelta}{\fdelta g^\prime} \left(D[g, f] \mathcal{F}[g] \right)
	& = \int \upd^2 \bbeta
		\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*} \frac{\cwd}{\cwd \beta_{\nvec}}
			D_{\lnot \nvec} D_{\nvec}
			\mathcal{F}[g] \\
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
		\int \upd^2 \bbeta_{\lnot \nvec} D_{\lnot \nvec}
		\int \upd^2 \beta_{\nvec} \frac{\cwd}{\cwd \beta_{\nvec}}
			D_{\nvec} \mathcal{F}[\mathcal{C}_{\restbasis}(\bbeta)].
\end{eqn}
For each term the internal is equal to zero because of \lmmref{c-numbers:zero-integrals}, therefore the whole sum is zero.
\end{proof}

\begin{lemma}[Functional extension of \lmmref{c-numbers:zero-delta-integrals}]
\label{lmm:func-calculus:zero-delta-integrals}
	For a square-integrable functional operator $\mathcal{F}$ (i.e., a functional operator that produces only square-integrable functions), restricted function $f \in \mathbb{F}_{\restbasis}$, and non-negative integers $r$ and $s$,
	\begin{eqn*}
		\int \fdelta^2 f
			\frac{\fdelta}{\fdelta f} \left(
				\mathcal{F}[f]
				\left( \frac{\fdelta}{\fdelta f} \right)^s
				\left( -\frac{\fdelta}{\fdelta f^*} \right)^r
				\Delta_{\restbasis}[f]
			\right)
		& = 0, \\
		\int \fdelta^2 f
			\frac{\fdelta}{\fdelta f^*} \left(
				\mathcal{F}[f]
				\left( \frac{\fdelta}{\fdelta f} \right)^s
				\left( -\frac{\fdelta}{\fdelta f^*} \right)^r
				\Delta_{\restbasis}[f]
			\right)
		& = 0. \\
	\end{eqn*}
\end{lemma}
\begin{proof}
Proved by expanding functional integration and differentials into modes and recognising \lmmref{c-numbers:zero-delta-integrals}.
\end{proof}

In order to perform transformations of master equations in the future, we will need a lemma which justifies certain operation with Laplacian (which is a part of kinetic term in a Hamiltonian).

\begin{lemma}
\label{lmm:func-calculus:move-laplacian}
	Let mode functions in the restricted basis $\restbasis$ satisfy the condition that for any pair of modes $\mvec,\nvec \in \restbasis$ it is true that
	\begin{eqn*}
		\oint\limits_{\partial A} \phi_{\mvec} (\nabla \phi_{\nvec}^* \cdot \mathbf{v}) \upd S
		= 0,
	\end{eqn*}
	where $A$ is the integration area associated with the basis, $\partial A$ is its boundary, and $\mathbf{v}$ is the outward pointing unit normal of surface element $\upd S$.
	Then for any $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$,
	\begin{eqn*}
		\int\limits_A \upd\xvec \left(
			\nabla^2 \frac{\fdelta}{\fdelta f}
		\right) f \mathcal{F}[f]
		= \int\limits_A \upd\xvec \frac{\fdelta}{\fdelta f}
		( \nabla^2 f ) \mathcal{F}[f]
	\end{eqn*}
\end{lemma}
\begin{proof}
Integration limits play an important role in this proof, so we will write them explicitly.
\begin{eqn}
\label{eqn:func-calculus:move-laplasian-expansion}
	\int\limits_A \upd\xvec \left(
		\nabla^2 \frac{\fdelta}{\fdelta f}
	\right) f
	= \sum_{\nvec \in \restbasis, \mvec \in \restbasis} \left(
			\int\limits_A \upd\xvec ( \nabla^2 \phi_{\nvec}^* ) \phi_{\mvec}
		\right)
		\frac{\cwd}{\cwd \alpha_{\nvec}} \alpha_{\mvec}
			\mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)]
	= (*),
\end{eqn}
where $\balpha = \mathcal{C}_{\restbasis}^{-1}[f]$.
Using Green's first identity and the condition for the integrals over the boundary of $A$:
\begin{eqn}
	\int\limits_A \upd\xvec ( \nabla^2 \phi_{\nvec}^* ) \phi_{\mvec}
	& = \oint\limits_{\partial A} \phi_{\mvec} (\nabla \phi_{\nvec}^* \cdot \mathbf{v}) \upd S
	- \int\limits_A \upd\xvec ( \nabla \phi_{\nvec}^* ) ( \nabla \phi_{\mvec} ) \\
	& = 0 - \int\limits_A \upd\xvec ( \nabla \phi_{\nvec}^* ) ( \nabla \phi_{\mvec} ) \\
	& = \oint\limits_{\partial A} \phi_{\nvec}^* (\nabla \phi_{\mvec} \cdot \mathbf{v}) \upd S
	- \int\limits_A \upd\xvec ( \nabla \phi_{\nvec}^* ) ( \nabla \phi_{\mvec} ) \\
	& = \int\limits_A \upd\xvec \phi_{\nvec}^* ( \nabla^2 \phi_{\mvec} ),
\end{eqn}
Substituting this back into~\eqnref{func-calculus:move-laplasian-expansion}:
\begin{eqn}
	(*)
	& = \sum_{\nvec \in \restbasis, \mvec \in \restbasis} \left(
			\int\limits_A \upd\xvec \phi_{\nvec}^* ( \nabla^2 \phi_{\mvec} )
		\right)
		\frac{\cwd}{\cwd \alpha_{\nvec}} \alpha_{\mvec} \mathcal{F}(\mathbf{\alpha}) \\
	& = \int\limits_A \upd\xvec \frac{\fdelta}{\fdelta f}
		( \nabla^2 f ) \mathcal{F}[f].
	\qedhere
\end{eqn}
\end{proof}

Note that this lemma imposes an additional requirement on basis functions, which is, essentially, a generalised form of periodicity in the zeroth and first derivative over $A$.
In this work we use two bases: plane waves and harmonic modes (see \appref{bases} for details).

For the harmonic basis the condition is obviously true, since the boundary of $A$ is on the infinity, and both zeroth and first derivatives (or any other order, for that matter) of any mode function~\eqnref{bases:harmonic-modes} are zero there.

For the plane wave basis $A$ is a box (let us suppose for definiteness that it spans from $0$ to $L_j$ in every dimension $j$), and the mode functions are separable ($\phi_{\nvec}(\xvec) \equiv \prod_{j=1}^D \phi_{n_j}^{(j)}(x_j)$) so the variables in the integral from the condition can be easily separated too:
\begin{eqn}
	\oint\limits_{\partial A} \phi_{\mvec} (\nabla \phi_{\nvec}^* \cdot \mathbf{v}) \upd S
	& = \sum_{j=1}^D
		\left. \phi_{m_j}^{(j)} \frac{\upd \phi_{n_j}^{(j)*}}{\upd x_j} \right|_{x_j = 0}^{L_j}
		\prod_{k=1,k \ne j}^D \int_0^{L_k} \upd x_k \phi_{m_k}^{(k)} \phi_{n_k}^{(k)*}.
\end{eqn}
It is obvious from~\eqnref{bases:plane-wave-modes} that for any mode $\nvec$
\begin{eqn}
	\phi_{n_j}^{(j)}(0) = \phi_{n_j}^{(j)}(L_j), \quad
	\left. \frac{\upd \phi_{n_j}^{(j)}}{\upd x_j} \right|_{x_j=0}
	= \left. \frac{\upd \phi_{n_j}^{(j)}}{\upd x_j} \right|_{x_j=L_j},
\end{eqn}
which makes the integral above zero.

Hereinafter we will assume that this condition is true for any basis we work with.
