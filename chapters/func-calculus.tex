% =============================================================================
\chapter{Functional calculus}
\label{cha:appendix:func-calculus}
% =============================================================================

The definitions of differentiation and integration from~\appref{c-numbers} can be extended to operate on functions and functionals.
This proved to be a useful tool in the derivation of the functional Wigner transformation and expressing accompanied results, as it helps encapsulate bases and mode populations inside wave functions and field operators.
It has been introduced (among other places) in most of the papers treating functional extensions of quasiprobability with varying level of detail.
The most extensive description was made by Dalton~\cite{Dalton2011}.
Although, while these papers cover the foundations quite well, they are missing several important results which are essential for this thesis, and which will be therefore proved in this Appendix.


% =============================================================================
\section{Functional spaces and projections}
% =============================================================================

We will assume we a provided with an arbitrary orthonormal basis $\fullbasis$, consisting of functions $\phi_{\nvec}(\xvec)$, where $\xvec \in \mathbb{R}^D$ is a coordinate vector, and $\nvec \in \fullbasis$ is a mode identifier.
The exact nature of a mode identifier is irrelevant; we only require it to have an equivalence relation defined, and be enumerable.
For example, for a three-dimensional harmonic potential, the mode identifier will be a tuple $(k,l,m)$ of three non-negative integers.

Orthonormality and completeness conditions for basis functions are, respectively,
\begin{eqns}
	\int\limits_A \phi_{\nvec}^*(\xvec) \phi_{\mvec}(\xvec) \upd\xvec
	& = \delta_{\nvec\mvec}, \\
	\sum_{\nvec \in \fullbasis} \phi_{\nvec}^*(\xvec) \phi_{\nvec}(\xvec^\prime)
	& = \delta(\xvec^\prime - \xvec),
\end{eqns}
where the integration area $A$ depends on the basis set (for example, $A$ is the whole space for harmonic oscillator modes, and a box for plane waves).
Hereinafter we assume that the integration $\int \upd\xvec$ is always performed over $A$, unless explicitly stated otherwise. In addition, to avoid clutter, for functions of coordinates the argument list will be omitted (i.e. $f(\xvec) \equiv f$ and $f(\xvec^\prime) \equiv f^\prime$) except where it is necessary for clarity.

Various functions can be combined from all, or the certain subset of basis modes by means of a composition:

\begin{definition}
\label{def:func-calculus:composition}
	For some subset of the full basis $\restbasis \subseteq \fullbasis$, the composition transformation creates a function from a vector of mode populations:
	\begin{eqn*}
		\mathcal{C}_{\restbasis}(\balpha)
		= \sum_{\nvec \in \restbasis} \phi_{\nvec} \alpha_{\nvec}.
	\end{eqn*}
	Decomposition transformation, correspondingly, creates a vector of populations out of a function:
	\begin{eqn*}
		(\mathcal{C}_{\restbasis}^{-1}[f])_{\nvec}
		= \int \upd\xvec \phi_{\nvec}^* f,\,{\nvec} \in \restbasis.
	\end{eqn*}
\end{definition}

For any subset of the full basis, there is a certain subspace of functions that can be obtained by composing modes from this subset only.

\begin{definition}
	For some subset of the full basis $\restbasis \subseteq \fullbasis$, $\mathbb{F}_{\restbasis} \equiv (\mathbb{R}^D \rightarrow \mathbb{C})_{\restbasis}$ is a space of all functions of coordinates, which can be obtained from $\mathcal{C}_{\restbasis}$.
	In other words, such functions consist only of modes from $\restbasis$.
	We denote $\mathbb{F}_{\fullbasis} \equiv \mathbb{F}$.
\end{definition}

Using this definition, the type of composition and decomposition transformations can be written as
\begin{eqn}
		\mathcal{C}_{\restbasis} \in \mathbb{C}^{|\restbasis|} \rightarrow \mathbb{F}_{\restbasis},\quad
		\mathcal{C}_{\restbasis}^{-1} \in \mathbb{F} \rightarrow \mathbb{C}^{|\restbasis|}
\end{eqn}
Note also that for any $f \in \mathbb{F}_{\restbasis}$ corresponding composition and decomposition are reversible, i.e. $\mathcal{C}_{\restbasis}(\mathcal{C}_{\restbasis}^{-1}[f]) \equiv f$.
We will refer such functions as restricted functions.

The result of any non-linear transformation of a function $f \in \mathbb{F}_{\restbasis}$ is not guaranteed to belong to $\mathbb{F}_{\restbasis}$ and requires explicit projection to be used with other restricted functions from the same subspace $\mathbb{F}_{\restbasis}$:

\begin{definition}
\label{def:func-calculus:projector}
	An arbitrary function can be projected to $\mathbb{F}_{\restbasis}$ using the projection transformation:
	\begin{eqn*}
		& \proj{\restbasis} \in \mathbb{F} \rightarrow \mathbb{F}_{\restbasis} \\
		& \proj{\restbasis}[f](\xvec)
		\equiv (\mathcal{C}_{\restbasis}(\mathcal{C}_{\restbasis}^{-1}[f])) (\xvec)
		= \sum_{\nvec \in \restbasis} \phi_{\nvec} \int
			\upd\xvec^\prime\, \phi_{\nvec}^{\prime*} f^\prime.
	\end{eqn*}
	Obviously, $\proj{\fullbasis} \equiv \mathds{1}$.
\end{definition}

Being applied to the delta function, the projection function produces a restricted delta function:

\begin{definition}
\label{def:func-calculus:restricted-delta}
	The restricted delta function $\delta_{\restbasis} \in \mathbb{F}_{\restbasis}$ is a projected form of standard delta function:
	\begin{eqn*}
		\delta_{\restbasis}(\xvec^\prime, \xvec)
		= \proj{\restbasis}[\delta]
		= \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*} \phi_{\nvec}.
	\end{eqn*}
	Note that in general $\delta_{\restbasis}^*(\xvec^\prime, \xvec) = \delta_{\restbasis}(\xvec, \xvec^\prime)$, so the order of variables is important.
	For a full basis, this definition coincides with the standard delta function: $\delta_{\fullbasis}(\xvec^\prime, \xvec) \equiv \delta(\xvec^\prime - \xvec)$.
\end{definition}

Projection transformation can be, in turn, expressed using the restricted delta function:
\begin{eqn}
	\proj{\restbasis}[f](\xvec) = \int \upd\xvec^\prime \delta_{\restbasis}(\xvec^\prime, \xvec) f^\prime.
\end{eqn}
The conjugate of $\proj{\restbasis}$ is therefore
\begin{eqn}
	(\proj{\restbasis}[f](\xvec))^*
	= \int \upd\xvec^\prime \delta_{\restbasis}^*(\xvec^\prime, \xvec) f^{\prime*}
	= \proj{\restbasis}^* [f^*](\xvec).
\end{eqn}


% =============================================================================
\section{Functional differentiation}
% =============================================================================

Let $\mathcal{F}[f] \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$ be some arbitrary functional operator (not to be confused with quantum mechanical operators) acting on functions from a restricted basis.
Such operator can be as simple as an algebraic function of $f$, for example, $\mathcal{F}[f] = f^2$, but it can also be more complicated.
Note that in general this operator is nor linear, therefore its result is not guaranteed to belong to the same restricted basis as its argument.

Composition and decomposition transformations from~\defref{func-calculus:composition} define a bijection between a restricted function space $\mathbb{F}_{\restbasis}$ and a vector space of the corresponding dimensionality $\mathbb{C}^{|\restbasis|}$ (where $|\restbasis|$ denotes the cardinality of $\restbasis$).
Therefore any functional operator $\mathcal{F}$ can be alternatively treated as a function of a vector of mode populations and a coordinate vector:
\begin{eqn}
	& F \in \mathbb{C}^{|\restbasis|} \rightarrow \mathbb{F}
		\equiv \mathbb{C}^{|\restbasis|} \rightarrow \mathbb{R}^D \rightarrow \mathbb{C} \\
	& F(\balpha, \xvec) \equiv \mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)](\xvec).
\end{eqn}
Since the operator is not linear, this correspondence in general cannot be expressed in a form of matrix.

Using this correspondence, we can define the differentiation in the space of functional operators:

\begin{definition}
\label{def:func-calculus:func-diff}
	Derivative of a functional operator is
	\begin{eqn*}
		& \frac{\updelta}{\updelta f^\prime} \in
		\left(
			\mathbb{F}_{\restbasis} \rightarrow \mathbb{F}
		\right)
		\rightarrow
		\left(
			\mathbb{R}^D \rightarrow \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}
		\right) \\
		& \frac{\updelta \mathcal{F}[f]}{\updelta f^\prime}
		= \left.
				\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
				\frac{\upd \mathcal{F}[\mathcal{C}_{\restbasis}(\balpha)]}{\upd \alpha_{\nvec}}
			\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]}.
	\end{eqn*}
\end{definition}

Note that the type of the returned operator differs from the argument type: the result depends on two coordinates, not just one.
The second coordinate ($\xvec^\prime$) comes from the function $f^\prime \equiv f(\xvec^\prime)$ we are differentiating by.

This definition may look too elaborate at first, but later in this section we will see that it leads to intuitive consequences, making the functional derivative behave very similar to the Wirtinger derivative from~\appref{c-numbers}.
Let us first demonstrate that the definition obeys standard differentiation rules.

\begin{theorem}
	Functional differentiation from~\defref{func-calculus:func-diff} obeys sum, product, quotient, and chain differentiation rules.
	The latter one is applied as if $\mathcal{F}[f]$ was a function of two independent variables $f$ and $f^*$:
	\begin{eqn*}
		\frac{\updelta \mathcal{F}[\mathcal{G}[f]]}{\updelta f^\prime}
			= \int \upd\xvec^{\prime\prime} \left(
				\frac{\updelta \mathcal{F}}{\updelta \mathcal{G}^{\prime\prime}}
				\frac{\updelta \mathcal{G}}{\updelta \mathcal{f}^{\prime}}
				+ \frac{\updelta \mathcal{F}}{\updelta \mathcal{G}^{\prime\prime*}}
				\frac{\updelta \mathcal{G}^*}{\updelta \mathcal{f}^{\prime}}
			\right).
	\end{eqn*}
\end{theorem}
\begin{proof}
First tree rules are proved straightforwardly by substituting $\mathcal{F} + \mathcal{G}$, $\mathcal{F} \mathcal{G}$ and $\mathcal{F} / \mathcal{G}$ into~\defref{func-calculus:func-diff}.
To prove the latter, let us substitute $\mathcal{F}[\mathcal{G}]$ into the definition:
\begin{eqn}
\label{eqn:func-calculus:chain-expansion}
	\frac{\updelta \mathcal{F}[\mathcal{G}[f]]}{\updelta f^\prime}
		& = \left.
				\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
				\frac{\upd \mathcal{F}[\mathcal{G}[\mathcal{C}_{\restbasis}(\balpha)]]}{\upd \alpha_{\nvec}}
			\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
		& = \left.
				\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
				\frac{\upd \mathcal{F}[\mathcal{C}(\bbeta)]}{\upd \alpha_{\nvec}}
			\right|_{\bbeta = \mathcal{C}^{-1}[\mathcal{G}[\mathcal{C}_{\restbasis}(\balpha)]]}.
\end{eqn}
Applying the chain rule for Wirtinger derivatives, and recalling the definition of the decomposition transformation:
\begin{eqn}
	\frac{\upd \mathcal{F}[\mathcal{C}(\bbeta)]}{\upd \alpha_{\nvec}}
	= \sum_{\mvec \in \fullbasis} \left(
		\frac{\upd \mathcal{F}[\mathcal{C}(\bbeta)]}{\upd \beta_{\mvec}}
		\frac{\upd \beta_{\mvec}}{\upd \alpha_{\nvec}}
		+ \frac{\upd \mathcal{F}[\mathcal{C}(\bbeta)]}{\upd \beta_{\mvec}^*}
		\frac{\upd \beta_{\mvec}^*}{\upd \alpha_{\nvec}}
	\right),
\end{eqn}
\begin{eqn}
	\frac{\upd \beta_{\mvec}}{\upd \alpha_{\nvec}}
	= \frac{\upd (\mathcal{C}^{-1}[G(\balpha, \xvec)])_{\mvec}}{\upd \alpha_{\nvec}}
	= \int \upd\xvec^{\prime\prime} \phi_{\mvec}^{\prime\prime*}
		\frac{\upd G(\balpha, \xvec)}{\upd \alpha_{\nvec}},
\end{eqn}
\begin{eqn}
	\frac{\upd \beta_{\mvec}^*}{\upd \alpha_{\nvec}}
	= \int \upd\xvec^{\prime\prime} \phi_{\mvec}^{\prime\prime}
		\frac{\upd G^*(\balpha, \xvec)}{\upd \alpha_{\nvec}}.
\end{eqn}
Substituting this into~\eqnref{func-calculus:chain-expansion}, we get
\begin{eqn}
	\frac{\updelta \mathcal{F}[\mathcal{G}[f]]}{\updelta f^\prime}
		={} & \int \upd\xvec^{\prime\prime}
			\sum_{\mvec \in \fullbasis}
				\phi_{\mvec}^{\prime\prime*}
				\left.
					\frac{\upd \mathcal{F}[\mathcal{C}(\bbeta)]}{\upd \beta_{\mvec}}
				\right|_{\bbeta = \mathcal{C}^{-1}[\mathcal{G}[f]]}
			\sum_{\nvec \in \restbasis}
				\phi_{\nvec}^{\prime*}
				\left.
					\frac{\upd \mathcal{G}[\mathcal{C}(\balpha)]}{\upd \alpha_{\nvec}}
				\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
		& + \sum_{\mvec \in \fullbasis}
				\phi_{\mvec}^{\prime\prime}
				\left.
					\frac{\upd \mathcal{F}[\mathcal{C}(\bbeta)]}{\upd \beta_{\mvec}^*}
				\right|_{\bbeta = \mathcal{C}^{-1}[\mathcal{G}[f]]}
			\sum_{\nvec \in \restbasis}
				\phi_{\nvec}^{\prime*}
				\left.
					\frac{\upd \mathcal{G}^*[\mathcal{C}(\balpha)]}{\upd \alpha_{\nvec}}
				\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]}.
\end{eqn}
Recognizing~\defref{func-calculus:func-diff} for $\updelta \mathcal{F} / \updelta \mathcal{G}$ and $\updelta \mathcal{G} / \updelta \mathcal{f}$, we get the final expression
\begin{eqn}
	\frac{\updelta \mathcal{F}[\mathcal{G}[f]]}{\updelta f^\prime}
		= \int \upd\xvec^{\prime\prime} \left(
			\frac{\updelta \mathcal{F}}{\updelta \mathcal{G}^{\prime\prime}}
			\frac{\updelta \mathcal{G}}{\updelta \mathcal{f}^{\prime}}
			+ \frac{\updelta \mathcal{F}}{\updelta \mathcal{G}^{\prime\prime*}}
			\frac{\updelta \mathcal{G}^*}{\updelta \mathcal{f}^{\prime}}
		\right).
\end{eqn}
\end{proof}

The above lemma demonstrates that, with respect to differentiation, functional operators behave as if they were depending on two independent functions, $f$ and $f^*$ --- much like complex-valued functions with respect to Wirtinger differentiation.

Most of the time we will deal with functional operators in a particular form, namely the algebraic expressions of their arguments.
It turns out that for this subset functional differentiation behaves almost exactly like Wirtinger differentiation and allows one to circumvent~\defref{func-calculus:func-diff}, calculating derivatives based on well-known symbolic rules.

\begin{theorem}
	If a functional operator $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$ has the form $\mathcal{F}[f, f^*] \equiv g(f, f^*)$, where $g(z, z^*)$ is a function that can be expanded into power series of $z^r (z^*)^s$, then $\delta \mathcal{F} / \delta f^\prime$ and $\delta \mathcal{F} / \delta f^{\prime*}$ can be calculated as derivatives of $g(f, f^*)$ over $f$ and $f^*$, respectively, times the restricted delta function:
	\begin{eqn*}
		\frac{\updelta \mathcal{F}}{\updelta f^\prime}
		= \delta_{\restbasis}(\xvec^\prime, \xvec) \left.
			\frac{\upd g(z, z^*)}{\upd z}
		\right|_{z=f(x)},
		\quad
		\frac{\updelta \mathcal{F}}{\updelta f^{\prime*}}
		= \delta_{\restbasis}^*(\xvec^\prime, \xvec) \left.
			\frac{\upd g(z, z^*)}{\upd z^*}
		\right|_{z=f(x)}.
	\end{eqn*}
\end{theorem}
\begin{proof}
We will prove the first identity.
Without loss of generality, we can consider $\mathcal{F} = f^r (f^*)^s$.
Substituting this into~\defref{func-calculus:func-diff}, differentiating the composition according to~\defref{func-calculus:composition} and recognizing the restricted delta function:
\begin{eqn}
	\frac{\updelta \mathcal{F}}{\updelta f^\prime}
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
		\left.
			\frac{\upd \left(
				\mathcal{C}_{\restbasis}^r(\balpha)
				(\mathcal{C}_{\restbasis}^*(\balpha))^s
			\right)}{\upd \alpha_{\nvec}}
		\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
		r \phi_{\nvec}
		\left.
			\mathcal{C}_{\restbasis}^{r-1}(\balpha)
			(\mathcal{C}_{\restbasis}^*(\balpha))^s
		\right|_{\balpha = \mathcal{C}_{\restbasis}^{-1}[f]} \\
	& = r \delta_{\restbasis}(\xvec^\prime, \xvec) f^{r-1} (f^*)^s
	= \delta_{\restbasis}(\xvec^\prime, \xvec) \left.
			\frac{\upd g(z, z^*)}{\upd z}
		\right|_{z=f(x)}.
\end{eqn}
The second identity is proved in the same way.
\end{proof}


% =============================================================================
\section{Functional integration}
% =============================================================================

Functional integration is defined as

\begin{definition}
	\begin{eqn*}
		& \int \delta^2 f \in (\mathbb{F}_{\restbasis} \rightarrow \mathbb{F}) \rightarrow \mathbb{C} \\
		& \int \delta^2 f \mathcal{F}[f]
		= \int d^2\balpha \mathcal{F}(\balpha)
		= \left(
			\prod_{\nvec \in \restbasis} \int d^2\alpha_{\nvec}
		\right) \mathcal{F}(\balpha),
	\end{eqn*}
	where the product of integrals stands for their successive application.
    If the basis contains an infinite number of modes, the integral is treated as a limit $|\restbasis| \rightarrow \infty$.
	\todo{\cite{Dalton2011} has detailed explanation, do we need it here?}
\end{definition}

Functional integration has the Fourier-like property analogous to \lmmref{c-numbers:fourier-of-moments}, but its statement requires the definition of the delta functional:

\begin{definition}
\label{def:func-calculus:delta-functional}
	For a function $\Lambda \in \mathbb{F}_{\restbasis}$ the delta functional is
	\begin{eqn*}
		\Delta_{\restbasis}[\Lambda]
		\equiv \prod_{\nvec \in \restbasis} \delta(\Real \lambda_{\nvec}) \delta(\Imag \lambda_{\nvec}),
	\end{eqn*}
	where $\blambda = \mathcal{C}_{\restbasis}^{-1}[\Lambda]$.
\end{definition}

The delta functional has the same property as the common delta function:
\begin{eqn}
	\int \delta^2 \Lambda \mathcal{F}[\Lambda] \Delta_{\restbasis}[\Lambda]
	& = \left(
			\prod_{\nvec \in \restbasis} \int d^2\lambda_{\nvec}
		\right)
		\mathcal{F}(\blambda)
		\prod_{\nvec \in \restbasis} \delta(\Real \lambda_{\nvec}) \delta(\Imag \lambda_{\nvec}) \\
	& = \left. \mathcal{F}(\blambda) \right|_{\forall \nvec \in \restbasis\, \lambda_{\nvec} = 0} \\
	& = \left. \mathcal{F}[\Lambda] \right|_{\Lambda \equiv 0}
\end{eqn}

\begin{lemma}[Functional extension of \lmmref{c-numbers:fourier-of-moments}]
\label{lmm:func-calculus:fourier-of-moments}
	For $\Psi \in \mathbb{F}_{\restbasis}$ and $\Lambda \in \mathbb{F}_{\restbasis}$, and for any non-negative integers $r$ and $s$:
	\begin{eqn*}
		\int \delta^2\Psi\, \Psi^r (\Psi^*)^s \exp
			\int d\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right)
		= \pi^{2|\restbasis|}
			\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
			\left( \frac{\delta}{\delta \Lambda} \right)^s
			\Delta_{\restbasis}[\Lambda]
	\end{eqn*}
\end{lemma}
\begin{proof}
\begin{eqn}
	& \int \delta^2\Psi\, \Psi^r (\Psi^*)^s \exp
		\int d\xvec \left( -\Lambda \Psi^* + \Lambda^* \Psi \right) \\
	& = \left(
			\prod_{\nvec \in \restbasis} \int d^2\alpha_{\nvec}
		\right)
		\left( \sum_{\nvec \in \restbasis} \phi_{\nvec} \alpha_{\nvec} \right)^r
		\left( \sum_{\nvec \in \restbasis} \phi^*_{\nvec} \alpha_{\nvec}^* \right)^s
		\prod_{\nvec \in \restbasis} \exp(-\lambda_{\nvec} \alpha_{\nvec}^* + \lambda_{\nvec}^* \alpha_{\nvec}).
\end{eqn}
Expanding powers of $\Psi$ and $\Psi^*$ using multinomial theorem:
\begin{eqn2}
	& ={} && \left(
			\prod_{\nvec \in \restbasis} \int d^2\alpha_{\nvec}
		\right)
		\left(
			\sum_{\sum u_{\mvec} = r} \binom{r}{ \left\{ u_{\mvec} \right\} }
			\prod_{\nvec \in \restbasis} \phi_{\nvec}^{u_{\nvec}} \alpha_{\nvec}^{u_{\nvec}}
		\right) \\
	& && \left(
			\sum_{\sum v_{\mvec} = s} \binom{s}{ \left\{ v_{\mvec} \right\} }
			\prod_{\nvec \in \restbasis} (\phi_{\nvec}^*)^{v_{\nvec}} (\alpha_{\nvec}^*)^{v_{\nvec}}
		\right)
		\prod_{\nvec \in \restbasis} \exp(-\lambda_{\nvec} \alpha_{\nvec}^* + \lambda_{\nvec}^* \alpha_{\nvec}),
\end{eqn2}
where $\binom{r}{ \left\{ u_{\mvec} \right\} } \equiv r! / (\prod u_{\mvec}!)$ are multinomial coefficients.
Splitting variables:
\begin{eqn2}
	& ={} && \sum_{ \sum u_{\mvec} = r,\, \sum v_{\mvec} = s }
		\binom{r}{ \left\{ u_{\mvec} \right\} }
		\binom{s}{ \left\{ v_{\mvec} \right\} } \\
	& && \prod_{\nvec \in \restbasis}
			\phi_{\nvec}^{u_{\nvec}} (\phi_{\nvec}^*)^{v_{\nvec}}
			\int d^2\alpha_{\nvec}
				\alpha_{\nvec}^{u_{\nvec}}
				(\alpha_{\nvec}^*)^{v_{\nvec}}
				\exp(-\lambda_{\nvec} \alpha_{\nvec}^* + \lambda_{\nvec}^* \alpha_{\nvec}).
\end{eqn2}
Applying \lmmref{c-numbers:fourier-of-moments}, collapsing sums, and recognizing \defref{func-calculus:func-diff} and \defref{func-calculus:delta-functional}:
\begin{eqn2}
	& ={} && \sum_{\sum u_{\mvec} = r,\, \sum v_{\mvec} = s}
		\binom{r}{ \left\{ u_{\mvec} \right\} }
		\binom{s}{ \left\{ v_{\mvec} \right\} }
		\pi^{2|\restbasis|} \\
	& && \prod_{\nvec \in \restbasis}
			\phi_{\nvec}^{u_{\nvec}} (\phi_{\nvec}^*)^{v_{\nvec}}
			\left( -\frac{\partial}{\partial \lambda_{\nvec}^*} \right)^{u_{\nvec}}
			\left( \frac{\partial}{\partial \lambda_{\nvec}} \right)^{v_{\nvec}}
			\delta(\Real \lambda_{\nvec}) \delta(\Imag \lambda_{\nvec}) \\
	& ={} && \pi^{2|\restbasis|}
		\left( -\sum_{\nvec \in \restbasis} \phi_{\nvec} \frac{\partial}{\partial \lambda_{\nvec}^*} \right)^r
		\left( \sum_{\nvec \in \restbasis} \phi_{\nvec}^* \frac{\partial}{\partial \lambda_{\nvec}} \right)^s
		\prod_{\nvec \in \restbasis} \delta(\Real \lambda_{\nvec}) \delta(\Imag \lambda_{\nvec}) \\
	& ={} && \pi^{2|\restbasis|}
		\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
		\left( \frac{\delta}{\delta \Lambda} \right)^s
		\Delta_{\restbasis}[\Lambda]
	\qedhere
\end{eqn2}
\end{proof}

\begin{definition}
	Displacement functional is
	\begin{eqn}
		& D \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}_{\restbasis} \rightarrow \mathbb{C} \\
		& D[\Lambda, \Lambda^*, \Psi, \Psi^*] = \exp \int d\xvec \left(
			-\Lambda \Psi^* + \Lambda^* \Psi
		\right).
	\end{eqn}
\end{definition}

\begin{lemma}[Functional extension of \lmmref{c-numbers:zero-integrals}]
\label{lmm:func-calculus:zero-integrals}
	For a bounded functional $F(\blambda, \blambda^*)$
	\begin{eqn*}
		\int \delta^2\Lambda
			\frac{\delta}{\delta \Lambda^\prime} \left(
				D[\Lambda, \Lambda^*, \Psi, \Psi^*]
				F[\Lambda, \Lambda^*]
			\right)
		& = 0 \\
		\int \delta^2\Lambda
			\frac{\delta}{\delta \Lambda^{\prime*}}
			\left(
				D[\Lambda, \Lambda^*, \Psi, \Psi^*]
				F[\Lambda, \Lambda^*]
			\right)
		& = 0.
	\end{eqn*}
\end{lemma}
\begin{proof}
We will prove the first equation.
Let $\Lambda = \mathcal{C}_{\restbasis}(\blambda)$ and $\Psi = \mathcal{C}_{\restbasis}(\balpha)$.
Displacement functional can be represented as a function of mode vector:
\begin{eqn}
	D[\Lambda, \Lambda^*, \Psi, \Psi^*]
	& = \exp \int dx \sum_{\nvec \in \restbasis,\mvec \in \restbasis} \left(
		- \phi_{\nvec} \phi_{\mvec}^* \lambda_{\nvec} \alpha_{\mvec}^*
		+ \phi_{\nvec}^* \phi_{\mvec} \lambda_{\nvec}^* \alpha_{\mvec}
	\right) \\
	& = \exp \sum_{\nvec \in \restbasis,\mvec \in \restbasis} \left(
		- \delta_{\nvec \mvec} \lambda_{\nvec} \alpha_{\nvec}^*
		+ \delta_{\nvec \mvec} \lambda_{\nvec}^* \alpha_{\nvec}
	\right) \\
	& = \exp \sum_{\nvec \in \restbasis} \left(
		-\lambda_{\nvec} \alpha_{\nvec}^* + \lambda_{\nvec}^* \alpha_{\nvec}
	\right).
\end{eqn}

We introduce the special notation for this lemma to indicate the subset of $\restbasis$ used by operators and functionals.
With this notation, for fixed $\nvec$:
\begin{eqn}
	D[\Lambda, \Lambda^*, \Psi, \Psi^*]
	& = \prod_{\mvec \in \restbasis} \exp \left(
		- \lambda_{\mvec} \alpha_{\mvec}^* + \lambda_{\mvec}^* \alpha_{\mvec}
	\right) \\
	& = \exp \left(
		- \lambda_{\nvec} \alpha_{\nvec}^* + \lambda_{\nvec}^* \alpha_{\nvec}
	\right)
	\prod_{\mvec \in \restbasis, \mvec \ne \nvec} \exp \left(
		- \lambda_{\mvec} \alpha_{\mvec}^* + \lambda_{\mvec}^* \alpha_{\mvec}
	\right) \\
	& = D_{\lnot \nvec} D_{\nvec},
\end{eqn}
and, similarly,
\begin{eqn}
	\Lambda & = \Lambda_{\lnot \nvec} + \Lambda_{\nvec}, \\
	\int d^2 \blambda & = \int d^2 \blambda_{\lnot \nvec} \int d^2 \lambda_{\nvec}.
\end{eqn}

With this notation:
\begin{eqn}
	& \int \delta^2\Lambda
		\frac{\delta}{\delta \Lambda^\prime} \left(
			D[\Lambda, \Lambda^*, \Psi, \Psi^*]
			F[\Lambda, \Lambda^*]
		\right) \\
	& = \int d^2 \blambda
		\sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*} \frac{\partial}{\partial \lambda_{\nvec}}
			D_{\lnot \nvec} D_{\nvec}
			F[\Lambda, \Lambda^*] \\
	& = \sum_{\nvec \in \restbasis} \phi_{\nvec}^{\prime*}
		\int d^2 \blambda_{\lnot \nvec} D_{\lnot \nvec}
		\int d^2 \lambda_{\nvec} \frac{\partial}{\partial \lambda_{\nvec}} D_{\nvec} F(\blambda, \blambda^*).
\end{eqn}
For each term the internal is equal to zero because of \lmmref{c-numbers:zero-integrals}, therefore the whole sum is zero.
\end{proof}

\begin{lemma}[Functional extension of \lmmref{c-numbers:zero-delta-integrals}]
\label{lmm:func-calculus:zero-delta-integrals}
	For $\Lambda \in \mathbb{F}_{\restbasis}$ \todo{Again, any limitations on $F$?}
	\begin{eqn*}
		\int \delta^2\Lambda
			\frac{\delta}{\delta \Lambda} \left(
				\left(
					\left( \frac{\delta}{\delta \Lambda} \right)^s
					\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
					\Delta_{\restbasis}[\Lambda]
				\right)
				F[\lambda, \lambda^*]
			\right)
		& = 0 \\
		\int \delta^2\Lambda
			\frac{\delta}{\delta \Lambda^*} \left(
				\left(
					\left( \frac{\delta}{\delta \Lambda} \right)^s
					\left( -\frac{\delta}{\delta \Lambda^*} \right)^r
					\Delta_{\restbasis}[\Lambda]
				\right)
				F[\lambda, \lambda^*]
			\right)
		& = 0 \\
	\end{eqn*}
\end{lemma}
\begin{proof}
Proved by expanding functional integration and differentials into modes and recognizing \lmmref{c-numbers:zero-delta-integrals}.
\end{proof}

In order to perform transformations of master equations in the future, we will need a lemma, which justifies certain operation with Laplacian (which is a part of kinetic term in Hamiltonian).

\begin{lemma}
\label{lmm:func-calculus:move-laplacian}
	If $\forall \nvec \in \restbasis\, \xvec \in \partial A$ $\phi_n(\xvec) = 0$, then for any $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$
	\begin{eqn*}
		\int\limits_A d\xvec \left(
			\nabla^2 \frac{\delta}{\delta \Psi}
		\right) \Psi \mathcal{F}[\Psi, \Psi^*]
		= \int\limits_A d\xvec \frac{\delta}{\delta \Psi}
		( \nabla^2 \Psi ) \mathcal{F}[\Psi, \Psi^*]
	\end{eqn*}
\end{lemma}
\begin{proof}
Integration limits play an important role in this proof, so we will write them explicitly.
\begin{eqn}
	\int\limits_A d\xvec \left(
		\nabla^2 \frac{\delta}{\delta \Psi}
	\right) \Psi
	= \sum_{\nvec \in \restbasis, \mvec \in \restbasis} \left(
			\int\limits_A d\xvec ( \nabla^2 \phi_{\nvec}^* ) \phi_{\mvec}
		\right)
		\frac{\partial}{\partial \alpha_{\nvec}} \alpha_{\mvec} \mathcal{F}(\mathbf{\alpha})
	= (*)
\end{eqn}
Using Green's first identity and the fact that eigenfunctions are equal to zero at the boundary of $A$:
\begin{eqn}
	\int\limits_A d\xvec ( \nabla^2 \phi_{\nvec}^* ) \phi_{\mvec}
	& = \oint\limits_{\partial A} \phi_{\mvec} (\nabla \phi_{\nvec}^* \cdot \mathbf{v}) dS
	- \int\limits_A d\xvec ( \nabla \phi_{\nvec}^* ) ( \nabla \phi_{\mvec} ) \\
	& = 0 - \int\limits_A d\xvec ( \nabla \phi_{\nvec}^* ) ( \nabla \phi_{\mvec} ) \\
	& = \oint\limits_{\partial A} \phi_{\nvec}^* (\nabla \phi_{\mvec} \cdot \mathbf{v}) dS
	- \int\limits_A d\xvec ( \nabla \phi_{\nvec}^* ) ( \nabla \phi_{\mvec} ) \\
	& = \int\limits_A d\xvec \phi_{\nvec}^* ( \nabla^2 \phi_{\mvec} ),
\end{eqn}
where $\mathbf{v}$ is the outward pointing unit normal of surface element $dS$.
Thus
\begin{eqn}
	(*)
	= \sum_{\nvec \in \restbasis, \mvec \in \restbasis} \left(
			\int\limits_A d\xvec \phi_{\nvec}^* ( \nabla^2 \phi_{\mvec} )
		\right)
		\frac{\partial}{\partial \alpha_{\nvec}} \alpha_{\mvec} \mathcal{F}(\mathbf{\alpha})
	= \int\limits_A d\xvec \frac{\delta}{\delta \Psi}
		( \nabla^2 \Psi ) \mathcal{F}[\Psi, \Psi^*].
	\qedhere
\end{eqn}
\end{proof}

Note that this lemma imposes additional requirement for basis functions, but in practical applications it is always satisfied.
For example, in plane wave basis eigenfunctions are equal to zero at the border of the bounding box, and in harmonic oscillator basis they are equal to zero on the infinity (which can be considered the boundary of their integration area).
Hereinafter we will assume that this condition is true for any basis we work with.
