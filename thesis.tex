%% Build with LuaLaTeX

% replace oneside by twoside for final print
\documentclass[headings=optiontohead,chapterprefix=true,oneside,a4paper,12pt,
    %DIV=9,BCOR=0mm,
    cleardoublepage=empty]{scrbook}


% Page layout
\usepackage[top=20mm, bottom=30mm, left=20mm, right=40mm]{geometry}
\renewcommand{\baselinestretch}{1.5} % 1.5 interval


% regular includes
\usepackage{fontspec}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{thmtools} % more convenient theorem style definitions
\usepackage{unicode-math}
\usepackage{dsfont}
\usepackage{microtype}
\usepackage[british]{babel}
\usepackage[margin=5pt]{subfig}
\usepackage{verbatim}
\usepackage{psfrag}
\usepackage[nottoc]{tocbibind} % include ToC and Bibliography in ToC
\usepackage{environ} % gives \NewEnviron macro
\usepackage{chngcntr} % provides \counterwithin to add appendix letter to theorems, lemmas etc
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{setspace}
\usepackage{cite} % cite successive references as lists, i.e. [1-5] instead of [1,2,3,4,5]


% Set document fonts
\include{fonts}


% Font for elements
\addtokomafont{chapterprefix}{\captionfont}
\addtokomafont{chapter}{\captionfont\scshape}
\addtokomafont{section}{\captionfont}
\addtokomafont{subsection}{\captionfont}
\addtokomafont{chapterentry}{\rmfamily\scshape\bfseries}
\addtokomafont{chapterentrypagenumber}{\normalfont\rmfamily\bfseries}

\captionsetup[figure]{labelfont=sc}
\captionsetup[subfigure]{labelfont=normalfont}


% Page headers and footers
\pagestyle{fancy}
\renewcommand{\chapterpagestyle}{empty} % force no page headers or footers on chapter pages
\lhead{\nouppercase{\rightmark}} % get rid of uppercaseness in headings
\rhead{\nouppercase{\leftmark}} % get rid of uppercaseness in headings
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.\ #1}{}}
\fancyfoot{} % no footers

\newcommand{\normalheaders}{
\if@twoside
\fancyhead[RO,LE]{\scshape\leftmark} % chapter name in small caps on the inner side
\fancyhead[RE,LO]{\thepage} % page number on the outer side
\else
\fancyhead[L]{\scshape\leftmark}
\fancyhead[R]{\thepage}
\fi}

% have to do it explicitly, because otherwise I cannot get rid of uppercaseness
\newcommand{\bibliographyheaders}{
\if@twoside
\fancyhead[RO,LE]{\scshape Bibliography} % chapter name in small caps on the inner side
\fancyhead[RE,LO]{\thepage} % page number on the outer side
\else
\fancyhead[L]{\scshape Bibliography}
\fancyhead[R]{\thepage}
\fi}


% All sorts of macros used in the text
\include{macros}


% Document properties
% (couldn't make hyperref work with the result of the linebreak-dropping macro)
\newcommand{\thesisname}{Quasiprobability representations of quantum dynamics}
\newcommand{\plainthesisname}{Quasiprobability representations of quantum dynamics}
\title{\plainthesisname}
\author{Bogdan Opanchuk}


% PDF properties
\definecolor{mainred}{HTML}{E63717}
\definecolor{darkred}{HTML}{8F4B3F}
\definecolor{mainblue}{HTML}{1F409A}
\definecolor{lightblue}{HTML}{7392E6}
\usepackage[bookmarks, bookmarkstype=toc, unicode, pdfencoding=auto, backref=page, breaklinks, pdftitle={PhD thesis: \plainthesisname}, pdfauthor={Bogdan Opanchuk}, colorlinks, urlcolor=mainblue, citecolor=darkred, linkcolor=mainblue]{hyperref}

\newcommand{\todo}[1]{\textcolor{mainred}{[#1]}}
\newcommand{\citationneeded}{\textcolor{mainred}{[citation needed]}}


% Format for back references in bibliography
\renewcommand*{\backref}[1]{}% for backref < 1.33 necessary
\renewcommand*{\backrefalt}[4]{%
\ifcase #1 % No citations.%
\or
[p~#2]%
\else
[pp~#2]%
\fi }


\begin{document}

\normalheaders

\frontmatter

\include{frontmatter}

\begin{spacing}{1}
% There is a problem with the list of figures and "small caps appendices labels":
% I cannot find a way to display figure labels in small caps in this list without
% making the whole caption small caps.
% So I am commenting that for the time being, becuase, frankly,
% the list of figures seems to be quite useless.
%\listoffigures
\tableofcontents
\end{spacing}

\mainmatter

\counterwithin{lemma}{chapter}
\counterwithin{theorem}{chapter}
\counterwithin{definition}{chapter}

\include{chapters/introduction}

% theory
\include{chapters/mm-wigner}
\include{chapters/wigner}
\include{chapters/wigner-spec}
\include{chapters/wigner-bec}

% applications
\include{chapters/bec-noise}
\include{chapters/bec-squeezing}
\include{chapters/epr-two-well}
\include{chapters/bell-ineq}

\include{chapters/conclusion}

\appendix

% In order to use small caps in all labels including appendix number,
% we need the counter to use small letters.
\renewcommand{\thechapter}{\alph{chapter}}

\include{chapters/c-numbers}
\include{chapters/func-calculus}
\include{chapters/fpe-sde}
\include{chapters/numerical}

% unsorted stuff that may be useful; to be removed the in final version
\include{chapters/notes}

\begin{spacing}{1}
\bibliographyheaders
\bibliographystyle{thesis}
\bibliography{thesis}
\end{spacing}

\end{document}
