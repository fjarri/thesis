% replace oneside by twoside for final print
\documentclass[headings=optiontohead,chapterprefix=true,oneside,a4paper,11pt,
    cleardoublepage=empty]{scrbook}


% A bit of magic to make amsfonts work with unicode-math
\usepackage[no-math]{fontspec}
\ExplSyntaxOn
\int_new:N \l_mathcode_minus_int
\int_new:N \l_mathcode_equal_int
\exp_args:Nx \AtBeginDocument {
  \exp_not:n {
    \int_set:Nn \l_mathcode_minus_int { \XeTeXmathcodenum `\- }
    \int_set:Nn \l_mathcode_equal_int { \XeTeXmathcodenum `\= }
  }
  \mathcode \int_eval:n { `\- } = \number \mathcode `\- \scan_stop:
  \mathcode \int_eval:n { `\= } = \number \mathcode `\= \scan_stop:
}
\usepackage{amsmath}
\AtBeginDocument {
  \XeTeXmathcodenum `\- = \l_mathcode_minus_int
  \XeTeXmathcodenum `\= = \l_mathcode_equal_int
}
\ExplSyntaxOff
\usepackage[italic,noendash]{mathastext}


% regular includes
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{thmtools} % more convenient theorem style definitions
\usepackage{unicode-math}
\usepackage{dsfont}
\usepackage{microtype}
\usepackage{polyglossia}
\usepackage[margin=5pt]{subfig}
\usepackage{verbatim}
\usepackage{psfrag}
\usepackage[nottoc]{tocbibind}
\usepackage{environ} % gives \NewEnviron macro
\usepackage{chngcntr} % provides \counterwithin to add appendix letter to theorems, lemmas etc
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{setspace}


% Set document fonts
\include{fonts}
\UseMicrotypeSet[protrusion]{maintext} % 'maintext' family is defined in fonts.tex


% Hyphenation properties
\setmainlanguage[variant=british]{english}


% Page layout
\usepackage[top=30mm, bottom=20mm, left=40mm, right=20mm]{geometry}
\renewcommand{\baselinestretch}{1.5} % 1.5 interval


% Font for elements
\addtokomafont{chapterprefix}{\captionfont}
\addtokomafont{chapter}{\captionfont\scshape}
\addtokomafont{section}{\captionfont}
\addtokomafont{subsection}{\captionfont}
\addtokomafont{chapterentry}{\rmfamily\scshape\bfseries}
\addtokomafont{chapterentrypagenumber}{\normalfont\rmfamily\bfseries}

\captionsetup[figure]{labelfont=sc}
\captionsetup[subfigure]{labelfont=normalfont}


% Page headers and footers
\pagestyle{fancy}
\renewcommand{\chapterpagestyle}{empty} % force no page headers or footers on chapter pages
\lhead{\nouppercase{\rightmark}} % get rid of uppercaseness in headings
\rhead{\nouppercase{\leftmark}} % get rid of uppercaseness in headings
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.\ #1}{}}
\fancyfoot{} % no footers

\newcommand{\normalheaders}{
\if@twoside
\fancyhead[RO,LE]{\scshape\leftmark} % chapter name in small caps on the inner side
\fancyhead[RE,LO]{\thepage} % page number on the outer side
\else
\fancyhead[L]{\scshape\leftmark}
\fancyhead[R]{\thepage}
\fi}

% have to do it explicitly, because otherwise I cannot get rid of uppercaseness
\newcommand{\bibliographyheaders}{
\if@twoside
\fancyhead[RO,LE]{\scshape Bibliography} % chapter name in small caps on the inner side
\fancyhead[RE,LO]{\thepage} % page number on the outer side
\else
\fancyhead[L]{\scshape Bibliography}
\fancyhead[R]{\thepage}
\fi}


% All sorts of macros used in the text
\include{macros}


% Document properties
\title{Two-component BEC dynamics simulations}
\author{Bogdan Opanchuk}


% PDF properties
\definecolor{citation}{HTML}{A60000}
\definecolor{link}{HTML}{3515B0}
\usepackage[bookmarks, bookmarkstype=toc, unicode, pdfencoding=auto, backref=page, breaklinks, pdftitle={PhD thesis: Two-component BEC dynamics simulations}, pdfauthor={Bogdan Opanchuk}, colorlinks, urlcolor=blue, citecolor=citation, linkcolor=link]{hyperref}


% Format for back references in bibliography
\renewcommand*{\backref}[1]{}% for backref < 1.33 necessary
\renewcommand*{\backrefalt}[4]{%
\ifcase #1 % No citations.%
\or
[p~#2]%
\else
[pp~#2]%
\fi }


\begin{document}

\normalheaders

\frontmatter

\include{frontmatter}

\begin{spacing}{1}
% There is a problem with the list of figures and "small caps appendices labels":
% I cannot find a way to display figure labels in small caps in this list without
% making the whole caption small caps.
% So I am commenting that for the time being, becuase, frankly,
% the list of figures seems to be quite useless.
%\listoffigures
\tableofcontents
\end{spacing}

\mainmatter

\include{chapters/introduction}

% theory
\include{chapters/op-calculus}
\include{chapters/wigner}
\include{chapters/wigner-spec}
\include{chapters/wigner-bec}

% applications
\include{chapters/bec-noise}
\include{chapters/bec-squeezing}
\include{chapters/epr-two-well}
\include{chapters/bell-ineq}

\include{chapters/conclusion}

\appendix

% In order to use small caps in all labels including appendix number,
% we need the counter to use small letters.
\renewcommand{\thechapter}{\alph{chapter}}

\counterwithin{lemma}{chapter}
\counterwithin{theorem}{chapter}
\counterwithin{definition}{chapter}

\include{chapters/c-numbers}
\include{chapters/func-calculus}
\include{chapters/fpe-sde}
\include{chapters/numerical}

% unsorted stuff that may be useful; to be removed the in final version
\include{chapters/notes}

\begin{spacing}{1}
\bibliographyheaders
\bibliographystyle{thesis}
\bibliography{thesis}
\end{spacing}

\end{document}
