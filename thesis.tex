% replace oneside by twoside for final print
\documentclass[headings=optiontohead,chapterprefix=true,twoside,a4paper,11pt,
    cleardoublepage=empty]{scrbook}


% A bit of magic to make amsfonts work with unicode-math
\usepackage[no-math]{fontspec}
\ExplSyntaxOn
\int_new:N \l_mathcode_minus_int
\int_new:N \l_mathcode_equal_int
\exp_args:Nx \AtBeginDocument {
  \exp_not:n {
    \int_set:Nn \l_mathcode_minus_int { \XeTeXmathcodenum `\- }
    \int_set:Nn \l_mathcode_equal_int { \XeTeXmathcodenum `\= }
  }
  \mathcode \int_eval:n { `\- } = \number \mathcode `\- \scan_stop:
  \mathcode \int_eval:n { `\= } = \number \mathcode `\= \scan_stop:
}
\usepackage{amsmath}
\AtBeginDocument {
  \XeTeXmathcodenum `\- = \l_mathcode_minus_int
  \XeTeXmathcodenum `\= = \l_mathcode_equal_int
}
\ExplSyntaxOff
\usepackage[italic,noendash]{mathastext}


% regular includes
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{unicode-math}
\usepackage{dsfont}
\usepackage{microtype}
\usepackage{polyglossia}
\usepackage[margin=5pt]{subfig}
\usepackage{verbatim}
\usepackage{psfrag}
\usepackage[nottoc]{tocbibind}
\usepackage{environ} % gives \NewEnviron macro
\usepackage{chngcntr} % provides \counterwithin to add appendix letter to theorems, lemmas etc
\usepackage{xcolor}
\usepackage{fancyhdr}


% Set document fonts
\defaultfontfeatures{Ligatures=TeX, Numbers={Lining,Proportional},
  Scale=MatchLowercase, Mapping=tex-text}
\newfontfamily{\captionfont}
  [UprightFont={* Medium Caption},
   ItalicFont={* Medium Italic Caption},
   BoldFont={* Bold Caption},
   BoldItalicFont={* Bold Italic Caption}]
  {Minion Pro}
\setmainfont
  [UprightFont={* Medium},
   ItalicFont={* Medium Italic},
   BoldFont={* Bold},
   BoldItalicFont={* Bold Italic}]
  {Minion Pro}
%\setmathfont{XITS Math Mod}
\setmathfont{Asana Math}
\setsansfont{Helvetica}
\setmonofont{Menlo}
\DeclareMicrotypeSet{maintext}{family = {Minion Pro}}
\UseMicrotypeSet[protrusion]{maintext}


% Hyphenation properties
\setmainlanguage[variant=british]{english}


% Page layout
\usepackage[top=30mm, bottom=20mm, left=40mm, right=20mm]{geometry}
\renewcommand{\baselinestretch}{1.5} % 1.5 interval


% Font for elements
\setkomafont{chapterprefix}{\Huge\captionfont\bfseries\scshape}
\setkomafont{chapter}{\HUGE\captionfont\bfseries\scshape}
\setkomafont{section}{\LARGE\captionfont\bfseries}
\setkomafont{subsection}{\Large\captionfont\bfseries}
\setkomafont{chapterentry}{\rmfamily\bfseries}
\setkomafont{chapterentrypagenumber}{\rmfamily\bfseries}


% Page headers and footers
\pagestyle{fancy}
\renewcommand{\chapterpagestyle}{empty} % force no page headers or footers on chapter pages
\lhead{\nouppercase{\rightmark}} % get rid of uppercaseness in headings
\rhead{\nouppercase{\leftmark}} % get rid of uppercaseness in headings
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.\ #1}{}}
\fancyfoot{} % no footers

\if@twoside
\fancyhead[RO,LE]{\scshape\leftmark} % chapter name in small caps on the inner side
\fancyhead[RE,LO]{\thepage} % page number on the outer side
\else
\fancyhead[L]{\scshape\leftmark}
\fancyhead[R]{\thepage}
\fi


% All sorts of macros used in the text
\include{macros}


% Document properties
\title{Two-component BEC dynamics simulations}
\author{Bogdan Opanchuk}


% PDF properties
\definecolor{citation}{HTML}{A60000}
\definecolor{link}{HTML}{3515B0}
\usepackage[bookmarks, bookmarkstype=toc, unicode, pdfencoding=auto, backref=page, breaklinks, pdftitle={PhD thesis: Two-component BEC dynamics simulations}, pdfauthor={Bogdan Opanchuk}, colorlinks, urlcolor=blue, citecolor=citation, linkcolor=link]{hyperref}


% Format for back references in bibliography
\renewcommand*{\backref}[1]{}% for backref < 1.33 necessary
\renewcommand*{\backrefalt}[4]{%
\ifcase #1 % No citations.%
\or
[p #2]%
\else
[pp #2]%
\fi }


\begin{document}

\frontmatter

\include{frontmatter}

\tableofcontents

\mainmatter

\include{chapters/introduction}

% theory
\include{chapters/op-calculus}
\include{chapters/wigner}
\include{chapters/wigner-spec}
\include{chapters/wigner-bec}

% applications
\include{chapters/bec-noise}
\include{chapters/bec-squeezing}
\include{chapters/epr-two-well}
\include{chapters/bell-ineq}

\include{chapters/conclusion}

\appendix
\counterwithin{lemma}{chapter}
\counterwithin{theorem}{chapter}
\counterwithin{definition}{chapter}

\include{chapters/c-numbers}
\include{chapters/func-calculus}
\include{chapters/fpe-sde}
\include{chapters/numerical}

% unsorted stuff that may be useful; to be removed the in final version
\include{chapters/notes}

% have to do it explicitly, because otherwise I cannot get rid of uppercaseness
\fancyhead[L]{\scshape Bibliography}

\bibliographystyle{aip}
\bibliography{thesis}

\end{document}
